<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<script type="text/javascript" src="/twiki/pub/TWiki/JQueryPlugin/jquery.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/JQueryPlugin/jquery-migrate.js"></script>
<link rel="stylesheet" href="/twiki/pub/TWiki/JQueryPlugin/jquery-all.css" type="text/css" media="all" />
<script type="text/javascript" src="/twiki/pub/TWiki/JQueryPlugin/jquery-all.js"></script>
<link rel="stylesheet" href="https://twiki.cern.ch/twiki/pub/TWiki/ImagePlugin/style.css" type="text/css" media="all" />
<link rel="stylesheet" href="https://twiki.cern.ch/twiki/pub/TWiki/ImageGalleryPlugin/style.css" type="text/css" media="all" />
<title> AthAnalysisBase &lt; AtlasProtected &lt; TWiki</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<link rel="icon" href="/twiki/pub/AtlasProtected/WebPreferences/favicon_new.ico" type="image/x-icon" />
<link rel="shortcut icon" href="/twiki/pub/AtlasProtected/WebPreferences/favicon_new.ico" type="image/x-icon" />
<link rel="alternate" href="https://twiki.cern.ch/twiki/bin/edit/AtlasProtected/AthAnalysisBase?t=1763376422" type="application/x-wiki" title="Edit AthAnalysisBase" />
<link rel="edit" href="https://twiki.cern.ch/twiki/bin/edit/AtlasProtected/AthAnalysisBase?t=1763376422" title="Edit AthAnalysisBase" />
<meta name="SCRIPTURLPATH" content="/twiki/bin" />
<meta name="SCRIPTSUFFIX" content="" />
<meta name="TEXT_JUMP" content="Jump" />
<meta name="TEXT_SEARCH" content="Search" />
<meta name="TEXT_NUM_TOPICS" content="Number of topics:" />
<meta name="TEXT_MODIFY_SEARCH" content="Modify search" />
<link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/twiki/bin/view/AtlasProtected/WebRss" />
<base href="https://twiki.cern.ch/twiki/bin/view/AtlasProtected/AthAnalysisBase"></base>
<!--BEHAVIOURCONTRIB--><script type="text/javascript" src="/twiki/pub/TWiki/BehaviourContrib/behaviour.compressed.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikilib.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiWindow.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiEvent.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiHTML.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiCSS.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiForm.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/PatternSkin/pattern.js"></script>
<style type="text/css" media="all">
@import url('/twiki/pub/TWiki/TWikiTemplates/base.css');
</style>
<style type="text/css" media="all">
#patternTopBar,
#patternClearHeaderCenter,
#patternClearHeaderLeft,
#patternClearHeaderRight,
#patternTopBarContentsOuter,
#patternTopBarContents {
	height:64px; /* top bar height; make room for header columns */
	overflow:hidden;
}
#patternOuter {
	margin-left:14em;
}
#patternLeftBar {
	width:14em;
	margin-left:-14em;
}
</style>
<style type="text/css" media="all">
@import url('/twiki/pub/TWiki/PatternSkin/layout.css');
@import url('/twiki/pub/TWiki/PatternSkin/style.css');
@import url('/twiki/pub/TWiki/PatternSkin/colors.css');
</style>
<style type="text/css" media="all">
	/* Styles that are set using variables */
	.patternBookView .twikiTopRow,
	.patternWebIndicator a img,
	.patternWebIndicator a:hover img {
		background-color:#0b048c ;
	}
	#patternTopBarContents { background-image:url(/twiki/pub/TWiki/PatternSkin/TWiki_header.gif); background-repeat:no-repeat;}
	
	.patternBookView {
		border-color:#0b048c ;
	}
	.patternPreviewPage #patternMain {
		/* uncomment to set the preview image */
		/*background-image:url("/twiki/pub/TWiki/PreviewBackground/preview2bg.gif");*/
	}
	
</style><style type="text/css" media="all">



</style>
<style type="text/css" media="all">
	@import url("/twiki/pub/TWiki/PatternSkin/print.css");
</style>
<!--[if IE]><style type="text/css" media="screen">
pre {
	overflow-x:auto;
	padding-bottom:expression(this.scrollWidth > this.offsetWidth ? 16 : 0);
}
</style>
<![endif]-->
<!--[if lte IE 6]> 
<style type="text/css">
#patternLeftBar {
	position:relative; /* IE 5.5 needs this or the contents won't show outside the parent container on print. IE 6.0 needs it only during printable copy! */
}
</style><![endif]-->
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiStyles.js"></script>

<script src="https://twiki.cern.ch/twiki/pub/TWiki/ChecklistPlugin/itemstatechange.js" language="javascript" type="text/javascript"></script><!--GENERATED_HEADERS--><!-- TWISTYPLUGIN_TWISTY --> <style type="text/css" media="all">
@import url("https://twiki.cern.ch/twiki/pub/TWiki/TwistyContrib/twist.css");
</style>
<script type='text/javascript' src='https://twiki.cern.ch/twiki/pub/TWiki/BehaviourContrib/behaviour.compressed.js'></script>
<script type="text/javascript" src="https://twiki.cern.ch/twiki/pub/TWiki/TWikiJavascripts/twikilib.js"></script>
<script type="text/javascript" src="https://twiki.cern.ch/twiki/pub/TWiki/TWikiJavascripts/twikiPref.js"></script>
<script type="text/javascript" src="https://twiki.cern.ch/twiki/pub/TWiki/TWikiJavascripts/twikiCSS.js"></script>
<script type="text/javascript" src="https://twiki.cern.ch/twiki/pub/TWiki/TwistyContrib/twist.compressed.js"></script>
<script type="text/javascript">
// <![CDATA[
var styleText = '<style type="text/css" media="all">.twikiMakeVisible{display:inline;}.twikiMakeVisibleInline{display:inline;}.twikiMakeVisibleBlock{display:block;}.twikiMakeHidden{display:none;}</style>';
document.write(styleText);
// ]]>
</script>

<!-- CERNSEARCHBAR_CSS --> <link rel='stylesheet' href='/twiki/pub/TWiki/CernSearchBar/CernSearchBar.css' type='text/css' media='all' />
<!-- TABLEPLUGIN_twikiAttachmentsTable --> <style type="text/css" media="all">
.tableSortIcon img {padding-left:.3em; vertical-align:text-bottom;}
.twikiTable#twikiAttachmentsTable td {border-style:solid none;}
.twikiTable#twikiAttachmentsTable th {border-style:solid none;}
.twikiTable#twikiAttachmentsTable td {vertical-align:middle;}
.twikiTable#twikiAttachmentsTable th {vertical-align:middle;}
.twikiTable#twikiAttachmentsTable td {vertical-align:top;}
.twikiTable#twikiAttachmentsTable th {background-color:#ffffff;}
.twikiTable#twikiAttachmentsTable th.twikiSortedCol {background-color:#eeeeee;}
.twikiTable#twikiAttachmentsTable th {color:#0066cc;}
.twikiTable#twikiAttachmentsTable th a:link {color:#0066cc;}
.twikiTable#twikiAttachmentsTable th a:visited {color:#0066cc;}
.twikiTable#twikiAttachmentsTable th a:link font {color:#0066cc;}
.twikiTable#twikiAttachmentsTable th a:visited font {color:#0066cc;}
.twikiTable#twikiAttachmentsTable th a:hover {color:#ffffff;background-color:#0066cc;}
.twikiTable#twikiAttachmentsTable th a:hover font {color:#ffffff;background-color:#0066cc;}
.twikiTable#twikiAttachmentsTable tr.twikiTableRowdataBg0 td {background-color:#ffffff;}
.twikiTable#twikiAttachmentsTable tr.twikiTableRowdataBg0 td.twikiSortedCol {background-color:#f5f5f5;}
.twikiTable#twikiAttachmentsTable td.twikiTableCol0 {text-align:center;}
.twikiTable#twikiAttachmentsTable td.twikiTableCol1 {text-align:left;}
.twikiTable#twikiAttachmentsTable td.twikiTableCol2 {text-align:left;}
.twikiTable#twikiAttachmentsTable td.twikiTableCol3 {text-align:right;}
.twikiTable#twikiAttachmentsTable td.twikiTableCol4 {text-align:left;}
.twikiTable#twikiAttachmentsTable td.twikiTableCol5 {text-align:left;}
.twikiTable#twikiAttachmentsTable td.twikiTableCol6 {text-align:left;}
.twikiTable#twikiAttachmentsTable td.twikiTableCol7 {text-align:left;}
</style></head>
<body class="patternViewPage">
<a name="PageTop"></a>
<div id="patternScreen">
<div id="patternPageShadow">
<div id="patternPage">
<div id="patternWrapper"><div id="patternOuter">
<div id="patternFloatWrap">
<div id="patternMain"><div id="patternClearHeaderCenter"></div>
<div id="patternMainContents"><div class="patternTop"><span class="patternHomePath twikiLeft"><a class="twikiLink" href="/twiki/bin/view/Main/WebHome">TWiki</a><span class='twikiSeparator'>&gt;</span><img src="/twiki/pub/TWiki/TWikiDocGraphics/web-bg-small.gif" border="0" alt="" width="13" height="13" style="background-color:#0b048c " />&nbsp;<a href="/twiki/bin/view/AtlasProtected/WebHome">AtlasProtected Web</a><span class='twikiSeparator'>&gt;</span><a class="twikiLink" href="/twiki/bin/view/AtlasProtected/AtlasPhysics">AtlasPhysics</a><span class='twikiSeparator'>&gt;</span><a class="twikiLink" href="/twiki/bin/view/AtlasProtected/AnalysisSoftwareGroup">AnalysisSoftwareGroup</a><span class='twikiSeparator'>&gt;</span><a href="https://twiki.cern.ch/twiki/bin/view/AtlasProtected/AthAnalysisBase" title='Topic revision: 202 (2021-03-13 - 03:27:33)'>AthAnalysisBase</a> <span class='patternRevInfo'>(2021-03-13, <span class="twikiNewLink"><a href="/twiki/bin/edit/Main/AndresFelipeMorenoSarria?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">AndresFelipeMorenoSarria</a></span>)</span></span><!-- /patternHomePath--><span class="patternToolBar twikiRight"><span><a href='https://twiki.cern.ch/twiki/bin/edit/AtlasProtected/AthAnalysisBase?t=1763376422;nowysiwyg=1' rel='nofollow' title='Edit this topic text' accesskey='e'><img src='/twiki/pub/TWiki/TWikiDocGraphics/uweb-o14.gif' width='14' height='14' border='0' alt='' /> <span class='twikiAccessKey'>E</span>dit</a></span><span><a href='/twiki/bin/attach/AtlasProtected/AthAnalysisBase' rel='nofollow' title='Attach an image or document to this topic' accesskey='a'><span class='twikiAccessKey'>A</span>ttach</a></span><span><a href='/twiki/bin/genpdf/AtlasProtected/AthAnalysisBase' rel='nofollow' title='Create a PDF file for the topic' accesskey='f'><span class='twikiAccessKey'>P</span>DF</a></span></span><!-- /patternToolBar--><br class="twikiClear" /></div><!--/patternTop--><div class="twikiContentHeader"></div><div class="patternContent"><div class="patternTopic"> <!-- This is the default ATLAS template. 
Please modify it in the sections indicated to create your topic! In particular, notice that at the bottom there are some sections that must be filled for publicly accessible pages.
If you have any comments/complaints about this template, please email the TWiki support: atlas-twiki-support at cern dot ch (currently this is Maria Smizanska (maria dot smizanska at cern dot ch) and Anna Usanova (anna dot usanova at cern dot ch))
<p />
By default the title is the <a class="twikiLink" href="/twiki/bin/view/AtlasProtected/WikiWord">WikiWord</a> used to create this topic
if you want to modify it to something more meaningful, just replace <a class="twikiCurrentTopicLink twikiLink" href="/twiki/bin/view/AtlasProtected/AthAnalysisBase">AthAnalysisBase</a> below with i.e "My Topic"
<code><b>=======</b></code>  you can remove the lines above <code><b>=========================================</b></code> -->
<table align="right" border="0"> <tbody> <tr> <th>Responsible:</th> </tr> <tr> <td align="center">
<a class="twikiLink" href="/twiki/bin/view/Main/WillButtinger">WillButtinger</a></td> </tr> </tbody> </table>
<table><tr><td width=100="top"><img width=100 src="https://twiki.cern.ch/twiki/pub/AtlasProtected/AthAnalysisBase/arr_logo2.png"></td>
<td valign=center>
<font size=4px><br></font>
<h1><a name="The_AthAnalysisBase_HandbookThe"></a> The <a class="twikiCurrentTopicLink twikiLink" href="/twiki/bin/view/AtlasProtected/AthAnalysisBase">AthAnalysisBase</a> Handbook<br><b><font size=-1>&nbsp;The complete reference for fast analysis with athena</font></b> </h1>
</td></tr></table>
<div class="twikiToc"> <ul>
<li> <a href="#Where_to_get_help"> Where to get help</a>
</li> <li> <a href="#News_and_announcements"> News and announcements</a>
</li> <li> <a href="#Setting_things_up"> Setting things up</a> <ul>
<li> <a href="#Recommended_content_of_asetup_fi"> Recommended content of .asetup file</a>
</li> <li> <a href="#How_to_see_what_versions_are_ava"> How to see what versions are available</a>
</li> <li> <a href="#How_to_start_a_new_project_i_e_s"> How to start a new project (i.e. setup a release)</a>
</li> <li> <a href="#How_to_create_a_new_analysis_ske"> How to create a new analysis skeleton, ready for xAOD analysis</a>
</li> <li> <a href="#How_to_create_a_new_package"> How to create a new package</a>
</li> <li> <a href="#How_to_create_a_new_algorithm_in"> How to create a new algorithm inside a package</a>
</li> <li> <a href="#How_to_create_a_new_analysis_alg"> How to create a new analysis algorithm inside a package</a>
</li> <li> <a href="#How_to_create_a_new_python_algor"> How to create a new python algorithm inside a package</a>
</li> <li> <a href="#How_to_create_a_skeleton_jobopti"> How to create a skeleton joboption</a>
</li> <li> <a href="#How_to_create_a_standalone_appli"> How to create a standalone application</a>
</li> <li> <a href="#How_to_checkout_packages"> How to checkout packages</a>
</li> <li> <a href="#How_to_list_all_algorithms_tools"> How to list all algorithms, tools, and services available in the release</a>
</li> <li> <a href="#How_to_clean_your_testarea_when"> How to clean your testarea when switching to a new analysis release</a>
</li> <li> <a href="#How_to_install_AthAnalysisBase_o"> How to install AthAnalysisBase on your laptop</a>
</li></ul> 
</li> <li> <a href="#Compiling_Packages"> Compiling Packages</a> <ul>
<li> <a href="#How_to_compile_a_package"> How to compile a package</a> <ul>
<li> <a href="#How_to_disable_checkreq"> How to disable checkreq</a>
</li></ul> 
</li> <li> <a href="#How_to_compile_every_package_in"> How to compile every package in your testarea</a>
</li> <li> <a href="#How_to_use_ROOT_in_a_package"> How to use ROOT in a package</a>
</li></ul> 
</li> <li> <a href="#Executing_Jobs"> Executing Jobs</a> <ul>
<li> <a href="#How_to_execute_a_joboption_on_a"> How to execute a joboption on a single core</a>
</li> <li> <a href="#How_to_execute_a_joboption_on_mu"> How to execute a joboption on multiple cores</a>
</li> <li> <a href="#How_to_submit_your_job_to_the_gr"> How to submit your job to the grid</a> <ul>
<li> <a href="#Processing_multiple_datasets_in"> Processing multiple datasets in one task with separate outputs</a>
</li> <li> <a href="#Merging_xAOD_format_output_files"> Merging xAOD-format output files</a>
</li></ul> 
</li> <li> <a href="#How_to_submit_your_job_to_condor"> How to submit your job to condor</a>
</li> <li> <a href="#How_to_submit_your_job_to_LXBatc"> How to submit your job to LXBatch</a>
</li></ul> 
</li> <li> <a href="#Writing_Job_Options"> Writing Job Options</a> <ul>
<li> <a href="#How_to_loop_over_an_xAOD"> How to loop over an xAOD</a>
</li> <li> <a href="#How_to_loop_over_a_TTree"> How to loop over a TTree</a>
</li> <li> <a href="#How_to_add_your_algorithm_to_the"> How to add your algorithm to the joboption</a>
</li> <li> <a href="#How_to_loop_over_all_xaod_in_a_f"> How to loop over all xaod in a folder</a>
</li> <li> <a href="#How_to_access_file_metadata_at_t"> How to access file metadata at the joboption level</a>
</li> <li> <a href="#How_to_filter_by_event_number"> How to filter by event number</a>
</li> <li> <a href="#How_to_create_an_output_xAOD"> How to create an output xAOD</a> <ul>
<li> <a href="#Copying_metadata_from_input_to_o"> Copying metadata from input to output files</a>
</li> <li> <a href="#Event_skimming_filtering"> Event skimming/filtering</a>
</li> <li> <a href="#How_to_access_an_existing_stream"> How to access an existing stream</a>
</li></ul> 
</li> <li> <a href="#How_to_take_arguments_from_the_c"> How to take arguments from the command line</a>
</li> <li> <a href="#How_to_change_output_level_of_a"> How to change output level of a configurable just by its name</a>
</li> <li> <a href="#How_to_change_the_format_of_the"> How to change the format of the logging messages</a>
</li> <li> <a href="#How_to_silence_output_from_all_b"> How to silence output from all but one configurable</a>
</li> <li> <a href="#How_to_use_SampleHandler_in_a_jo"> How to use SampleHandler in a joboption (e.g. locating files on eos)</a>
</li></ul> 
</li> <li> <a href="#Usage_examples"> Usage examples</a> <ul>
<li> <a href="#How_to_calibrate_muons"> How to calibrate muons</a>
</li> <li> <a href="#How_to_calibrate_electrons_or_ph"> How to calibrate electrons or photons</a>
</li> <li> <a href="#How_to_calibrate_jets"> How to calibrate jets *</a>
</li> <li> <a href="#How_to_recalculate_MET_using_cal"> How to recalculate MET using calibrated objects</a>
</li> <li> <a href="#How_to_access_file_metadata_in_C"> How to access file metadata in C++</a> <ul>
<li> <a href="#EventStreamInfo_metadata"> EventStreamInfo metadata</a>
</li> <li> <a href="#IOV_specific_metadata"> IOV-specific metadata</a>
</li></ul> 
</li> <li> <a href="#How_to_create_new_metadata_and_o"> How to create new metadata and output it to a file</a>
</li> <li> <a href="#How_to_access_EventBookkeeper_in"> How to access EventBookkeeper information in c++ (sum of event weights prior to skimming)</a>
</li> <li> <a href="#How_to_print_the_sum_of_weights"> How to print the sum of weights for local files</a>
</li> <li> <a href="#How_to_use_the_TrigDecisionTool"> How to use the TrigDecisionTool</a>
</li> <li> <a href="#How_to_thin_an_output_container"> How to thin an output container</a>
</li> <li> <a href="#How_to_get_the_provenance_of_an"> How to get the provenance of an event</a>
</li> <li> <a href="#How_to_output_trees_and_histogra"> How to output trees and histograms</a> <ul>
<li> <a href="#Outputting_trees_and_histograms"> Outputting trees and histograms using AthHistogramming</a>
</li></ul> 
</li> <li> <a href="#How_to_configure_a_tool_set_prop"> How to configure a tool (set properties) from C++</a>
</li> <li> <a href="#How_to_instantiate_an_AsgTool_us"> How to instantiate an AsgTool using the factory methods</a>
</li> <li> <a href="#How_to_filter_by_GRL"> How to filter by GRL</a>
</li> <li> <a href="#How_to_ask_for_the_total_number"> How to ask for the total number of events being processed in a job</a>
</li> <li> <a href="#How_to_use_MCTruthClassifier"> How to use MCTruthClassifier</a>
</li> <li> <a href="#How_to_read_EVNT_files_with_AthA"> How to read EVNT files with AthAnalysisBase</a>
</li> <li> <a href="#How_to_read_HepMC_files_with_Ath"> How to read HepMC files with AthAnalysisBase</a>
</li> <li> <a href="#How_to_get_the_bunch_train_posit"> How to get the bunch train position of an event (using the TrigBunchCrossingTool)</a>
</li> <li> <a href="#How_to_read_two_files_concurrent"> How to read two files concurrently in AthAnalysisBase</a>
</li> <li> <a href="#How_to_check_the_luminosity_cove"> How to check the luminosity covered by a collection of data xAOD (i.e. Luminosity bookkeeping)</a>
</li> <li> <a href="#How_to_read_a_folder_from_the_co"> How to read a folder from the conditions database</a>
</li> <li> <a href="#How_to_read_the_truth_weight_nam"> How to read the truth weight names from non-xAOD metadata</a>
</li> <li> <a href="#How_to_catch_all_ROOT_errors_and"> How to catch all ROOT errors and ensure they stop event processing</a>
</li></ul> 
</li> <li> <a href="#Testing_and_Debugging"> Testing and Debugging</a> <ul>
<li> <a href="#How_to_check_contents_of_an_xAOD"> How to check contents of an xAOD</a>
</li> <li> <a href="#How_to_check_size_disk_usage_of"> How to check size (disk usage) of xAOD containers in a file</a>
</li> <li> <a href="#How_to_add_processing_time_stati"> How to add processing time statistics to your job</a> <ul>
<li> <a href="#Time_spent_in_each_algorithm"> Time spent in each algorithm</a>
</li> <li> <a href="#Time_spent_in_functions_of_algor"> Time spent in functions of algorithms or tools</a>
</li> <li> <a href="#Time_spent_in_I_O_POOL"> Time spent in I/O (POOL)</a>
</li></ul> 
</li> <li> <a href="#How_to_assess_performance_using"> How to assess performance using built-in monitoring</a>
</li> <li> <a href="#How_to_assess_performance_us_AN1"> How to assess performance using GPerfTools CPUProfiler</a>
</li> <li> <a href="#How_to_debug_an_exception_with_G"> How to debug an exception with GDB</a>
</li> <li> <a href="#How_to_debug_an_abort_with_gdb"> How to debug an abort with gdb</a>
</li> <li> <a href="#How_to_investigate_a_potential_m"> How to investigate a potential memory leak</a> <ul>
<li> <a href="#Using_Hephaestus"> Using Hephaestus</a>
</li> <li> <a href="#Using_Performance_Monitoring_pmo"> Using Performance Monitoring (pmon)</a>
</li> <li> <a href="#Using_Valgrind"> Using Valgrind</a>
</li></ul> 
</li> <li> <a href="#How_to_recompile_an_entire_night"> How to recompile an entire nightly</a>
</li> <li> <a href="#How_to_protect_yourself_from_ROO"> How to protect yourself from ROOT-based errors</a>
</li></ul> 
</li> <li> <a href="#Standalone_executables_processin"> Standalone executables (processing events outside of athena)</a> <ul>
<li> <a href="#How_to_use_POOL_TEvent"> How to use POOL::TEvent</a>
</li> <li> <a href="#How_to_execute_an_algorithm_with"> How to execute an algorithm with POOL::TEvent</a>
</li> <li> <a href="#How_to_inspect_files_in_pyROOT"> How to inspect files in pyROOT</a>
</li> <li> <a href="#How_to_create_tools_on_the_ROOT"> How to create tools on the ROOT prompt</a>
</li> <li> <a href="#How_to_use_x_AODRootAccess_xAOD"> How to use xAODRootAccess (xAOD::TEvent) from the interactive prompt</a>
</li> <li> <a href="#How_to_write_your_own_athena_app"> How to write your own athena application or ROOT Macro</a>
</li></ul> 
</li> <li> <a href="#PyROOT_in_AthAnalysisBase"> PyROOT in AthAnalysisBase</a> <ul>
<li> <a href="#Looping_over_xAOD_with_PyROOT_no"> Looping over xAOD with PyROOT (no athena)</a>
</li> <li> <a href="#Looping_over_xAOD_with_PyROOT_in"> Looping over xAOD with PyROOT in interactive athena</a>
</li></ul> 
</li> <li> <a href="#Advanced_usage"> Advanced usage</a> <ul>
<li> <a href="#How_to_use_public_and_private_To"> How to use public and private ToolHandles</a>
</li> <li> <a href="#How_to_add_a_new_asg_tool_to_you"> How to add a new asg tool to your package</a>
</li> <li> <a href="#How_to_add_an_atn_athena_test_fo"> How to add an atn athena test for cmt releases</a>
</li> <li> <a href="#How_to_add_an_atn_standalone_app"> How to add an atn standalone application test for cmt releases</a>
</li> <li> <a href="#How_to_execute_atn_tests_locally"> How to execute atn tests locally</a>
</li> <li> <a href="#How_to_use_AnaToolHandle"> How to use AnaToolHandle</a> <ul>
<li> <a href="#A_Note_for_RootCore_users"> A Note for RootCore users</a>
</li></ul> 
</li></ul> 
</li> <li> <a href="#Known_Issues"> Known Issues</a>
</li></ul> 
</div> <!-- this line is optional -->
<p />
<p />
<p />
<h1><a name="Where_to_get_help"></a> Where to get help </h1>
If you have difficulty with any of what is described below, please email: <a href="mailto&#58;hn&#45;atlas&#45;PATHelp&#64;cern&#46;ch">hn-atlas-PATHelp&#64;cern.ch</a>
<p />
<h1><a name="News_and_announcements"></a> News and announcements </h1>
<b>AVOID LXPLUS IF POSSIBLE:</b> the cmt compilation/build system seems to be particularly affected by running on lxplus. You can easily encounter compilation times that are more than 10 times slower on lxplus than they would be on a local institute machine. <b>PLEASE USE YOUR LOCAL INSTITUTE MACHINES</b> if you can. There are <a class="twikiCurrentTopicLink twikiAnchorLink" href="/twiki/bin/view/AtlasProtected/AthAnalysisBase#LocalInstall">instructions for installing a release on a local desktop machine</a> ... but if you must use lxplus, please note that things seem to work faster with the <b>bash shell</b>.
<p />
<a name="SetupAtlasDev"></a>
<b>14-01-2016</b> : Previously to access some additional special cmt actions you needed to setup the ATLAS software environment using:
<pre>
setupATLAS --test&#61;cmtSL6-dev
</pre>
This functionality has now been included in the production release, so you now have full access to these actions simply by using the standard command:
<pre>
setupATLAS
</pre> 
<p />
When I work with the bash shell, I tend to put the following into my <code>~/.bash_login</code> file, so that as soon as I type <code>bash</code> I will be ready to setup ATLAS software:
<p />
<pre>
export ATLAS&#95;LOCAL&#95;ROOT&#95;BASE&#61;/cvmfs/atlas.cern.ch/repo/ATLASLocalRootBase
source ${ATLAS&#95;LOCAL&#95;ROOT&#95;BASE}/user/atlasLocalSetup.sh
</pre>
<p />
<p />
You can see what cmt actions are available (after setting up a release) with:
<pre>
cmt show actions
</pre>
You will find examples of these in the rest of this twiki.
<p />
<h1><a name="Setting_things_up"></a> Setting things up </h1>
<p />
<h2><a name="Recommended_content_of_asetup_fi"></a> Recommended content of .asetup file </h2>
The recommended content of your <code>.asetup</code> file, which resides in your <code>$HOME</code> directory, should be the following:
<p />
<pre>
&#91;defaults]
autorestore &#61; True
briefprint &#61; True
</pre>
<p />
<p />
<h2><a name="How_to_see_what_versions_are_ava"></a> How to see what versions are available </h2>
<pre>
showVersions athena &#124; grep AnalysisBase
</pre>
<p />
To narrow this down to versions in a particular release series, and also list them in the correct numeric order (most recent at bottom), do:
<p />
<pre>
showVersions athena &#124; grep AnalysisBase-2.4 &#124; sort -nk3 -t.
</pre>
<p />
To check which release series (e.g. 2.3 or 2.4) you should be using, please look at <a href="https://twiki.cern.ch/twiki/bin/view/AtlasProtected/AnalysisRelease" target="_top">AnalysisRelease twiki page</a>.
<p />
<h2><a name="How_to_start_a_new_project_i_e_s"></a> How to start a new project (i.e. setup a release) </h2>
<pre>
mkdir MyAnalysisProject; cd MyAnalysisProject
asetup AthAnalysisBase,2.3.34,here
</pre>
<p />
<p />
<p />
<h2><a name="How_to_create_a_new_analysis_ske"></a> How to create a new analysis skeleton, ready for xAOD analysis </h2>
<pre>
cmt new&#95;skeleton MyPackage
</pre>
This will give you a package called <code>MyPackage</code>, which an <a class="twikiCurrentTopicLink twikiAnchorLink" href="/twiki/bin/view/AtlasProtected/AthAnalysisBase#CreateAnalysisAlg">AthAnalysisAlgorithm</a> in it called <code>MyPackageAlg</code> (in the <code>src</code> directory), and a joboption to run it called <code>MyPackageAlgJobOptions.py</code> (in the <code>share</code> directory). You should put your xAOD analysis code in the <code>execute</code> method of the <code>src/MyPackageAlg.cxx</code> file, and then you can <a class="twikiCurrentTopicLink twikiAnchorLink" href="/twiki/bin/view/AtlasProtected/AthAnalysisBase#CompilePackage">compile your package</a> and run your code with <code>athena <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/MyPackage?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">MyPackage</a></span>/MyPackageAlgJobOptions.py</code>.
<p />
This command is basically the equivalent of the following (see the individual commands below):
<pre>
cmt new&#95;pkg MyPackage
cd MyPackage
cmt new&#95;analysisalg MyPackageAlg
cd share
cmt new&#95;jobo MyPackageAlgJobOptions MyPackageAlg
</pre>
<p />
<p />
<h2><a name="How_to_create_a_new_package"></a> How to create a new package </h2>
<pre>
cmt new&#95;pkg MyPackage
</pre>
<p />
<h2><a name="How_to_create_a_new_algorithm_in"></a> How to create a new algorithm inside a package </h2>
<pre>
cd MyPackage
cmt new&#95;alg MyAlg
</pre>
<p />
<h2><a name="How_to_create_a_new_analysis_alg"></a> How to create a new analysis algorithm inside a package </h2>
<a name="CreateAnalysisAlg"></a>
The AthAnalysisAlgorithm is virtually the same as AthAlgorithm except it includes extra methods, e.g. a <code>beginInputFile</code> method that executes when new files open, and includes a helpful <code>retrieveMetadata</code> method that can be used to retrieve metadata. See <a class="twikiCurrentTopicLink twikiAnchorLink" href="/twiki/bin/view/AtlasProtected/AthAnalysisBase#ReadingMetaDataInCpp">AthAnalysisBase#ReadingMetaDataInCpp</a>
<pre>
cd MyPackage
cmt new&#95;analysisalg MyAlg
</pre>
<p />
The methods of AthAnalysisAlgorithm are called in the following order:
<p />
<table border="1" cellpadding="0" cellspacing="0" class="twikiTable" id="table1" rules="all">
<tr class="twikiTableOdd twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
<th bgcolor="#687684" class="twikiTableCol0 twikiFirstCol" valign="top"> <a href="/twiki/bin/view/AtlasProtected/AthAnalysisBase?sortcol=0;table=1;up=0#sorted_table" rel="nofollow" title="Sort by this column"><font color="#ffffff">Method</font></a> </th>
<th bgcolor="#687684" class="twikiTableCol1 twikiLastCol" valign="top"> <a href="/twiki/bin/view/AtlasProtected/AthAnalysisBase?sortcol=1;table=1;up=0#sorted_table" rel="nofollow" title="Sort by this column"><font color="#ffffff">Called when</font></a> </th>
</tr>
<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
<td bgcolor="#ffffff" class="twikiTableCol0 twikiFirstCol" valign="top"> initialize </td>
<td bgcolor="#ffffff" class="twikiTableCol1 twikiLastCol" valign="top"> Before Event and Metadata payload is loaded </td>
</tr>
<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
<td bgcolor="#edf4f9" class="twikiTableCol0 twikiFirstCol" valign="top"> beginInputFile </td>
<td bgcolor="#edf4f9" class="twikiTableCol1 twikiLastCol" valign="top"> Called when Metadata payload is loaded, but before Event payload. Called at start of each file </td>
</tr>
<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
<td bgcolor="#ffffff" class="twikiTableCol0 twikiFirstCol" valign="top"> firstEvent </td>
<td bgcolor="#ffffff" class="twikiTableCol1 twikiLastCol" valign="top"> Called when first Event payload is loaded (not called again, even if more files loaded) </td>
</tr>
<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
<td bgcolor="#edf4f9" class="twikiTableCol0 twikiFirstCol" valign="top"> execute </td>
<td bgcolor="#edf4f9" class="twikiTableCol1 twikiLastCol" valign="top"> Called once per Event payload load </td>
</tr>
<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
<td bgcolor="#ffffff" class="twikiTableCol0 twikiFirstCol twikiLast" valign="top"> finalize </td>
<td bgcolor="#ffffff" class="twikiTableCol1 twikiLastCol twikiLast" valign="top"> Called at end of the eventloop, after metadata nd event payloads have been completed </td>
</tr></table>
<p />
<h2><a name="How_to_create_a_new_python_algor"></a> How to create a new python algorithm inside a package </h2>
Python algorithms are great for quick debugging tests and plotting
<pre>
cd MyPackage
acmd.py cmt new-pyalg MyPyAlg
</pre>
Creates a file called <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/MyPyAlg?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">MyPyAlg</a></span>.py in the python folder. You can modify the content of the <code>execute</code> method to do pythonic things with the event data. E.g. 
<pre>
for electron in self.evtStore&#91;&#34;Electrons&#34;]: print electron.pt()
</pre>
loops over the electrons and prints the pt of each.
<p />
<h2><a name="How_to_create_a_skeleton_jobopti"></a> How to create a skeleton joboption </h2>
<pre>
cmt new&#95;jobo myJobOptions MyAlg --inFile&#61;my.file.root
</pre>
This creates a skeleton joboption (called <code>myJobOptions.py</code>) to run an alg called <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/MyAlg?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">MyAlg</a></span> over a file called my.file.root. The --inFile is optional, but then you'll need to go into the joboption and specify your input file(s) manually.
<p />
<h2><a name="How_to_create_a_standalone_appli"></a> How to create a standalone application </h2>
You may want to write a quick/small test application that reads an xAOD, without invoking the full athena framework. To do this, you can use the POOL::TEvent class to read xAOD. To create an example application, inside a cmt package do:
<p />
<pre>
cmt new&#95;analysisapp MyApp
</pre>
<p />
Once you compile the package you can run your application with <code>MyApp.exe</code>
The skeleton program is set up to receive a test inputfile as its argument. 
<p />
See <a href="https://twiki.cern.ch/twiki/bin/view/AtlasProtected/AthAnalysisBase#Standalone_executables_processin" target="_top">the standalone executable section</a> of this twiki for more info on using POOL::TEvent
<p />
<h2><a name="How_to_checkout_packages"></a> How to checkout packages </h2>
Check out package from release (same version as in release): <b>cmt checkout_pkg NameOfPackage</b><br>
Check out specific version of package: <b>cmt checkout_pkg NameOfPackage-00-12-34</b></br>
Check out trunk version: <b>cmt checkout_pkg -A NameOfPackage</b><br>
Show version of package: <b>cmt checkout_pkg -s NameOfPackage</b><br> or <b>cmt show versions Path/To/NameOfPackage</b>
Check out package not in the release (e.g. version 00-00-01): <b>cmt co -r NameOfPackage-00-00-01 Path/To/NamePackage</b><br>
<p />
<h2><a name="How_to_list_all_algorithms_tools"></a> How to list all algorithms, tools, and services available in the release </h2>
I have written a script that prints out this information (excludes any configurables present in the Gaudi packages) that you can execute like this:
<p />
<pre>
python /afs/cern.ch/work/w/will/public/showConfigurables.py
</pre>
<p />
<h2><a name="How_to_clean_your_testarea_when"></a> How to clean your testarea when switching to a new analysis release </h2>
You should recompile all your locally checked out packages when you switch to a new release. Do it like this (after setting up the new release):
<pre>
cmt find&#95;packages
cmt compile binclean
cmt compile
</pre>
If you still encounter any weird behavour, email the pat help mailing list.
<p />
<a name="LocalInstall"></a>
<h2><a name="How_to_install_AthAnalysisBase_o"></a> How to install <a class="twikiCurrentTopicLink twikiLink" href="/twiki/bin/view/AtlasProtected/AthAnalysisBase">AthAnalysisBase</a> on your laptop </h2>
If your laptop (or local machine) is using SLC6 or SL6 (some other linux versions may also be ok), you can install a release with the instructions below (all from bash). If you re on a different operating system, you can install a virtual machine and then follow the instructions.
<p />
Installing any release requires two things: the compiler, and the release.
<p />
The example below installs the <code>AthAnalysisBase</code> release version <code>2.3.43</code> with the gcc compiler version <code>4.9.3</code>
<p />
<pre>
ROOTDIR&#61;/Where/To/Install
cd $ROOTDIR
svn co svn+ssh://svn.cern.ch/reps/atlasoff/CMTUSERCONTEXT/trunk CMTUSERCONTEXT
wget -q --no-check-certificate https://pc-ads-01.roma1.infn.it/KV/sw-mgr
chmod +x ./sw-mgr
./sw-mgr -a gcc-x86&#95;64:4.9.3 -i  4.9.3 -n -o --no-tag -p $ROOTDIR/atlas-gcc/493/x86&#95;64 --site-config $ROOTDIR/AtlasSiteConfig.sh
./sw-mgr -a AthAnalysisBase:2.3.43 -i 2.3.43 -p $ROOTDIR -T release --site-config $ROOTDIR/AtlasSiteConfig.sh --no-tag --relative-links

export CMTUSERCONTEXT&#61;$ROOTDIR/CMTUSERCONTEXT
export AtlasSetup&#61;$ROOTDIR/AtlasSetup
alias asetup&#61;&#39;source $AtlasSetup/scripts/asetup.sh&#39;
</pre>
<p />
The last 3 lines should be put into your shell login script. 
<p />
<div class="twistyPlugin twikiMakeVisibleInline">  <span id="twistyIdAtlasProtectedAthAnalysisBase1show" class="twistyStartHide twistyTrigger twikiUnvisited twistyInited0"><a href="#"><span class="twikiLinkLabel twikiUnvisited">Click here to reveal more details/alternative installation method</span><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" border="0" alt="" /></a> </span> <span id="twistyIdAtlasProtectedAthAnalysisBase1hide" class="twistyStartHide twistyTrigger twikiUnvisited twistyHidden twistyInited0"><a href="#"><span class="twikiLinkLabel twikiUnvisited">Hide</span></a> </span>  </div><!--/twistyPlugin twikiMakeVisibleInline--> <div class="twistyPlugin"><div id="twistyIdAtlasProtectedAthAnalysisBase1toggle" class="twistyStartHide twistyContent twikiMakeHidden twistyInited0">
1. Create a directory where the installations will be made
<pre>
mkdir KitInstalls
</pre>
<p />
2. Install the gcc compiler that ATLAS uses (this only needs to be done once for each new version of the compiler we use for the analysis releases):
<pre>
source /afs/cern.ch/atlas/software/pacman/pacman-latest/setup.sh 
pacman -allow any-platform trust-all-caches tar-overwrite -get KV:gcc-alt/gcc&#95;4&#95;9&#95;3&#95;x86&#95;64&#95;slc6&#95;gcc49&#95;opt
</pre>
<p />
3. checkout the CMTUSERCONTEXT (this provide the cmt commands like cmt find_packages) that were provided on top of athena (this only needs to be done once, and can be updated occasionally as new commands are added):
<pre>
svn co svn+ssh://svn.cern.ch/reps/atlasoff/CMTUSERCONTEXT/trunk CMTUSERCONTEXT
</pre>
<p />
4. Now download a release from: <a href="http://atlas-computing.web.cern.ch/atlas-computing/links/pacballs/" target="_blank">http://atlas-computing.web.cern.ch/atlas-computing/links/pacballs/<img alt="" border="0" height="12" src="/twiki/pub/TWiki/TWikiDocGraphics/external-link.gif" width="13" /></a> , copy it to your <code>KitInstalls</code> directory, and source the script, e.g.:
<pre>
source AthAnalysisBase&#95;2&#95;3&#95;42&#95;x86&#95;64&#95;slc6&#95;gcc49&#95;opt.time-2016-01-28-20-49-44.md5-e901c69677b6e2cebbccdd1e80b935e5.sh
</pre>
(If it says you cant source it, you might need to <code>chmod +x</code> the file and then run it just with: <code>./AthAnalysisBase_...</code> 
<p />
5. Assuming the installation seemed to run ok, you can now setup the release after doing (put the following in, e.g. your bash login script):
<pre>
export CMTUSERCONTEXT&#61;/Path/To/KitInstalls/CMTUSERCONTEXT
export AtlasSetup&#61;/Path/To/KitInstalls/AtlasSetup
alias asetup&#61;&#39;source $AtlasSetup/scripts/asetup.sh&#39;
</pre>
<p />
</div></div> <!--/twistyPlugin-->
<p />
For users of other operating systems (e.g. mac os), it is not yet possible to truly install the release on your laptop (it will hopefully become true in the future), but it is very possible, and in many ways more convenient, to use the release from inside a virtual machine (VM) running on your laptop. You can set this up to let you create and edit files from within your native operating system (via a 'shared folder'), but you would compile and run your code from a terminal that is logged in to your VM. 
<p />
An excellent set of instructions for setting up the VM on a laptop (specifically a mac) is given <a href="https://twiki.cern.ch/twiki/bin/view/Main/KarstenKoeneke?forceShow=1#Running_on_your_laptop_using_a_v" target="_top">here</a>. 
<p />
Once you have the VM set up, you should be able to setup the releases over cvmfs through the VM, or you could run the above instructions for actually installing a release, which will guarantee full offline functionality (rather than relying on what cvmfs has cached).
<p />
<p />
<p />
<h1><a name="Compiling_Packages"></a> Compiling Packages </h1>
<a name="CompilePackage"></a>
<h2><a name="How_to_compile_a_package"></a> How to compile a package </h2>
using the new cmt actions (you will need to have called <code>cmt find_packages</code> at least once while the package existed):
<pre>
cmt compile&#95;pkg MyPackage
</pre>
OR, using the old-fashioned way of going to the package and calling make:
<pre>
cd MyPackage/cmt
make
</pre>
If you don't want to have to cd into the package's cmt directory (e.g. you are busy working in the run directory) you can do:
<pre>
make -C $TestArea/MyPackage/cmt
</pre>
<p />
<h3><a name="How_to_disable_checkreq"></a> How to disable checkreq </h3>
While it is generally a good idea to leave checkreq on for your compilations, sometimes it can get annoying and give you lots of warnings. Click the link below to find out how to disable checkreq (only appropriate for private analysis code and if you don't know another way out):
<div class="twistyPlugin twikiMakeVisibleInline">  <span id="twistyIdAtlasProtectedAthAnalysisBase2show" class="twistyStartHide twistyTrigger twikiUnvisited twistyInited0"><a href="#"><span class="twikiLinkLabel twikiUnvisited">How to disable checkreq</span><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" border="0" alt="" /></a> </span> <span id="twistyIdAtlasProtectedAthAnalysisBase2hide" class="twistyStartHide twistyTrigger twikiUnvisited twistyHidden twistyInited0"><a href="#"><span class="twikiLinkLabel twikiUnvisited">Hide</span></a> </span>  </div><!--/twistyPlugin twikiMakeVisibleInline--> <div class="twistyPlugin"><div id="twistyIdAtlasProtectedAthAnalysisBase2toggle" class="twistyStartHide twistyContent twikiMakeHidden twistyInited0">
If checkreq is stopping you compiling code that is actually perfectly ok to the compiler (can happen, especially with preprocessor flags protecting parts of the code), you can disable checkreq by adding the following line to your requirements file:
<br> action checkreq " echo 'disabling checkreq!!' "
</div></div> <!--/twistyPlugin-->
<p />
<h2><a name="How_to_compile_every_package_in"></a> How to compile every package in your testarea </h2>
<pre>
cmt find&#95;packages
cmt compile
</pre>
OR (equivalent, old fashioned way):
<pre>
cd $TestArea
setupWorkArea.py
cd WorkArea/cmt
cmt bro &#34;cmt config;cmt make&#34;
</pre>
<p />
<h2><a name="How_to_use_ROOT_in_a_package"></a> How to use ROOT in a package </h2>
Add the following use statement to your package's requirements file:
<pre style="background: #e0ebf6;">
use AtlasROOT AtlasROOT-&#42; External
</pre>
For using root objects from the non-core libraries, you'll need to add a few extra lines.. click the link below to reveal the details:<br>
<div class="twistyPlugin twikiMakeVisibleInline">  <span id="twistyIdAtlasProtectedAthAnalysisBase3show" class="twistyStartHide twistyTrigger twikiUnvisited twistyInited0"><a href="#"><span class="twikiLinkLabel twikiUnvisited">Adding extra ROOT libraries</span><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" border="0" alt="" /></a> </span> <span id="twistyIdAtlasProtectedAthAnalysisBase3hide" class="twistyStartHide twistyTrigger twikiUnvisited twistyHidden twistyInited0"><a href="#"><span class="twikiLinkLabel twikiUnvisited">Hide</span><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleclose-small.gif" border="0" alt="" /></a> </span>  </div><!--/twistyPlugin twikiMakeVisibleInline--> <div class="twistyPlugin"><div id="twistyIdAtlasProtectedAthAnalysisBase3toggle" class="twikiHelp twistyStartHide twistyContent twikiMakeHidden twistyInited0">
when you do:
<p />
<pre>use AtlasROOT AtlasROOT-* External</pre>
<p />
in your requirements file, you are only being given the basic (core) root libaries. The root libraries are all listed under <code>$ROOTSYS/lib</code>. If you try to use <a class="twikiLink" href="/twiki/bin/view/AtlasProtected/TLorentzVector">TLorentzVector</a>, that is part of the "Physics" library (see top of page of <a href="https://root.cern.ch/root/html604/TLorentzVector.html" target="_blank">https://root.cern.ch/root/html604/TLorentzVector.html<img alt="" border="0" height="12" src="/twiki/pub/TWiki/TWikiDocGraphics/external-link.gif" width="13" /></a> - ROOT &gt;&gt; MATH &gt;&gt; PHYSICS). So if cmt is complaining that it can't find a certain ROOT class having an <code>undefined reference</code>, check on the ROOT pages which library it belongs to (at the top of the page, the last name before the class name should be the library name). Then, you add the following line to your requirements file (looked up from <a href="http://acode-browser.usatlas.bnl.gov/lxr/source/atlas/External/AtlasROOT/cmt/requirements" target="_blank">here<img alt="" border="0" height="12" src="/twiki/pub/TWiki/TWikiDocGraphics/external-link.gif" width="13" /></a>) :
<p />
<table border="1" cellpadding="0" cellspacing="0" class="twikiTable" id="table2" rules="all">
<tr class="twikiTableOdd twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
<td bgcolor="#ffffff" class="twikiTableCol0 twikiFirstCol" valign="top"> Library </td>
<td bgcolor="#ffffff" class="twikiTableCol1 twikiLastCol" valign="top"> requirements code </td>
</tr>
<tr class="twikiTableEven twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
<td bgcolor="#edf4f9" class="twikiTableCol0 twikiFirstCol" valign="top"> Core,Cint,Tree,pthread,MathCore,Hist </td>
<td bgcolor="#edf4f9" class="twikiTableCol1 twikiLastCol" valign="top"> <code>apply_tag <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/ROOTBasicLibs?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">ROOTBasicLibs</a></span></code> </td>
</tr>
<tr class="twikiTableOdd twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
<td bgcolor="#ffffff" class="twikiTableCol0 twikiFirstCol" valign="top"> RFIO </td>
<td bgcolor="#ffffff" class="twikiTableCol1 twikiLastCol" valign="top"> <code>apply_tag ROOTRFIOLibs</code> </td>
</tr>
<tr class="twikiTableEven twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
<td bgcolor="#edf4f9" class="twikiTableCol0 twikiFirstCol" valign="top"> <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/MathMore?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">MathMore</a></span>,Minuit,Minuit2,Matrix,Physics,HistPainter,Rint </td>
<td bgcolor="#edf4f9" class="twikiTableCol1 twikiLastCol" valign="top"> <code>apply_tag <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/ROOTMathLibs?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">ROOTMathLibs</a></span></code> </td>
</tr>
<tr class="twikiTableOdd twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
<td bgcolor="#ffffff" class="twikiTableCol0 twikiFirstCol" valign="top"> Graf,Graf3d,Gpad,Html,Postscript,Gui,GX11TFF,GX11 </td>
<td bgcolor="#ffffff" class="twikiTableCol1 twikiLastCol" valign="top"> <code>apply_tag <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/ROOTGraphicsLibs?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">ROOTGraphicsLibs</a></span></code> </td>
</tr>
<tr class="twikiTableEven twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
<td bgcolor="#edf4f9" class="twikiTableCol0 twikiFirstCol" valign="top"> Table </td>
<td bgcolor="#edf4f9" class="twikiTableCol1 twikiLastCol" valign="top"> <code>apply_tag <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/ROOTTableLibs?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">ROOTTableLibs</a></span></code> </td>
</tr>
<tr class="twikiTableOdd twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
<td bgcolor="#ffffff" class="twikiTableCol0 twikiFirstCol twikiLast" valign="top"> <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/RooFitCore?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">RooFitCore</a></span>,RooFit </td>
<td bgcolor="#ffffff" class="twikiTableCol1 twikiLastCol twikiLast" valign="top"> <code>apply_tag <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/ROOTRooFitLibs?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">ROOTRooFitLibs</a></span></code> </td>
</tr></table>
<p />
For any other libraries, you must add the following line instead:
<p />
<pre>macro_append NAMEOFPACKAGE_shlibflags " -lNameOfRootLibrary -lAnotherNameOfRootLibrary "</pre>
<p />
e.g. for my package "MyPackage", if I want to use the Proof library I can do:
<p />
<pre>macro_append MyPackage_shlibflags " -lProof "</pre>
<p />
Note: If you are compiling a dual_use library, you need to use <code>MyPackageLib_shlibflags</code> instead. And you can't use <code>_linkopts</code> in a dual_use library (the pattern doesn't make use of this macro... you have to use shlibflags)
<p />
The following should also work (simpler but not checkreq 'safe'):
<p />
<pre>macro_append ROOT_linkopts " -lProof"</pre>
</div></div> <!--/twistyPlugin-->
<p />
<h1><a name="Executing_Jobs"></a> Executing Jobs </h1>
<p />
<h2><a name="How_to_execute_a_joboption_on_a"></a> How to execute a joboption on a single core </h2>
<pre>
athena myJobOptions.py
</pre>
If your joboption is inside a <code>share</code> directory of a package (and the package was recompiled at least once since the file was added, so that the joboption was picked up by the testarea), you can do (from anywhere, e.g. from inside a <code>run</code> directory):
<pre>
athena MyPackage/myJobOptions.py
</pre>
<p />
<h2><a name="How_to_execute_a_joboption_on_mu"></a> How to execute a joboption on multiple cores </h2>
<pre>
athena --nprocs&#61;5 myJobOptions.py 
</pre>
This runs on 5 cores. The output of each worker is kepts in the athenamp_workers subdirectory, and an xml file (AthenaMPOutputs) is created to tell you where all the files are. Only files created via e.g. the histSvc or the output stream appear in this xml report. You will also see output files appear in your working directory but they will be empty (we are considering providing automatic merging into those files.. please email us if interested). See <a href="https://twiki.cern.ch/twiki/bin/view/AtlasComputing/AthenaMP#Configuration_options" target="_top">https://twiki.cern.ch/twiki/bin/view/AtlasComputing/AthenaMP#Configuration_options</a> for more configuration options (you put them in your joboptions)
<p />
<h2><a name="How_to_submit_your_job_to_the_gr"></a> How to submit your job to the grid </h2>
<pre>
lsetup panda
pathena myJobOptions.py --inDS&#61;&#34;input.data.set/&#34; --outDS&#61;&#34;output.data.set/&#34;
</pre>
<p />
On the grid, two things will be automatically be set in your joboptions (and any attempt by you to overwrite these values in your joboptions will be ignored):
<p />
<pre>
theApp.EvtMax &#61; -1
jps.AthenaCommonFlags.FilesInput &#61; &#91;The, List, Of, Input, Files]
</pre>
<p />
(technically the <code>InputCollections</code> property of the <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/EventSelector?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">EventSelector</a></span> will also be set for you, but this can be overwritten by your joboptions (it is not locked like the properties above))
<p />
For this reason, it is important that throughout your joboptions you must use this property to refer to the input files using the property above; do not use your own list.
<p />
<h3><a name="Processing_multiple_datasets_in"></a> Processing multiple datasets in one task with separate outputs </h3>
For efficient grid submission, you should only do one submission even when you want to run over multiple datasets. You can specify multiple datasets either as a comma delimited list to <code>--inDS</code>, or in a text file and use the <code>--inDsTxt</code> option. 
<p />
If you want to ensure no single output file is made from more than one dataset, add the <code>--useContElementBoundary</code> option. If you would like the dataset number to appear in the name of the output files, so that you can identify which dataset a file was made from by looking the filename, use:
<p />
<pre>
--addNthFieldOfInDSToLFN&#61;2
</pre>
<p />
This will add the 2nd part of dataset name (i.e. the dataset number) to the output file names. You could add the ami tags too, for example, by doing:
<p />
<pre>
--addNthFieldOfInDSToLFN&#61;2,6
</pre>
<p />
Add everything with "1,2,3,4,5,6" if you must.
<p />
<h3><a name="Merging_xAOD_format_output_files"></a> Merging xAOD-format output files </h3>
From 2.4.32 onwards, you will be able to merge your xAOD outputs on the grid by adding the following options to pathena:
<pre>
--mergeOutput --mergeScript&#61;xAODPOOLMerge.py
</pre>
<p />
<p />
<h2><a name="How_to_submit_your_job_to_condor"></a> How to submit your job to condor </h2>
Same rules about evtMax and InputFiles as from the grid submission apply.
<p />
<pre>
lsetup ganga
ganga athena --condor --nocompile --inputtype Local --locallocation &#39;/path/to/files&#39; &#39;&#42;root&#42;&#39; --split&#61;60 --outputlocation&#61;&#34;/path/to/output/location/&#34; --outputtype &#39;ATLAS&#39; myJobOptions.py
</pre>
If you organized files into text files (perhaps according to dataset) then instead of doing:
<pre>
--inputtype Local --locallocation &#39;/path/to/files&#39; &#39;&#42;root&#42;&#39;
</pre>
Just do:
<pre>
--inPfnListFile &#39;dataset.txt,dataset2.txt&#39;
</pre>
This will cause each dataset to be processed in separated subjobs (no subjob using files from multiple datasets), and the output of each dataset will go into a directory corresponding to the filename (i.e. <code>/path/to/output/location/dataset.txt/</code> etc etc.)
<p />
Note that you may need to tweak a few settings in your gangarc config file. See <a href="https://twiki.cern.ch/twiki/bin/view/AtlasProtected/BNLSoftwareTutorial#Configuration_for_ganga" target="_top">here for some instructions from recent tutorial</a> In particular, it is recommended you open your <code>$HOME/.gangarc</code> file and ensure the following is present:
<p />
<pre>
NoSubDirsAtAllForLocalOutput &#61; True
</pre>
<p />
<h2><a name="How_to_submit_your_job_to_LXBatc"></a> How to submit your job to LXBatch </h2>
<p />
If you are running on lxplus, follow the condor instructions in the secion above, except replace <code>condor</code> with <code>lsf</code>. Also ensure your <code>outputlocation</code> is specified as a full path, e.g. <code>/afs/cern.ch/user/w/will/my/output/files/location</code>
<p />
<h1><a name="Writing_Job_Options"></a> Writing Job Options </h1>
<p />
<h2><a name="How_to_loop_over_an_xAOD"></a> How to loop over an xAOD </h2>
create a job option (a python file) with the following three lines
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>jps.AthenaCommonFlags.FilesInput = [<B><FONT COLOR="#BC8F8F">&quot;my.xaod.root&quot;</FONT></B>]
<B><FONT COLOR="#A020F0">import</FONT></B> AthenaPoolCnvSvc.ReadAthenaPool
athAlgSeq = CfgMgr.AthSequencer(<B><FONT COLOR="#BC8F8F">&quot;AthAlgSeq&quot;</FONT></B>) <I><FONT COLOR="#B22222">#gets a handle to the main athsequencer, for adding things to later!
</FONT></I></pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
From 2.4.7 onwards, there are two new read mechanisms, optimal for reading xAOD. Please see the table below to decide which to use:
<p />
<table border="1" cellpadding="0" cellspacing="0" class="twikiTable" id="table3" rules="all">
<tr class="twikiTableOdd twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
<th bgcolor="#687684" class="twikiTableCol0 twikiFirstCol" valign="top"> <a href="/twiki/bin/view/AtlasProtected/AthAnalysisBase?sortcol=0;table=3;up=0#sorted_table" rel="nofollow" title="Sort by this column"><font color="#ffffff"> Line in joboptions </font></a> </th>
<th bgcolor="#687684" class="twikiTableCol1" valign="top"> <a href="/twiki/bin/view/AtlasProtected/AthAnalysisBase?sortcol=1;table=3;up=0#sorted_table" rel="nofollow" title="Sort by this column"><font color="#ffffff">Reading xAOD</font></a> </th>
<th bgcolor="#687684" class="twikiTableCol2" valign="top"> <a href="/twiki/bin/view/AtlasProtected/AthAnalysisBase?sortcol=2;table=3;up=0#sorted_table" rel="nofollow" title="Sort by this column"><font color="#ffffff">Writing xAOD</font></a> </th>
<th bgcolor="#687684" class="twikiTableCol3 twikiLastCol" valign="top"> <a href="/twiki/bin/view/AtlasProtected/AthAnalysisBase?sortcol=3;table=3;up=0#sorted_table" rel="nofollow" title="Sort by this column"><font color="#ffffff">Explanation</font></a> </th>
</tr>
<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
<td bgcolor="#ffffff" class="twikiTableCol0 twikiFirstCol" valign="top"> <pre>import AthenaPoolCnvSvc.ReadAthenaPool</pre> </td>
<td bgcolor="#ffffff" class="twikiTableCol1" valign="top"> Y </td>
<td bgcolor="#ffffff" class="twikiTableCol2" valign="top"> Y </td>
<td bgcolor="#ffffff" class="twikiTableCol3 twikiLastCol" valign="top"> Uses POOL to read and write xAOD. Fully supported, but very simple analysis jobs may be I/O limited by this </td>
</tr>
<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
<td bgcolor="#edf4f9" class="twikiTableCol0 twikiFirstCol" valign="top"> <pre>import AthenaRootComps.ReadAthenaxAODHybrid</pre> </td>
<td bgcolor="#edf4f9" class="twikiTableCol1" valign="top"> Y </td>
<td bgcolor="#edf4f9" class="twikiTableCol2" valign="top"> N </td>
<td bgcolor="#edf4f9" class="twikiTableCol3 twikiLastCol" valign="top"> Uses POOL to read the metadata, but uses TEvent to read the xAOD eventdata. Faster than <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/ReadAthenaPool?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">ReadAthenaPool</a></span>. </td>
</tr>
<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
<td bgcolor="#ffffff" class="twikiTableCol0 twikiFirstCol twikiLast" valign="top"> <pre>import AthenaRootComps.ReadAthenaxAOD</pre> </td>
<td bgcolor="#ffffff" class="twikiTableCol1 twikiLast" valign="top"> Y </td>
<td bgcolor="#ffffff" class="twikiTableCol2 twikiLast" valign="top"> N </td>
<td bgcolor="#ffffff" class="twikiTableCol3 twikiLastCol twikiLast" valign="top"> Uses TEvent to read the xAOD eventdata and metadata. Only xAOD-format metadata is available </td>
</tr></table>
<p />
With the last two methods, you can also choose the <code>AccessMode</code> by setting the property of the EventSelector:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>svcMgr.EventSelector.AccessMode = 1 <I><FONT COLOR="#B22222">#0 = branch, 1 = class, 2 = 'athena', -1 = use TEvent's default
</FONT></I></pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
<h2><a name="How_to_loop_over_a_TTree"></a> How to loop over a TTree </h2>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>jps.AthenaCommonFlags.FilesInput = [<B><FONT COLOR="#BC8F8F">&quot;my.xaod.root&quot;</FONT></B>]
<B><FONT COLOR="#A020F0">import</FONT></B> AthenaRootComps.ReadAthenaRoot
svcMgr.EventSelector.TupleName = <B><FONT COLOR="#BC8F8F">&quot;TreeName&quot;</FONT></B> <I><FONT COLOR="#B22222">#from input file
</FONT></I></pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
The content of each branch will be put into the storegate. You retrieve an individual branch using a const pointer to it. E.g. to retrieve a branch called <code>myInt</code> that is an integer type, you would need (in your c++ code):
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B>* myInt = 0;
<B><FONT COLOR="#0000FF">CHECK</FONT></B>( evtStore()-&gt;retrieve( myInt, <B><FONT COLOR="#BC8F8F">&quot;myInt&quot;</FONT></B> ) );
std::cout &lt;&lt; <B><FONT COLOR="#BC8F8F">&quot;myInt = &quot;</FONT></B> &lt;&lt; (*myInt) &lt;&lt; std::endl; <I><FONT COLOR="#B22222">//for example
</FONT></I></pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
<p />
<h2><a name="How_to_add_your_algorithm_to_the"></a> How to add your algorithm to the joboption </h2>
For <b>c++ algorithms</b>, you can use:
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>athAlgSeq += CfgMgr.MyAlg()</pre>
<!-- end SyntaxHighlightingPlugin -->
For a <b>python algorithm</b>, you currently cannot use the <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/CfgMgr?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">CfgMgr</a></span>, instead you have to import the alg directly, like this:
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#A020F0">from</FONT></B> MyPackage.MyPyAlg <B><FONT COLOR="#A020F0">import</FONT></B> MyPyAlg
athAlgSeq += MyPyAlg()</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
<h2><a name="How_to_loop_over_all_xaod_in_a_f"></a> How to loop over all xaod in a folder </h2>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#A020F0">from</FONT></B> glob <B><FONT COLOR="#A020F0">import</FONT></B> glob
jps.AthenaCommonFlags.FilesInput = glob(<B><FONT COLOR="#BC8F8F">&quot;/path/to/folder/*.root&quot;</FONT></B>) <I><FONT COLOR="#B22222">#must happen before the import of the read file mode
</FONT></I></pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
<h2><a name="How_to_access_file_metadata_at_t"></a> How to access file metadata at the joboption level </h2>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#A020F0">from</FONT></B> PyUtils <B><FONT COLOR="#A020F0">import</FONT></B> AthFile
af = AthFile.fopen(jps.AthenaCommonFlags.FilesInput()[0]) <I><FONT COLOR="#B22222">#opens the first file from the FilesInput list
</FONT></I>af.fileinfos <I><FONT COLOR="#B22222">#this is a dict of dicts, take a look at what's available (e.g. do af.fileinfos.keys() to see the main keys)! Below are some examples:
</FONT></I>
streamName = af.fileinfos[<B><FONT COLOR="#BC8F8F">'stream_names'</FONT></B>] <I><FONT COLOR="#B22222">#will be something like 'StreamDAOD_XXX' if a derivation
</FONT></I>isMC = <B><FONT COLOR="#BC8F8F">'IS_SIMULATION'</FONT></B> <B><FONT COLOR="#A020F0">in</FONT></B> af.fileinfos[<B><FONT COLOR="#BC8F8F">'evt_type'</FONT></B>]
beam_energy = af.fileinfos[<B><FONT COLOR="#BC8F8F">'beam_energy'</FONT></B>]
conditions_tag = af.fileinfos[<B><FONT COLOR="#BC8F8F">'conditions_tag'</FONT></B>] <I><FONT COLOR="#B22222">#useful for figuring out which mc production this is
</FONT></I>isFastSim = isMC <B><FONT COLOR="#A020F0">and</FONT></B> (<B><FONT COLOR="#BC8F8F">'ATLFASTII'</FONT></B> <B><FONT COLOR="#A020F0">in</FONT></B> af.fileinfos[<B><FONT COLOR="#BC8F8F">'metadata'</FONT></B>][<B><FONT COLOR="#BC8F8F">'/Simulation/Parameters'</FONT></B>][<B><FONT COLOR="#BC8F8F">'SimulationFlavour'</FONT></B>].upper()) <I><FONT COLOR="#B22222">#full sim or atlfast
</FONT></I>mc_channel_number = af.mc_channel_numbers[0] <I><FONT COLOR="#B22222">#the first (and usually only) channel number in the first input file
</FONT></I></pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
If you run <code>checkMetaSG.py my.xAOD.root</code> on your input file (assumed here to be called <code>my.xAOD.root</code>) you will also get a list of most of the metadata (specifically, the data held in <code>af.fileinfos['metadata']</code>). The information is organized 'folders'. You can then access that through code like that shown above. E.g if you saw:
<p />
<pre>
      /Digitization/Parameters &#124; physicsList               &#124; str     &#124; FTFP&#95;BERT                     
                               &#124; N&#95;beamGasInputFiles       &#124; int     &#124; 0                             
                               &#124; doBeamHalo                &#124; bool    &#124; False           
</pre>
<p />
You can do:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>doBeamHalo = af.fileinfos[<B><FONT COLOR="#BC8F8F">'metadata'</FONT></B>][<B><FONT COLOR="#BC8F8F">'/Digitzation/Parameters'</FONT></B>][<B><FONT COLOR="#BC8F8F">'doBeamHalo'</FONT></B>]</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
<h2><a name="How_to_filter_by_event_number"></a> How to filter by event number </h2>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#A020F0">from</FONT></B> GaudiSequencer.PyComps <B><FONT COLOR="#A020F0">import</FONT></B> PyEvtFilter
filterseq = CfgMgr.AthSequencer(<B><FONT COLOR="#BC8F8F">&quot;AthFilterSeq&quot;</FONT></B>)
<I><FONT COLOR="#B22222">#the following lines are examples, pick one...
</FONT></I>filterseq += PyEvtFilter(<B><FONT COLOR="#BC8F8F">&quot;MyFilter&quot;</FONT></B>, evt_list=[1,2,3]) <I><FONT COLOR="#B22222">#will execute main sequence only for these eventnumbers
</FONT></I>filterseq += PyEvtFilter(<B><FONT COLOR="#BC8F8F">&quot;AnotherFilter&quot;</FONT></B>, evt_list=[1,2,3],filter_policy=<B><FONT COLOR="#BC8F8F">'reject'</FONT></B>) <I><FONT COLOR="#B22222">#execute all events except these ones
</FONT></I></pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
<h2><a name="How_to_create_an_output_xAOD"></a> How to create an output xAOD </h2>
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>from OutputStreamAthenaPool.MultipleStreamManager import MSMgr
xaodStream = MSMgr.NewPoolRootStream( <B><FONT COLOR="#BC8F8F">&quot;StreamXAOD&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;xAOD.out.root&quot;</FONT></B> )
#<B><FONT COLOR="#5F9EA0">AddItem</FONT></B> <FONT COLOR="#B8860B">and</FONT> <FONT COLOR="#B8860B">AddMetaDataItem</FONT> <FONT COLOR="#B8860B">methods</FONT> <FONT COLOR="#B8860B">accept</FONT> <FONT COLOR="#B8860B">either</FONT> <FONT COLOR="#B8860B">string</FONT> <FONT COLOR="#B8860B">or</FONT> <FONT COLOR="#B8860B">list</FONT> <FONT COLOR="#B8860B">of</FONT> <FONT COLOR="#B8860B">strings</FONT>
xaodStream.AddItem( [<B><FONT COLOR="#BC8F8F">&quot;xAOD::JetContainer#*&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;xAOD::JetAuxContainer#*&quot;</FONT></B>] ) #see below <B><FONT COLOR="#A020F0">for</FONT></B> syntax
xaodStream.AddMetaDataItem( [<B><FONT COLOR="#BC8F8F">&quot;xAOD::TriggerMenuContainer#*&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;xAOD::TriggerMenuAuxContainer#*&quot;</FONT></B>] ) ... will keep trigger menu info, but you *must* add the corresponding metadata tool ... see below ...</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
If you want to add every item from the input list to the output, then do:
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>xaodStream.Stream.TakeItemsFromInput = True <I><FONT COLOR="#B22222">#this will only work for the event-by-event items. MetadataItems must still be specified
</FONT></I></pre>
<!-- end SyntaxHighlightingPlugin -->
<b>HOWEVER:</b> You will get plenty of warnings/errors from this if your xAOD contains non-analysis objects (likely the case). Despite all these warnings/errors though, the output should be usable.
<p />
<div class="twistyPlugin twikiMakeVisibleInline">  <span id="twistyIdAtlasProtectedAthAnalysisBase4show" class="twistyStartHide twistyTrigger twikiUnvisited twistyInited0"><a href="#"><span class="twikiLinkLabel twikiUnvisited">Slimming: <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/AddItem?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">AddItem</a></span> syntax and examples of removing or adding individual branches of xAOD...</span><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" border="0" alt="" /></a> </span> <span id="twistyIdAtlasProtectedAthAnalysisBase4hide" class="twistyStartHide twistyTrigger twikiUnvisited twistyHidden twistyInited0"><a href="#"><span class="twikiLinkLabel twikiUnvisited">Hide</span><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleclose-small.gif" border="0" alt="" /></a> </span>  </div><!--/twistyPlugin twikiMakeVisibleInline--> <div class="twistyPlugin"><div id="twistyIdAtlasProtectedAthAnalysisBase4toggle" class="twikiHelp twistyStartHide twistyContent twikiMakeHidden twistyInited0">
You can use wildcards to copy all containers/collections of specified container type to your output xAOD file, something like:
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>MyFirstXAODStream.AddItem([<B><FONT COLOR="#BC8F8F">'xAOD::JetContainer#*'</FONT></B>])
MyFirstXAODStream.AddItem([<B><FONT COLOR="#BC8F8F">'xAOD::JetAuxContainer#*'</FONT></B>])</pre>
<!-- end SyntaxHighlightingPlugin -->
for all jet containers.
<p />
You can specify at the job option level which branches you want to write out and which one you don't want to write out. Remember that you can only remove the dynamic auxiliary branches, see <a href="https://twiki.cern.ch/twiki/bin/view/AtlasComputing/SoftwareTutorialxAODAnalysisInAthena#Different_types_of_auxiliary_con" target="_top">above</a> for more information on this.
<p />
But if you want to remove, e.g., all dynamic auxiliary variable for the <code>xAOD::CaloClusterAuxContainer</code> with name <code>ClustersAux.</code>, you can do this:
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><I><FONT COLOR="#B22222"># Dont write out any cluster moments for the Clusters container:
</FONT></I>MyFirstXAODStream.AddItem( <B><FONT COLOR="#BC8F8F">'xAOD::CaloClusterAuxContainer#ClustersAux.-'</FONT></B> )</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
If you want to write out everything <strong>except</strong> the variables <code>NumTrkPt1000</code> and <code>ActiveArea4vec_eta</code> of your <code>SmallJetsAux.</code> container, then you can do this:
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><I><FONT COLOR="#B22222"># Select which jet moments to write out:
</FONT></I>MyFirstXAODStream.AddItem( <B><FONT COLOR="#BC8F8F">'xAOD::JetAuxContainer#SmallJetsAux.-NumTrkPt1000.-ActiveArea4vec_eta'</FONT></B> )</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
If you want to write out all static auxiliary variables <strong>and</strong> the dynamic auxiliary variables <code>JetGhostArea</code> and <code>JetEMScaleMomentum_pt</code> for your <code>LargeJetsAux.</code>, then do this:
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><I><FONT COLOR="#B22222"># Select which jet moments to write out:
</FONT></I>MyFirstXAODStream.AddItem( <B><FONT COLOR="#BC8F8F">'xAOD::JetAuxContainer#LargeJetsAux.JetGhostArea.JetEMScaleMomentum_pt'</FONT></B> )</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
If you want to really start from scratch, remember that your auxiliary container must be of type <code>xAOD::AuxContainerBase</code>, see <a href="https://twiki.cern.ch/twiki/bin/view/AtlasComputing/SoftwareTutorialxAODAnalysisInAthena#Different_types_of_auxiliary_con" target="_top">above for more info</a>. This would then look like this:
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><I><FONT COLOR="#B22222"># Select which jet moments to write out:
</FONT></I>MyFirstXAODStream.AddItem( <B><FONT COLOR="#BC8F8F">'xAOD:: AuxContainerBase#MyMuonsAux.pt.eta.phi.m'</FONT></B> )</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
One thing to note is that you cannot mix the adding and subtracting feature. You can only use one of them for a given container.
</div></div> <!--/twistyPlugin-->
<p />
<h3><a name="Copying_metadata_from_input_to_o"></a> Copying metadata from input to output files </h3>
Metadata from the input files goes into the <code>InputMetaDataStore</code> storegate instance. Metadata that can be written to an output stream must be present in the <code>MetaDataStore</code> storegate instance. Therefore, if you want to copy metadata from the input file to the output file, you need something that will copy over that metadata from the <code>InputMetaDataStore</code> into the <code>MetaDataStore</code>. This is what a <b>MetaDataTool</b> does: it aggregates the metadata across multiple files (if you run on multiple files) so that it's all correctly formatted for the output file. Each type of metadata has a corresponding MetaDataTool. You need to create an instance of the tool, and add it to the <code>MetaDataSvc</code>. For example, to have the trigger menu metadata be copied over, you must do:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>ToolSvc += CfgMgr.xAODMaker__TriggerMenuMetaDataTool(<B><FONT COLOR="#BC8F8F">&quot;TriggerMenuMetaDataTool&quot;</FONT></B>)
svcMgr.MetaDataSvc.MetaDataTools += [ ToolSvc.TriggerMenuMetaDataTool ]</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
The table below lists, for each type of metadata that you want, what tool you need to instantiate and add to the list of MetaDataTools:
<p />
<table border="1" cellpadding="0" cellspacing="0" class="twikiTable" id="table4" rules="all">
<tr class="twikiTableOdd twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
<th bgcolor="#687684" class="twikiTableCol0 twikiFirstCol" valign="top"> <a href="/twiki/bin/view/AtlasProtected/AthAnalysisBase?sortcol=0;table=4;up=0#sorted_table" rel="nofollow" title="Sort by this column"><font color="#ffffff">Metadata item</font></a> </th>
<th bgcolor="#687684" class="twikiTableCol1 twikiLastCol" valign="top"> <a href="/twiki/bin/view/AtlasProtected/AthAnalysisBase?sortcol=1;table=4;up=0#sorted_table" rel="nofollow" title="Sort by this column"><font color="#ffffff">Metadata tool</font></a> </th>
</tr>
<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
<td bgcolor="#ffffff" class="twikiTableCol0 twikiFirstCol" valign="top"> <pre>xaodStream.AddMetaDataItem( &#91;&#34;xAOD::TriggerMenuContainer#&#42;&#34;,
&#34;xAOD::TriggerMenuAuxContainer#&#42;&#34;] )</pre> </td>
<td bgcolor="#ffffff" class="twikiTableCol1 twikiLastCol" valign="top"> xAODMaker__TriggerMenuMetaDataTool </td>
</tr>
<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
<td bgcolor="#edf4f9" class="twikiTableCol0 twikiFirstCol" valign="top"> <pre>xaodStream.AddMetaDataItem( &#91;&#34;xAOD::LumiBlockRangeContainer#&#42;&#34;,
&#34;xAOD::LumiBlockRangeAuxContainer#&#42;&#34;] )</pre> </td>
<td bgcolor="#edf4f9" class="twikiTableCol1 twikiLastCol" valign="top"> LumiBlockMetaDataTool </td>
</tr>
<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
<td bgcolor="#ffffff" class="twikiTableCol0 twikiFirstCol twikiLast" valign="top"> <pre>xaodStream.AddMetaDataItem( &#91;&#34;xAOD::CutBookkeeperContainer#&#42;&#34;,
&#34;xAOD::CutBookkeeperAuxContainer#&#42;&#34;] )</pre> </td>
<td bgcolor="#ffffff" class="twikiTableCol1 twikiLastCol twikiLast" valign="top"> <pre>theApp.CreateSvc +&#61; &#91;&#39;CutFlowSvc/CutFlowSvc&#39;]</pre> (currently handled by a service, will be made into a tool at some point in the future) </td>
</tr></table>
<p />
<p />
<p />
<h3><a name="Event_skimming_filtering"></a> Event skimming/filtering </h3>
Event filtering is the logic combination of <code>AcceptAlgs</code>, <code>RequireAlgs</code> and <code>VetoAlgs</code>. For example, to add an <code>AcceptAlg</code>, do:
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><I><FONT COLOR="#B22222">#These methods also accept strings or lists of strings
</FONT></I>xaodStream.AddAcceptAlgs( <B><FONT COLOR="#BC8F8F">&quot;MyFilter&quot;</FONT></B> ) <I><FONT COLOR="#B22222">#You must ensure MyFilter is executed during the event .. see example of MyFilter above
</FONT></I></pre>
<!-- end SyntaxHighlightingPlugin -->
The logic applied is to keep the event provided: Any <code>AcceptAlg</code> passes (if any are present) <strong>AND</strong> All <code>RequireAlgs</code> pass <strong>AND</strong> No <code>VetoAlgs</code> pass. <br>So by default (no accept/require/veto algs), every event is accepted.
<p />
So here is a complete example of 'event picking' from a local file (note that when running on the grid, you should use the event picking service to do this instead):
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>theApp.EvtMax=-1 <I><FONT COLOR="#B22222">#process the whole file
</FONT></I><B><FONT COLOR="#A020F0">import</FONT></B> AthenaPoolCnvSvc.ReadAthenaPool
svcMgr.EventSelector.InputCollections= [<B><FONT COLOR="#BC8F8F">&quot;my.xaod.root&quot;</FONT></B>]
<I><FONT COLOR="#B22222">#setup the event picking
</FONT></I><B><FONT COLOR="#A020F0">from</FONT></B> GaudiSequencer.PyComps <B><FONT COLOR="#A020F0">import</FONT></B> PyEvtFilter
athAlgSeq = CfgMgr.AthSequencer(<B><FONT COLOR="#BC8F8F">&quot;AthAlgSeq&quot;</FONT></B>)
athAlgSeq += PyEvtFilter(<B><FONT COLOR="#BC8F8F">&quot;MyFilter&quot;</FONT></B>, evt_list=[1,2,3]) <I><FONT COLOR="#B22222">#well select the events with event numbers 1,2, or 3
</FONT></I>
<I><FONT COLOR="#B22222">#setup the output stream
</FONT></I><B><FONT COLOR="#A020F0">from</FONT></B> OutputStreamAthenaPool.MultipleStreamManager <B><FONT COLOR="#A020F0">import</FONT></B> MSMgr
xaodStream = MSMgr.NewPoolRootStream( <B><FONT COLOR="#BC8F8F">&quot;StreamXAOD&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;xAOD.out.root&quot;</FONT></B> )
xaodStream.AddAcceptAlgs( <B><FONT COLOR="#BC8F8F">&quot;MyFilter&quot;</FONT></B> )
xaodStream.Stream.TakeItemsFromInput = True <I><FONT COLOR="#B22222">#take all the event payload that analysis releases can read
</FONT></I><I><FONT COLOR="#B22222">#add the metadata and the metadata tools
</FONT></I>ToolSvc += CfgMgr.LumiBlockMetaDataTool(<B><FONT COLOR="#BC8F8F">&quot;LumiBlockMetaDataTool&quot;</FONT></B>) <I><FONT COLOR="#B22222">#only needed for data
</FONT></I>ToolSvc += CfgMgr.xAODMaker__TriggerMenuMetaDataTool( <B><FONT COLOR="#BC8F8F">&quot;TriggerMenuMetaDataTool&quot;</FONT></B> )
theApp.CreateSvc += [<B><FONT COLOR="#BC8F8F">'CutFlowSvc/CutFlowSvc'</FONT></B>] <I><FONT COLOR="#B22222">#Not a metadatatool yet :-(
</FONT></I>svcMgr.MetaDataSvc.MetaDataTools += [ ToolSvc.LumiBlockMetaDataTool, ToolSvc.TriggerMenuMetaDataTool  ]
xaodStream.AddMetaDataItem([<B><FONT COLOR="#BC8F8F">&quot;xAOD::LumiBlockRangeContainer#*&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;xAOD::LumiBlockRangeAuxContainer#*&quot;</FONT></B>,
                                                   <B><FONT COLOR="#BC8F8F">&quot;xAOD::TriggerMenuContainer#*&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;xAOD::TriggerMenuAuxContainer#*&quot;</FONT></B>,
                                                   <B><FONT COLOR="#BC8F8F">&quot;xAOD::CutBookkeeperContainer#*&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;xAOD::CutBookkeeperAuxContainer#*&quot;</FONT></B>])</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
<p />
<h3><a name="How_to_access_an_existing_stream"></a> How to access an existing stream </h3>
In complicated jobOption configurations, a stream may have been created for you in some other part of the configuration, and you want to get hold of it to add more items to the output. Simply ask the MultipleStreamManager for the stream:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#A020F0">from</FONT></B> OutputStreamAthenaPool.MultipleStreamManager <B><FONT COLOR="#A020F0">import</FONT></B> MSMgr
myStream = MSMgr.GetStream(<B><FONT COLOR="#BC8F8F">&quot;MyStream&quot;</FONT></B>)
myStream.AddItem( ... ) <I><FONT COLOR="#B22222">#etc etc
</FONT></I></pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
If you aren't sure what your stream is called, you can always call the Print method of MSMgr, which will list all known streams. Hopefully the names will help you identify what you're after:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>MSMgr.Print()</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
<p />
<p />
<h2><a name="How_to_take_arguments_from_the_c"></a> How to take arguments from the command line </h2>
For example, to pass a string (files to run over) and an integer parameter (number of events to process) from the command line, you have in your job options:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>theApp.EvtMax = vars().get(<B><FONT COLOR="#BC8F8F">'EVTMAX'</FONT></B>, -1)
<B><FONT COLOR="#A020F0">from</FONT></B> glob <B><FONT COLOR="#A020F0">import</FONT></B> glob
svcMgr.EventSelector.InputCollections = glob( vars().get(<B><FONT COLOR="#BC8F8F">&quot;FILES&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;default.xaod.root&quot;</FONT></B>) )</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
And from the command line you can do:
<p />
<pre>
athena -c &#34;EVTMAX&#61;400;FILES&#61;&#39;path/to/&#42;.root&#39; &#34; myJobOptions.py
</pre>
<p />
<h2><a name="How_to_change_output_level_of_a"></a> How to change output level of a configurable just by its name </h2>
If you don't have a ref to the configurable (e.g. if its buried deep in a joboption ... which shouldn't be the case with athanalysisbase jobs anyway <img src="https://twiki.cern.ch/twiki/pub/TWiki/SmiliesPlugin/smile.gif" alt="smile" title="smile" border="0" /> ) then you can activate, e.g, debugging for the specific configurable with:
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>svcMgr.MessageSvc.setDebug += [<B><FONT COLOR="#BC8F8F">&quot;MyConfigurable&quot;</FONT></B>]</pre>
<!-- end SyntaxHighlightingPlugin -->
Note: This doesn't appear to work with every configurable, but seems ok for algs and tools (If the tool is shared, the name is "ToolSvc.MyTool")
<p />
<h2><a name="How_to_change_the_format_of_the"></a> How to change the format of the logging messages </h2>
Sometimes the space allocated for the name of the tool is a little short to see the full name of the tool. To give yourself more space, do:
<pre>
svcMgr.MessageSvc.Format &#61; &#34;&#37; F&#37;18W&#37;S&#37;7W&#37;R&#37;T &#37;0W&#37;M&#34;
</pre>
<p />
Where you change the <code>18</code> to the number of characters you want to give to displaying the name of the tool. E.g. try setting it to <code>50</code> to see what space you get!
<p />
<h2><a name="How_to_silence_output_from_all_b"></a> How to silence output from all but one configurable </h2>
If you want to only output messages from a single configurable (algorithm, tool, etc), then do the following (you should put this at the <strong>very end of your joboptions</strong>, to ensure that anything happening in your joboption that might change these <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/MessageSvc?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">MessageSvc</a></span> options doesn't take effect):
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>svcMgr.MessageSvc.OutputLevel=ERROR    <I><FONT COLOR="#B22222">#equivalent to theApp.setOutputLevel(ERROR)
</FONT></I>svcMgr.MessageSvc.setInfo += [<B><FONT COLOR="#BC8F8F">&quot;MyConfigurable&quot;</FONT></B>]</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
<h2><a name="How_to_use_SampleHandler_in_a_jo"></a> How to use <a class="twikiLink" href="/twiki/bin/view/AtlasProtected/SampleHandler">SampleHandler</a> in a joboption (e.g. locating files on eos) </h2>
The <a class="twikiLink" href="/twiki/bin/view/AtlasProtected/SampleHandler">SampleHandler</a> package is a data-discovery assistant designed for the <a class="twikiLink" href="/twiki/bin/view/AtlasProtected/EventLoop">EventLoop</a> framework. It has some useful features for working with the eos data storage, which isn't something that <code>glob</code> can search through for you. Here's an example of how you could use it to get the list of files of all datasets below the directory <code>/eos/atlas/atlascerngroupdisk/det-l1calo/Tier0/perm/data15_13TeV/physics_L1Calo</code>:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#A020F0">import</FONT></B> ROOT
sh = ROOT.SH.SampleHandler()
ROOT.SH.ScanDir().filePattern(<B><FONT COLOR="#BC8F8F">&quot;*merge*&quot;</FONT></B>).sampleDepth(1).scanEOS(sh,<B><FONT COLOR="#BC8F8F">&quot;/eos/atlas/atlascerngroupdisk/det-l1calo/Tier0/perm/data15_13TeV/physics_L1Calo&quot;</FONT></B>)
svcMgr.EventSelector.InputCollections = [f <B><FONT COLOR="#A020F0">for</FONT></B> aSample <B><FONT COLOR="#A020F0">in</FONT></B> sh <B><FONT COLOR="#A020F0">for</FONT></B> f <B><FONT COLOR="#A020F0">in</FONT></B> aSample.makeFileList()]</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
<h1><a name="Usage_examples"></a> Usage examples </h1>
This section gives instructions on how to use some prewritten algorithms in your algsequence that will implement the CP recommendations. You are still free to configure and apply the tools yourself, directly in the code. This section also has quick snippets of how to do various things...
<p />
<h2><a name="How_to_calibrate_muons"></a> How to calibrate muons </h2>
Add to job options (before your algorithm):
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>athAlgSeq += CfgMgr.CP__CalibratedMuonsProvider(Input=<B><FONT COLOR="#BC8F8F">&quot;Muons&quot;</FONT></B>,Output=<B><FONT COLOR="#BC8F8F">&quot;CalibratedMuons&quot;</FONT></B>)</pre>
<!-- end SyntaxHighlightingPlugin -->
Then in your algorithm:
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#228B22">const</FONT></B> xAOD::MuonContainer* muons = 0;
<B><FONT COLOR="#0000FF">CHECK</FONT></B>( evtStore()-&gt;retrieve(muons,<B><FONT COLOR="#BC8F8F">&quot;CalibratedMuons&quot;</FONT></B>) );</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
<h2><a name="How_to_calibrate_electrons_or_ph"></a> How to calibrate electrons or photons </h2>
Add to job options:
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>athAlgSeq += CfgMgr.CP__CalibratedEgammaProvider(Input=<B><FONT COLOR="#BC8F8F">&quot;Electrons&quot;</FONT></B>,Output=<B><FONT COLOR="#BC8F8F">&quot;CalibratedElectrons&quot;</FONT></B>)
athAlgSeq += CfgMgr.CP__CalibratedEgammaProvider(Input=<B><FONT COLOR="#BC8F8F">&quot;Photons&quot;</FONT></B>,Output=<B><FONT COLOR="#BC8F8F">&quot;CalibratedPhotons&quot;</FONT></B>)</pre>
<!-- end SyntaxHighlightingPlugin -->
Then in your algorithm:
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#228B22">const</FONT></B> xAOD::ElectronContainer* electrons = 0;
<B><FONT COLOR="#0000FF">CHECK</FONT></B>( evtStore()-&gt;retrieve(electrons,<B><FONT COLOR="#BC8F8F">&quot;CalibratedElectrons&quot;</FONT></B>) );</pre>
<!-- end SyntaxHighlightingPlugin -->
or
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#228B22">const</FONT></B> xAOD::PhotonContainer* photons = 0;
<B><FONT COLOR="#0000FF">CHECK</FONT></B>( evtStore()-&gt;retrieve(photons,<B><FONT COLOR="#BC8F8F">&quot;CalibratedPhotons&quot;</FONT></B>) );</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
<h2><a name="How_to_calibrate_jets"></a> How to calibrate jets * </h2>
This provider isn't in the releses (yet), so unless you want to use the jet calib tools directly (which are in the releases), to get the provider you should execute the following script (just the once) after setting up your release:
<pre>
source /afs/cern.ch/work/w/will/public/latestUpdates.sh
</pre>
<p />
Add to job options:
<pre>
athAlgSeq +&#61; CfgMgr.CP&#95;&#95;CalibratedJetProvider(Input&#61;&#34;AntiKt4LCTopoJets&#34;,Output&#61;&#34;CalibratedAntiKt4LCTopoJets&#34;)
</pre>
Then in your algorithm:
<pre>
const xAOD::JetContainer&#42; jets &#61; 0;
CHECK( evtStore()-&#62;retrieve(jets,&#34;CalibratedAntiKt4LCTopoJets&#34;) );
</pre>
<p />
<h2><a name="How_to_recalculate_MET_using_cal"></a> How to recalculate MET using calibrated objects </h2>
Assuming you used above examples to do calibrated electrons and muons, say, you can recalculate MET with the following in your job options:
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>ToolSvc += CfgMgr.met__METRebuilder(<B><FONT COLOR="#BC8F8F">&quot;METRebuilder&quot;</FONT></B>,MuonColl=<B><FONT COLOR="#BC8F8F">&quot;CalibratedMuons&quot;</FONT></B>,EleColl=<B><FONT COLOR="#BC8F8F">&quot;CalibratedElectrons&quot;</FONT></B>,OutputContainer=<B><FONT COLOR="#BC8F8F">&quot;CalibratedMET&quot;</FONT></B>)
athAlgSeq += CfgMgr.met__METUtilAlg(Rebuilders=[ToolSvc.METRebuilder])</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
<a name="ReadingMetaDataInCpp"></a>
<h2><a name="How_to_access_file_metadata_in_C"></a> How to access file metadata in C++ </h2>
You can see what metadata is available (specifically, what metadata is held in IOVMetaDataContainer objects) in a file by using:
<pre>
checkMetaSG.py my.file.root
</pre>
<p />
You can then access the metadata easily by making your algorithm inherit from <a class="twikiCurrentTopicLink twikiAnchorLink" href="/twiki/bin/view/AtlasProtected/AthAnalysisBase#CreateAnalysisAlg">AthAnalysisAlgorithm</a> instead of <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/AthAlgorithm?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">AthAlgorithm</a></span> (or tool inherit from AsgMetadataTool instead of AsgTool), which gives you a method called <code>beginInputFile</code> that is fired at the beginning of an input file read, and a <code>retrieveMetadata</code> method that helps you access the metadata. So you could do:
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>StatusCode <B><FONT COLOR="#0000FF">MyAlgorithm::beginInputFile</FONT></B>() {
  <B><FONT COLOR="#228B22">float</FONT></B> beam_energy(0);
  CHECK( retrieveMetadata(<B><FONT COLOR="#BC8F8F">&quot;/TagInfo&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;beam_energy&quot;</FONT></B>,beam_energy) ); 
  <I><FONT COLOR="#B22222">//first argument is the 'folder' second is the 'key', third is the thing you want to fill with the metadata value
</FONT></I>
  <B><FONT COLOR="#A020F0">return</FONT></B> StatusCode::SUCCESS;
}</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
If you don't use <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/AthAnalysisAlgorithm?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">AthAnalysisAlgorithm</a></span>, you can still use the helper method in your code like this:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;AthAnalysisBaseComps/AthAnalysisHelper.h&quot;</FONT></B> //remember to update requirements file with: use AthAnalysisBaseComps AthAnalysisBaseComps-* Control
  <B><FONT COLOR="#228B22">float</FONT></B> beam_energy(0);
  CHECK( AthAnalysisHelper::retrieveMetadata(<B><FONT COLOR="#BC8F8F">&quot;/TagInfo&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;beam_energy&quot;</FONT></B>,beam_energy) ); </pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
Below is a table describing some of the more useful parts of the metadata, but you can see the full availability with the checkMetaSG.py command described above
<p />
<table border="1" cellpadding="0" cellspacing="0" class="twikiTable" id="table5" rules="all">
<tr class="twikiTableOdd twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
<th bgcolor="#687684" class="twikiTableCol0 twikiFirstCol" valign="top"> <a href="/twiki/bin/view/AtlasProtected/AthAnalysisBase?sortcol=0;table=5;up=0#sorted_table" rel="nofollow" title="Sort by this column"><font color="#ffffff">Folder</font></a> </th>
<th bgcolor="#687684" class="twikiTableCol1" valign="top"> <a href="/twiki/bin/view/AtlasProtected/AthAnalysisBase?sortcol=1;table=5;up=0#sorted_table" rel="nofollow" title="Sort by this column"><font color="#ffffff">key</font></a> </th>
<th bgcolor="#687684" class="twikiTableCol2" valign="top"> <a href="/twiki/bin/view/AtlasProtected/AthAnalysisBase?sortcol=2;table=5;up=0#sorted_table" rel="nofollow" title="Sort by this column"><font color="#ffffff">type</font></a> </th>
<th bgcolor="#687684" class="twikiTableCol3 twikiLastCol" valign="top"> <a href="/twiki/bin/view/AtlasProtected/AthAnalysisBase?sortcol=3;table=5;up=0#sorted_table" rel="nofollow" title="Sort by this column"><font color="#ffffff">description</font></a> </th>
</tr>
<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
<td bgcolor="#ffffff" class="twikiTableCol0 twikiFirstCol" valign="top"> /TagInfo </td>
<td bgcolor="#ffffff" class="twikiTableCol1" valign="top"> beam_energy </td>
<td bgcolor="#ffffff" class="twikiTableCol2" valign="top"> float </td>
<td bgcolor="#ffffff" class="twikiTableCol3 twikiLastCol" valign="top"> beam energy in <a class="twikiLink" href="/twiki/bin/view/AtlasProtected/MeV">MeV</a>. For com=8TeV, this will be 4*10^6 </td>
</tr>
<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
<td bgcolor="#edf4f9" class="twikiTableCol0 twikiFirstCol" valign="top"> /Digitization/Parameters </td>
<td bgcolor="#edf4f9" class="twikiTableCol1" valign="top"> <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/BeamIntensityPattern?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">BeamIntensityPattern</a></span> </td>
<td bgcolor="#edf4f9" class="twikiTableCol2" valign="top"> std::vector<float> </td>
<td bgcolor="#edf4f9" class="twikiTableCol3 twikiLastCol" valign="top"> bunch pattern used in the simulation, vector of 1.0 and 0.0 values </td>
</tr>
<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
<td bgcolor="#ffffff" class="twikiTableCol0 twikiFirstCol" valign="top"> /Simulation/Parameters </td>
<td bgcolor="#ffffff" class="twikiTableCol1" valign="top"> <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/SimulationFlavour?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">SimulationFlavour</a></span> </td>
<td bgcolor="#ffffff" class="twikiTableCol2" valign="top"> std::string </td>
<td bgcolor="#ffffff" class="twikiTableCol3 twikiLastCol" valign="top"> will contain 'AtlfastII' (or uppercase form) if atlfast </td>
</tr>
<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
<td bgcolor="#edf4f9" class="twikiTableCol0 twikiFirstCol" valign="top"> /TagInfo </td>
<td bgcolor="#edf4f9" class="twikiTableCol1" valign="top"> <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/AtlasRelease?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">AtlasRelease</a></span> </td>
<td bgcolor="#edf4f9" class="twikiTableCol2" valign="top"> std::string </td>
<td bgcolor="#edf4f9" class="twikiTableCol3 twikiLastCol" valign="top"> You can use this to 'infer' the mc production:<br>'AtlasProduction-19.0.3.1' =&gt; mc14_8TeV<br>starts with 'AtlasProduction-19.1.' =&gt; mc14_13TeV <br>'AtlasProduction-17.2.1.4' =&gt; mc12a <br>'MCProd-17.2.1.4.9'  =&gt; mc12b (needs verifying) <br>'MCProd-17.2.11.2' =&gt; mc12c (needs verifying) </td>
</tr>
<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
<td bgcolor="#ffffff" class="twikiTableCol0 twikiFirstCol twikiLast" valign="top"> /TagInfo </td>
<td bgcolor="#ffffff" class="twikiTableCol1 twikiLast" valign="top"> project_name </td>
<td bgcolor="#ffffff" class="twikiTableCol2 twikiLast" valign="top"> std::string </td>
<td bgcolor="#ffffff" class="twikiTableCol3 twikiLastCol twikiLast" valign="top"> if it is "IS_SIMULATION" it is simulation </td>
</tr></table>
<p />
<h3><a name="EventStreamInfo_metadata"></a> EventStreamInfo metadata </h3>
The <code>checkMetaSG.py</code> command displays two tables. Much of the information in the first table is obtained from the <code>EventStreamInfo</code> object that is held in the metadata. Here's an example of accessing that information:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;EventInfo/EventStreamInfo.h&quot;</FONT></B> //remember to add to your cmt: use EventInfo EventInfo-* Event

    <B><FONT COLOR="#228B22">const</FONT></B> EventStreamInfo* esi = 0;
    CHECK( inputMetaStore()-&gt;retrieve(esi) );
    
    <B><FONT COLOR="#A020F0">for</FONT></B>(std::string s : esi-&gt;getProcessingTags() ) std::cout &lt;&lt; <B><FONT COLOR="#BC8F8F">&quot;StreamName = &quot;</FONT></B> &lt;&lt; s &lt;&lt; std::endl;    <I><FONT COLOR="#B22222">//prints list of streams ... should only be one (e.g. 'StreamDAOD_HIGG2D1')
</FONT></I>
    <B><FONT COLOR="#5F9EA0">std</FONT></B>::cout &lt;&lt; <B><FONT COLOR="#BC8F8F">&quot;run nums = &quot;</FONT></B>; <B><FONT COLOR="#A020F0">for</FONT></B>(<B><FONT COLOR="#228B22">auto</FONT></B> r : esi-&gt;getRunNumbers()) std::cout &lt;&lt; r &lt;&lt; <B><FONT COLOR="#BC8F8F">&quot; , &quot;</FONT></B>; std::cout &lt;&lt; std::endl; <I><FONT COLOR="#B22222">//list of run numbers in the file
</FONT></I>    <B><FONT COLOR="#A020F0">for</FONT></B>(<B><FONT COLOR="#228B22">auto</FONT></B>&amp; type : esi-&gt;getEventTypes()) {       <I><FONT COLOR="#B22222">//usually only one of these eventType objects, but let me know if you see more than one
</FONT></I>        <B><FONT COLOR="#228B22">bool</FONT></B> isMC = type.test(EventType::IS_SIMULATION);
        <B><FONT COLOR="#228B22">int</FONT></B> channelNumber = type.mc_channel_number();
    }</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
<h3><a name="IOV_specific_metadata"></a> IOV-specific metadata </h3>
To access the metadata in an IOV-specific manner (e.g. if you have a mixture of events in the file with different values of the metadata items... this is hard to tell, but wont usually be the case) then you can use:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#0000FF">CHECK</FONT></B>( retrieveMetadata(<B><FONT COLOR="#BC8F8F">&quot;/TagInfo&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;beam_energy&quot;</FONT></B>,beam_energy, IOVTime(runNumber,eventNumber), channel) ); </pre>
<!-- end SyntaxHighlightingPlugin -->
the <code>channel</code> is optional, and refers to cases where metadata is also indexed by a channel number (see the discussion in the section below). If you don't think this is the case, leave the channel number as "-1" and the method will use whatever first channel number it finds.
<p />
<p />
<h2><a name="How_to_create_new_metadata_and_o"></a> How to create new metadata and output it to a file </h2>
For many types of simple metadata, it is appropriate to use the IOVMetaDataContainer class to hold your metadata. This class is specifically designed to hold metadata that is  valid for an <strong>interval of validity</strong> (a range of run numbers, for example). The IOV in the simplest case is just 'all of time', and this is the case for much of the metadata shown by <code>checkMetaSG.py</code> (this command does not show what the IOV are for each metadata item, its actually just showing all the metadata items valid for the first event in the file).
<p />
If you want to add more metadata to your output file, the first thing to do is to create an IOVMetaDataContainer, and register it in the MetaDataStore, which is the StoreGate where output pool files look for their metadata when they are writing to disk. You can do this yourself, but the preferred method is to use the IOVDbMetaDataTool for this purpose, because it ensures that you don't overwrite any existing container. (n.b: you'll need to add <code>use <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/IOVDbMetaDataTools?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">IOVDbMetaDataTools</a></span> <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/IOVDbMetaDataTools?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">IOVDbMetaDataTools</a></span>-* Database</code> to your requirements file)...
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;IOVDbMetaDataTools/IIOVDbMetaDataTool.h&quot;</FONT></B>

ToolHandle&lt;IIOVDbMetaDataTool&gt; metaTool(<B><FONT COLOR="#BC8F8F">&quot;IOVDbMetaDataTool&quot;</FONT></B>);

<B><FONT COLOR="#0000FF">CHECK</FONT></B>( metaTool-&gt;registerFolder(<B><FONT COLOR="#BC8F8F">&quot;/MyMetaFolder&quot;</FONT></B>) ); <I><FONT COLOR="#B22222">//ensures the folder (represented by an IOVMetaDataContainer) exists in the MetaDataStore (where output POOL files will look for metadata)
</FONT></I></pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
The reason the method is called <code>registerFolder</code> is because IOVMetaDataContainer were originally designed to be used to store IOV data from the COOL databases, which are organized into folders. Each folder saved to the in-file metadata will have it's own IOVMetaDataContainer.
<p />
Then to add information to your container, you do:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#0000FF">CHECK</FONT></B>( metaTool-&gt;addPayload(<B><FONT COLOR="#BC8F8F">&quot;/MyMetaFolder&quot;</FONT></B>,myPayload) ); <I><FONT COLOR="#B22222">//ensures payload correctly inserted into IOVMetaDataContainer
</FONT></I></pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
where <code>myPayload</code> is of type <code>CondAttrListCollection</code>. These objects are usually what you get when you access information from COOL (covered elsewhere, e.g. on the <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/AthenaCodeSnippets?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">AthenaCodeSnippets</a></span> twiki page). So if you wanted to write out COOL conditions information as in-file metadata (saving on DB connections in future processing) you can simply use the <code>CondAttrListCollection</code> you get from COOL. But we'll assume you want to create your own.
<p />
A <code>CondAttrListCollection</code> is a collection of <code>CondAttrListCollection::AttributeList</code> objects, indexed by a channel number (an unsigned int). The interpretation of the channel number is entirely up to you, but if you don't need to have your metadata indexed like this, you can just have a single channel, by convention with channel number 0.
<p />
Below is an example of creating and populating such a collection.
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>CondAttrListCollection* myPayload = <B><FONT COLOR="#A020F0">new</FONT></B> CondAttrListCollection(true<I><FONT COLOR="#B22222">/*says we will specify IOV using runNumbers, not timestamps*/</FONT></I>);

<I><FONT COLOR="#B22222">/* this bit is optional, if you want to say it's valid only for a certain set of run numbers */</FONT></I>
  IOVTime myTimeStart(123<I><FONT COLOR="#B22222">/*run number example*/</FONT></I>,0<I><FONT COLOR="#B22222">/*eventNumber, usually just keep as zero*/</FONT></I>);
  IOVTime myTimeStop(124,0);
  myPayload-&gt;addNewStart(myTimeStart);
  myPayload-&gt;addNewStop(myTimeStop);
<I><FONT COLOR="#B22222">/* end of optional IOV specification */</FONT></I>
  
  <B><FONT COLOR="#5F9EA0">CondAttrListCollection</FONT></B>::AttributeList myAttrList;
  myAttrList.extend(<B><FONT COLOR="#BC8F8F">&quot;myString&quot;</FONT></B> <I><FONT COLOR="#B22222">/*property name*/</FONT></I>,<B><FONT COLOR="#BC8F8F">&quot;string&quot;</FONT></B> <I><FONT COLOR="#B22222">/*property type*/</FONT></I>);
  myAttrList.extend(<B><FONT COLOR="#BC8F8F">&quot;myInt&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;int&quot;</FONT></B>);
  myAttrList.extend(<B><FONT COLOR="#BC8F8F">&quot;myFloat&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;float&quot;</FONT></B>);
  myAttrList[<B><FONT COLOR="#BC8F8F">&quot;myString&quot;</FONT></B>].data&lt;std::string&gt;() = <B><FONT COLOR="#BC8F8F">&quot;myString&quot;</FONT></B>;
  myAttrList[<B><FONT COLOR="#BC8F8F">&quot;myInt&quot;</FONT></B>].data&lt;<B><FONT COLOR="#228B22">int</FONT></B>&gt;() = 23;
  myAttrList[<B><FONT COLOR="#BC8F8F">&quot;myFloat&quot;</FONT></B>].data&lt;<B><FONT COLOR="#228B22">float</FONT></B>&gt;() = 3.14;

  myPayload-&gt;add(0<I><FONT COLOR="#B22222">/*channel number*/</FONT></I>,myAttrList);</pre>
<!-- end SyntaxHighlightingPlugin -->
The property types allowed are all the basic C++ types, along with <code>string</code>. If you want to store a vector of objects, you should store it as a string, specifying the values through a python syntax:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>myAttrList.extend(<B><FONT COLOR="#BC8F8F">&quot;myStringVector&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;string&quot;</FONT></B>);myAttrList[<B><FONT COLOR="#BC8F8F">&quot;myStringVector&quot;</FONT></B>].data&lt;std::string&gt;() = <B><FONT COLOR="#BC8F8F">&quot;['apple','pear','lime']&quot;</FONT></B>
myAttrList.extend(<B><FONT COLOR="#BC8F8F">&quot;myFloatVector&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;string&quot;</FONT></B>);myAttrList[<B><FONT COLOR="#BC8F8F">&quot;myFloatVector&quot;</FONT></B>].data&lt;std::string&gt;() = <B><FONT COLOR="#BC8F8F">&quot;[2.1,3.2,-4.4]&quot;</FONT></B></pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
In a subsequent job, you could then read back these numbers with the <code>retrieveMetadata</code> method described <a class="twikiCurrentTopicLink twikiAnchorLink" href="/twiki/bin/view/AtlasProtected/AthAnalysisBase#ReadingMetaDataInCpp">above</a>, which can automatically parse the string into a vector, for example:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>std::vector&lt;std::string&gt; myStringVector;
<B><FONT COLOR="#0000FF">CHECK</FONT></B>( retrieveMetadata(<B><FONT COLOR="#BC8F8F">&quot;/MyMetaFolder&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;myStringVector&quot;</FONT></B>,myStringVector) );  <I><FONT COLOR="#B22222">//will read back {&quot;apple&quot;, &quot;pear&quot;, &quot;lime&quot;}
</FONT></I><B><FONT COLOR="#228B22">int</FONT></B> myInt;
<B><FONT COLOR="#0000FF">CHECK</FONT></B>( retrieveMetadata(<B><FONT COLOR="#BC8F8F">&quot;/MyMetaFolder&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;myInt&quot;</FONT></B>,myInt) ); <I><FONT COLOR="#B22222">//reads back '23'
</FONT></I></pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
Finally, remember when you write out your pool file you remember to add the metadata container through the <code>AddMetaDataItem</code> method in the joboptions. Or you can add all the IOVMetaDataContainers to the output pool file with:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>xaodStream.AddMetaDataItem( <B><FONT COLOR="#BC8F8F">&quot;IOVMetaDataContainer#*&quot;</FONT></B> )</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
<h2><a name="How_to_access_EventBookkeeper_in"></a> How to access <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/EventBookkeeper?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">EventBookkeeper</a></span> information in c++ (sum of event weights prior to skimming) </h2>
Easiest to setup your algorithm as <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/AthAnalysisAlgorithm?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">AthAnalysisAlgorithm</a></span> (change it from <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/AthAlgorithm?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">AthAlgorithm</a></span>, or do <code>cmt new_analysisalg <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/MyAlg?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">MyAlg</a></span></code> inside your package, to create a new algorithm with the required skeleton), which gives you a beginInputFile method that you can add the following to:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#228B22">const</FONT></B> xAOD::CutBookkeeperContainer* bks = 0;
      CHECK( inputMetaStore()-&gt;retrieve(bks, <B><FONT COLOR="#BC8F8F">&quot;CutBookkeepers&quot;</FONT></B>) );
      <B><FONT COLOR="#228B22">const</FONT></B> xAOD::CutBookkeeper* all = 0; <B><FONT COLOR="#228B22">int</FONT></B> maxCycle=-1; <I><FONT COLOR="#B22222">//need to find the max cycle where input stream is StreamAOD and the name is AllExecutedEvents
</FONT></I>      <B><FONT COLOR="#A020F0">for</FONT></B>(<B><FONT COLOR="#228B22">auto</FONT></B> cbk : *bks) { <B><FONT COLOR="#A020F0">if</FONT></B>(cbk-&gt;inputStream()==<B><FONT COLOR="#BC8F8F">&quot;StreamAOD&quot;</FONT></B> &amp;&amp; cbk-&gt;name()==<B><FONT COLOR="#BC8F8F">&quot;AllExecutedEvents&quot;</FONT></B> &amp;&amp; cbk-&gt;cycle()&gt;maxCycle) { maxCycle=cbk-&gt;cycle(); all = cbk; } }
      m_totalEvents += all-&gt;sumOfEventWeights(); <I><FONT COLOR="#B22222">//also have all-&gt;nAcceptedEvents() which is simple event count, and all-&gt;sumOfEventWeightsSquared()
</FONT></I></pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
where <code>m_totalEvents</code> is a variable you have defined to hold the sum of event weights. You could fill it to a histogram if you wanted.
<p />
If you aren't using the AthAnalysisAlgorithm as your base class, you will need to create a service handle to the input metadata store, e.g. like this:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>ServiceHandle&lt;StoreGateSvc&gt; inputMetaStore(<B><FONT COLOR="#BC8F8F">&quot;StoreGateSvc/InputMetaDataStore&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>);</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
and replace <code>inputMetaDataStore()</code> in the snippet above to read just <code>inputMetaDataStore</code>.
<p />
You'll need the include and use statement for <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/EventBookkeeperCollection?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">EventBookkeeperCollection</a></span>, which are:
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;xAODCutFlow/CutBookkeeperContainer.h&quot;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;xAODCutFlow/CutBookkeeper.h&quot;</FONT></B></pre>
<!-- end SyntaxHighlightingPlugin -->
and for requirements file (the third line is needed if you are now using <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/AthAnalysisAlgorithm?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">AthAnalysisAlgorithm</a></span>):
<pre>
use xAODCutFlow xAODCutFlow-&#42; Event/xAOD
use AthAnalysisBaseComps AthAnalysisBaseComps-&#42; Control 
</pre>
<p />
<h2><a name="How_to_print_the_sum_of_weights"></a> How to print the sum of weights for local files </h2>
A simple python example is given here - you would extend the <code>files</code> list with more files as you need:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#A020F0">import</FONT></B> ROOT
ROOT.xAOD.Init().isSuccess()
<B><FONT COLOR="#A020F0">import</FONT></B> os
files = [os.environ[<B><FONT COLOR="#BC8F8F">'ASG_TEST_FILE_MC'</FONT></B>]]
total = 0
<B><FONT COLOR="#A020F0">for</FONT></B> file <B><FONT COLOR="#A020F0">in</FONT></B> files:
    f = ROOT.TFile.Open(file)
    tree = ROOT.xAOD.MakeTransientMetaTree( f , <B><FONT COLOR="#BC8F8F">&quot;MetaData&quot;</FONT></B> )
    tree.GetEntry(0)
    cbks = tree.CutBookkeepers
    maxCycle = -1
    <B><FONT COLOR="#A020F0">for</FONT></B> cbk <B><FONT COLOR="#A020F0">in</FONT></B> cbks:
        <B><FONT COLOR="#A020F0">if</FONT></B> cbk.name() != <B><FONT COLOR="#BC8F8F">&quot;AllExecutedEvents&quot;</FONT></B>: <B><FONT COLOR="#A020F0">continue</FONT></B>
        <B><FONT COLOR="#A020F0">if</FONT></B> cbk.inputStream() != <B><FONT COLOR="#BC8F8F">&quot;StreamAOD&quot;</FONT></B>: <B><FONT COLOR="#A020F0">continue</FONT></B>
        <B><FONT COLOR="#A020F0">if</FONT></B> cbk.cycle() &gt; maxCycle:
            maxCycle = cbk.cycle()
            theCbk = cbk
    total += theCbk.sumOfEventWeights()

<B><FONT COLOR="#A020F0">print</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;Sum of Weights = %f &quot;</FONT></B> % total
ROOT.xAOD.ClearTransientTrees()</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
<p />
<h2><a name="How_to_use_the_TrigDecisionTool"></a> How to use the <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/TrigDecisionTool?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">TrigDecisionTool</a></span> </h2>
In your algorithm you do:
<p />
<pre>
requirements file:
  use TrigDecisionTool TrigDecisionTool-&#42; Trigger/TrigAnalysis
</pre>
<p />
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>alg header file:
  #include <B><FONT COLOR="#BC8F8F">&quot;TrigDecisionTool/TrigDecisionTool.h&quot;</FONT></B>
  ToolHandle&lt;Trig::TrigDecisionTool&gt; tdt;  <I><FONT COLOR="#B22222">//this is a data member
</FONT></I>
initialize method:
  tdt.setTypeAndName(<B><FONT COLOR="#BC8F8F">&quot;Trig::TrigDecisionTool/TrigDecisionTool&quot;</FONT></B>); <I><FONT COLOR="#B22222">//adheres to 'convention' that the main instance of TrigDecisionTool should be called 'TrigDecisionTool'
</FONT></I>  CHECK(tdt.retrieve()); <I><FONT COLOR="#B22222">//*MUST* retrieve the tool in initialize otherwise it gets into a bad state... this is a bug in tdt that should be fixed
</FONT></I>
execute method:
   <I><FONT COLOR="#B22222">//the following example prints a list of every trigger that fired in the event:
</FONT></I>   <B><FONT COLOR="#228B22">auto</FONT></B> allChains = tdt-&gt;getChainGroup(<B><FONT COLOR="#BC8F8F">&quot;.*&quot;</FONT></B>);
   <B><FONT COLOR="#5F9EA0">std</FONT></B>::cout &lt;&lt; <B><FONT COLOR="#BC8F8F">&quot;Triggers that passed : &quot;</FONT></B>;
   <B><FONT COLOR="#A020F0">for</FONT></B>(<B><FONT COLOR="#228B22">auto</FONT></B>&amp; trig : allChains-&gt;getListOfTriggers()) <B><FONT COLOR="#A020F0">if</FONT></B>(tdt-&gt;getChainGroup(trig)-&gt;isPassed()) std::cout &lt;&lt; trig &lt;&lt; <B><FONT COLOR="#BC8F8F">&quot;, &quot;</FONT></B>;
   <B><FONT COLOR="#5F9EA0">std</FONT></B>::cout &lt;&lt; std::endl;
   <I><FONT COLOR="#B22222">// here's how to test a specific trigger:
</FONT></I>   tdt-&gt;isPassed(<B><FONT COLOR="#BC8F8F">&quot;MYTRIGGER&quot;</FONT></B>);</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
<h2><a name="How_to_thin_an_output_container"></a> How to thin an output container </h2>
If you are outputing xAOD containers to an output file (i.e. via a <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/PoolRootStream?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">PoolRootStream</a></span>), you can 'thin' these containers, i.e. keep only a subset of the objects in them. To do this, you must first create a ThinningSvc instance, and connect it to your outputstream. In your joboptions, do:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>xaodStream = MSMgr.NewPoolRootStream( <B><FONT COLOR="#BC8F8F">&quot;StreamXAOD&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;xAOD.out.root&quot;</FONT></B> ) <I><FONT COLOR="#B22222">#suppose this is what your stream definition looked like
</FONT></I>
<B><FONT COLOR="#A020F0">from</FONT></B> AthenaServices.Configurables <B><FONT COLOR="#A020F0">import</FONT></B> ThinningSvc
svcMgr += ThinningSvc(<B><FONT COLOR="#BC8F8F">&quot;MyThinningSvc&quot;</FONT></B>,Streams = [<B><FONT COLOR="#BC8F8F">&quot;StreamXAOD&quot;</FONT></B>]) <I><FONT COLOR="#B22222">#connects your stream to the thinningSvc
</FONT></I></pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
Then in your algorithm, you need to get a handle on the thinningSvc, and pass it the container you want to thin, along with a mask (a vector of bools) that you want to use to select the objects to keep. The example below is to keep every other trackparticle in the GSFTrackParticles container:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;AthenaKernel/IThinningSvc.h&quot;</FONT></B> //remember to add AthenaKernel to your requirements file

...
   ServiceHandle&lt;IThinningSvc&gt; m_thinSvc(<B><FONT COLOR="#BC8F8F">&quot;MyThinningSvc&quot;</FONT></B>,name()); <I><FONT COLOR="#B22222">//probably make this a data member of the class, and even a declareProperty so you can set it in the joboptions
</FONT></I>
...
<I><FONT COLOR="#B22222">//Get the track collection
</FONT></I>  <B><FONT COLOR="#228B22">const</FONT></B> xAOD::TrackParticleContainer* tracks=0;
  CHECK( evtStore()-&gt;retrieve(tracks,<B><FONT COLOR="#BC8F8F">&quot;GSFTrackParticles&quot;</FONT></B>));
<I><FONT COLOR="#B22222">//create a mask
</FONT></I>  <B><FONT COLOR="#5F9EA0">std</FONT></B>::vector&lt;<B><FONT COLOR="#228B22">bool</FONT></B>&gt; mask(tracks-&gt;size(),false);
   <B><FONT COLOR="#A020F0">for</FONT></B>(<B><FONT COLOR="#228B22">int</FONT></B> i=0;i&lt;mask.size();i++) <B><FONT COLOR="#A020F0">if</FONT></B>(i%2==1) mask[i]=true; <I><FONT COLOR="#B22222">//keep every 'odd index' 
</FONT></I><I><FONT COLOR="#B22222">//do the thinning
</FONT></I>   CHECK( m_thinSvc-&gt;filter(*tracks,mask) );
</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
<h2><a name="How_to_get_the_provenance_of_an"></a> How to get the provenance of an event </h2>
All files in official datasets have a GUID that identifies them. It is possible to find out the GUID of the files an event comes from (RAW-&gt;ESD-&gt;AOD-&gt;DAOD) so that you can back-navigate (e.g. to do event picking on the grid, but bypassing the event index service). To list the GUID provenance of an event in a file, you can do:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;PersistentDataModel/DataHeader.h&quot;</FONT></B>

<B><FONT COLOR="#228B22">const</FONT></B> DataHeader* dh = 0;
<B><FONT COLOR="#0000FF">CHECK</FONT></B>( evtStore()-&gt;retrieve(dh) );
<B><FONT COLOR="#0000FF">for</FONT></B>(<B><FONT COLOR="#228B22">auto</FONT></B> itr = dh-&gt;beginProvenance(); itr != dh-&gt;endProvenance(); ++itr) {
  <B><FONT COLOR="#5F9EA0">std</FONT></B>::cout &lt;&lt; itr-&gt;getKey() &lt;&lt; <B><FONT COLOR="#BC8F8F">&quot; : &quot;</FONT></B> &lt;&lt; itr-&gt;getToken()-&gt;dbID().toString() &lt;&lt; std::endl;
}</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
This will print the provenance steps (key will be 'StreamAOD', 'StreamESD', etc etc) and the GUIDs of the corresponding files that event came from. If you pipe this to a text file along with the runNumber, eventNumber, and GUID, like this:
<p />
<pre>
&#60;runNumber&#62; &#60;eventNumber&#62; &#60;GUID&#62;
</pre>
<p />
You will then be able to 'pick' those events on the grid with: <code>pathena --eventPickEvtList myevents.txt --eventPickWithGUID</code> options (see the relevant pAthena instructions <a href="https://twiki.cern.ch/twiki/bin/view/AtlasComputing/EventIndexTutorial#RAW_to_RAW_event_picking_and_wra" target="_top">here</a>)
<p />
<p />
<h2><a name="How_to_output_trees_and_histogra"></a> How to output trees and histograms </h2>
There's nothing to stop you just creating TFile yourself and writing out the objects directly, but in athena we recommend you pass your objects to an output file via the THistSvc ...
<p />
The histogram service (THistSvc) is designed to handle the TFile creation and writing part of what you would have done by hand with ROOT. It is a good idea to use it too because when you submit jobs to the grid, pathena can automatically detect the output files of THistSvc, ensuring that they go into the output dataset. 
<p />
All you need to do is when you create your histograms and trees in the initialize() step, do not create the associated TFile, instead you create a ServiceHandle for the THistSvc, retrieve the service, and then register the histograms and trees. Like this:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>ServiceHandle&lt;ITHistSvc&gt; histSvc(<B><FONT COLOR="#BC8F8F">&quot;THistSvc&quot;</FONT></B>,name()); 
<B><FONT COLOR="#0000FF">CHECK</FONT></B>( histSvc.retrieve() );
myHist = <B><FONT COLOR="#A020F0">new</FONT></B> TH1D(<B><FONT COLOR="#BC8F8F">&quot;myHist&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;myHist&quot;</FONT></B>,10,0,10);
anotherHist = <B><FONT COLOR="#A020F0">new</FONT></B> TH1D(<B><FONT COLOR="#BC8F8F">&quot;anotherHist&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;anotherHist&quot;</FONT></B>,10,0,10);
histSvc-&gt;regHist(<B><FONT COLOR="#BC8F8F">&quot;/MYSTREAM/myHist&quot;</FONT></B>,myHist).ignore(); <I><FONT COLOR="#B22222">//or check the statuscode
</FONT></I><B><FONT COLOR="#0000FF">CHECK</FONT></B>( histSvc-&gt;regHist(<B><FONT COLOR="#BC8F8F">&quot;/MYSTREAM/MyDirectory/anotherHist&quot;</FONT></B>,anotherHist) ); <I><FONT COLOR="#B22222">//will put anotherHist in a TDirectory called MyDirectory
</FONT></I>myTree = <B><FONT COLOR="#A020F0">new</FONT></B> TTree(<B><FONT COLOR="#BC8F8F">&quot;myTree&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;myTree&quot;</FONT></B>);
<B><FONT COLOR="#0000FF">CHECK</FONT></B>( histSvc-&gt;regTree(<B><FONT COLOR="#BC8F8F">&quot;/ANOTHERSTREAM/myTree&quot;</FONT></B>,myTree) );</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
This naturally needs the include statements for ITHistSvc, which are (put at top of the file):
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;GaudiKernel/ITHistSvc.h&quot;</FONT></B></pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
You should already have a use statement in your requirements file for GaudiKernel, so there's nothing to add there.
<p />
The important part of the above code is the first parameter of <code>regHist</code> and <code>regTree</code>, which takes the form: "/&LT;streamName&GT;/&LT;objectName&GT;" where &LT;objectName&GT; is the name of the thing you are registering, as you want it to appear in the output file (can include a path, then THistSvc puts the object inside the relevant TDirectory), and &LT;streamName&GT; is a unique label for the file you want to write to, which becomes relevant when you configurable the THistSvc in the joboptions:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>svcMgr += CfgMgr.THistSvc()
svcMgr.THistSvc.Output += [<B><FONT COLOR="#BC8F8F">&quot;MYSTREAM DATAFILE='myfile.root' OPT='RECREATE'&quot;</FONT></B>]
svcMgr.THistSvc.Output += [<B><FONT COLOR="#BC8F8F">&quot;ANOTHERSTREAM DATAFILE='anotherfile.root' OPT='RECREATE'&quot;</FONT></B>]</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
<div class="twistyPlugin twikiMakeVisibleInline">  <span id="twistyIdAtlasProtectedAthAnalysisBase5show" class="twistyStartHide twistyTrigger twikiUnvisited twistyInited0"><a href="#"><span class="twikiLinkLabel twikiUnvisited">Personal advertisement for tools aiding TTree creation...</span><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" border="0" alt="" /></a> </span> <span id="twistyIdAtlasProtectedAthAnalysisBase5hide" class="twistyStartHide twistyTrigger twikiUnvisited twistyHidden twistyInited0"><a href="#"><span class="twikiLinkLabel twikiUnvisited">Hide</span><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleclose-small.gif" border="0" alt="" /></a> </span>  </div><!--/twistyPlugin twikiMakeVisibleInline--> <div class="twistyPlugin"><div id="twistyIdAtlasProtectedAthAnalysisBase5toggle" class="twikiHelp twistyStartHide twistyContent twikiMakeHidden twistyInited0">
While not an official tool, I have developed and maintain a suite of tools that can help you create your custom ntuples. Please email me if you are interested, but to give you an idea of how they would work... you no longer create the TTree object, instead you just create a 'CamObject' and decorate it during the <code>execute()</code> with things you want to write out, then 'apply' a writer service to that object: e.g.
<pre>
#include &#34;AnalysisCamEvent/CamEvent.h&#34; //put this at the top of the file. 
//also add to the requirements file: use AnalysisCamEvent AnalysisCamEvent-&#42; PhysicsAnalysis/AnalysisCam

CamObject outObject;
outObject.set(&#34;myInt&#34;) &#61; 5;
outObject.set(&#34;myDouble&#34;) &#61; 7.5;
outObject.set(&#34;myVector&#34;) &#61; someStdVector;
outObject.applyService(&#34;CamWriter/myWriter&#34;);
</pre>
And in the joboption, you have configured an instance of that writer, to tell it which THistSvc stream it should write to:
<pre>
svcMgr +&#61; CfgMgr.THistSvc()
svcMgr.THistSvc.Output +&#61; &#91;&#34;MYSTREAM DATAFILE&#61;&#39;myfile.root&#39; OPT&#61;&#39;RECREATE&#39;&#34;]
svcMgr +&#61; CfgMgr.CamWriter(&#34;myWriter&#34;,TreeName&#61;&#34;myTree&#34;,StreamName&#61;&#34;MYSTREAM&#34;)</pre>
This would create a tree with 3 branches: one integer, one double, and one vector (assuming <code>someStdVector</code> in the above example is an std::vector&LT; &GT; type). You'll need to checkout the package to get these objects (you use the trunk version of the code):
<pre>
cd $TestArea
cmt co PhysicsAnalysis/AnalysisCam/AnalysisCamEvent
</pre>
</div></div> <!--/twistyPlugin-->
<p />
<h3><a name="Outputting_trees_and_histograms"></a> Outputting trees and histograms using AthHistogramming </h3>
<p />
The C++ side of using the THistSvc can be significantly simplified by using the <a href="http://acode-browser2.usatlas.bnl.gov/lxr-AthAna/source/atlas/Control/AthenaBaseComps/AthenaBaseComps/AthHistogramming.h#0030" target="_blank">AthHistogramming<img alt="" border="0" height="12" src="/twiki/pub/TWiki/TWikiDocGraphics/external-link.gif" width="13" /></a> class. This class provides several helper methods that do most of the legwork for you when interacting with the THistSvc. If your algorithm class inherits from <a href="http://acode-browser2.usatlas.bnl.gov/lxr-AthAna/source/atlas/Control/AthenaBaseComps/AthenaBaseComps/AthHistogramAlgorithm.h#0024" target="_blank">AthHistogramAlgorithm<img alt="" border="0" height="12" src="/twiki/pub/TWiki/TWikiDocGraphics/external-link.gif" width="13" /></a> or <a href="http://acode-browser2.usatlas.bnl.gov/lxr-AthAna/source/atlas/Control/AthAnalysisBaseComps/AthAnalysisBaseComps/AthAnalysisAlgorithm.h#0030" target="_blank">AthAnalysisAlgorithm<img alt="" border="0" height="12" src="/twiki/pub/TWiki/TWikiDocGraphics/external-link.gif" width="13" /></a> then you will have access to these methods already. In order to do the same as above (using the raw THistSvc) you could instead do
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#0000FF">CHECK</FONT></B>( book(TH1D(<B><FONT COLOR="#BC8F8F">&quot;myHist&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;myHist&quot;</FONT></B>, 10, 0, 10) ) );
<B><FONT COLOR="#0000FF">CHECK</FONT></B>( book(TH1D(<B><FONT COLOR="#BC8F8F">&quot;anotherHist&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;anotherHist&quot;</FONT></B>, 10, 0, 10) ) );
<B><FONT COLOR="#0000FF">CHECK</FONT></B>( book(TTree(<B><FONT COLOR="#BC8F8F">&quot;myTree&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;myTree&quot;</FONT></B>) ) );</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
<p />
Then later on during your code (say during your execute function) you can retrieve those histograms using
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>TH1* myHist =  hist(<B><FONT COLOR="#BC8F8F">&quot;myHist&quot;</FONT></B>);
TH1* anotherHist = hist(<B><FONT COLOR="#BC8F8F">&quot;anotherHist&quot;</FONT></B>);
TTree* myTree = tree(<B><FONT COLOR="#BC8F8F">&quot;myTree&quot;</FONT></B>);</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
(TH2s or TH3s should be retrieved with hist2d and hist3d respectively, TGraphs can be retrieved with the graph member function).
Note that these functions will return a null pointer if they fail (for example if the histogram you requested doesn't exist in the THistSvc) so before interacting with them you should check if the pointer is valid or you will get a segfault.
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#0000FF">if</FONT></B> (!myHist) {
  ATH_MSG_ERROR(<B><FONT COLOR="#BC8F8F">&quot;Failed to retrieve histogram 'myHist'&quot;</FONT></B>);
  <B><FONT COLOR="#A020F0">return</FONT></B> StatusCode::FAILURE;
}</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
In order to use these properties you will need to set the 'RootStreamName' property of your algorithm (this is the same as 'MYSTREAM' in the above example). If you want all of your histograms/trees to go into a particular folder in that stream you can also set the 'RootDirName' property. These properties are outlined on <a href="http://acode-browser2.usatlas.bnl.gov/lxr-AthAna/source/atlas/Control/AthenaBaseComps/src/AthHistogramAlgorithm.cxx#0026" target="_blank">this<img alt="" border="0" height="12" src="/twiki/pub/TWiki/TWikiDocGraphics/external-link.gif" width="13" /></a> page.
<p />
Once you've done this you still need to set up the THistSvc in the job options as before.
<p />
<p />
<h2><a name="How_to_configure_a_tool_set_prop"></a> How to configure a tool (set properties) from C++ </h2>
If you are ok with setting a property <strong>after</strong> the tool's <code>initialize()</code> method would have been called, you can simply dynamic cast your tool to the AlgTool class (or any derivated class, e.g. asg::AsgTool or AthAlgTool), and call setProperty on it ...  (expert note: this is better than IProperty interface, which would require things be converted to strings before setting):
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>AlgTool* myTool = dynamic_cast&lt;AlgTool*&gt;(&amp;*toolHandle);
<B><FONT COLOR="#0000FF">CHECK</FONT></B>( myTool-&gt;setProperty(<B><FONT COLOR="#BC8F8F">&quot;BoolProp&quot;</FONT></B>,true) ); <I><FONT COLOR="#B22222">//setting a bool
</FONT></I><B><FONT COLOR="#0000FF">CHECK</FONT></B>( myTool-&gt;setProperty(<B><FONT COLOR="#BC8F8F">&quot;StringProp&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;hello&quot;</FONT></B>) ); <I><FONT COLOR="#B22222">//setting a string
</FONT></I><B><FONT COLOR="#0000FF">CHECK</FONT></B>( myTool-&gt;setProperty(<B><FONT COLOR="#BC8F8F">&quot;IntProp&quot;</FONT></B>,1) ); <I><FONT COLOR="#B22222">//setting an int
</FONT></I><B><FONT COLOR="#0000FF">CHECK</FONT></B>( myTool-&gt;setProperty(<B><FONT COLOR="#BC8F8F">&quot;FloatProp&quot;</FONT></B>,1.5) ); <I><FONT COLOR="#B22222">//setting a float
</FONT></I><B><FONT COLOR="#0000FF">CHECK</FONT></B>( myTool-&gt;setProperty( <B><FONT COLOR="#BC8F8F">&quot;MyVector&quot;</FONT></B>, {<B><FONT COLOR="#BC8F8F">&quot;a&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;b&quot;</FONT></B>} ); <I><FONT COLOR="#B22222">//setting a vector of strings
</FONT></I><B><FONT COLOR="#0000FF">CHECK</FONT></B>( myTool-&gt;setProperty( <B><FONT COLOR="#BC8F8F">&quot;MyNumbers&quot;</FONT></B>, {1.0,2.0} ); <I><FONT COLOR="#B22222">//setting a vector of doubles
</FONT></I></pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
However, if you want to ensure a property is set <strong>before</strong> the <code>initialize()</code> is called, you need to put the property in the joboption catalogue before the first attempt to retrieve the tool ... e.g:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>ServiceHandle&lt;IJobOptionsSvc&gt; josvc(<B><FONT COLOR="#BC8F8F">&quot;JobOptionsSvc&quot;</FONT></B>,name());
ToolHandle&lt;ITool&gt; tool(<B><FONT COLOR="#BC8F8F">&quot;ToolType/MyTool&quot;</FONT></B>);
<B><FONT COLOR="#0000FF">CHECK</FONT></B>( josvc-&gt;addPropertyToCatalogue(tool.parentName()+<B><FONT COLOR="#BC8F8F">&quot;.&quot;</FONT></B>+tool.name(), StringProperty(<B><FONT COLOR="#BC8F8F">&quot;StringProp&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;myString&quot;</FONT></B>) ) );
<B><FONT COLOR="#0000FF">CHECK</FONT></B>( josvc-&gt;addPropertyToCatalogue(tool.parentName()+<B><FONT COLOR="#BC8F8F">&quot;.&quot;</FONT></B>+tool.name(), IntegerProperty(<B><FONT COLOR="#BC8F8F">&quot;IntProp&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;1&quot;</FONT></B>) ) );
 CHECK( tool.retrieve() ); <I><FONT COLOR="#B22222">//initialize() of tool gets called here, picks up property values from the catalogue
</FONT></I></pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
A templated method for achieving the above is provided for you in the <code>AthAnalysisBaseComps</code> package:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;AthAnalysisBaseComps/AthAnalysisHelper.h&quot;</FONT></B>
...
ToolHandle&lt;IInterface&gt; toolHandle(<B><FONT COLOR="#BC8F8F">&quot;ToolType/MyTool&quot;</FONT></B>);
<B><FONT COLOR="#0000FF">AthAnalysisHelper::setProperty</FONT></B>(toolHandle, <B><FONT COLOR="#BC8F8F">&quot;Property&quot;</FONT></B>, value);</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
Alternatively, if your tool will be internal to the alg/tool you are coding up, you could use the code in the following section ....
<p />
<h2><a name="How_to_instantiate_an_AsgTool_us"></a> How to instantiate an AsgTool using the factory methods </h2>
The cmt releases work by factory methods: this means you are not supposed to instantiate tools directly yourself, i.e. you should not be calling the constructor. Instead, you should be using the factory methods to create a tool, and you should interact with the tool via an interface class. 
<p />
The equivalent of:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;MyPackage/IMyTool.h&quot;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;MyPackage/MyTool.h&quot;</FONT></B>
IMyTool* m_tool = <B><FONT COLOR="#A020F0">new</FONT></B> MyTool(<B><FONT COLOR="#BC8F8F">&quot;MyToolName&quot;</FONT></B>);
<B><FONT COLOR="#0000FF">asg::setProperty</FONT></B>( m_tool, <B><FONT COLOR="#BC8F8F">&quot;whatever&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;blah&quot;</FONT></B>);
m_tool-&gt;initialize();</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
in a cmt release is:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;MyPackage/IMyTool.h&quot;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;AthAnalysisBaseComps/AthAnalysisHelper.h&quot;</FONT></B>
IMyTool* m_tool = AAH::createTool&lt;IMyTool&gt;(<B><FONT COLOR="#BC8F8F">&quot;MyTool/MyToolName&quot;</FONT></B>,0 <I><FONT COLOR="#B22222">/*this is the 'parent', leave it 0 for a parentless tool, or set to 'this' if you want it to inherit e.g. OutputLevel from the parent*/</FONT></I>);
<B><FONT COLOR="#0000FF">asg::setProperty</FONT></B>( m_tool, <B><FONT COLOR="#BC8F8F">&quot;whatever&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;blah&quot;</FONT></B> );
m_tool-&gt;initialize();</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
However, it should be noted that currently tools created with the above <code>createTool</code> method are not registered with the <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/ToolSvc?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">ToolSvc</a></span>, and therefore are not discoverable by other tools. So in fact the <strong>best</strong> way to create a tool is with a <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/ToolHandle?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">ToolHandle</a></span>, like this:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;MyPackage/IMyTool.h&quot;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;AthAnalysisBaseComps/AthAnalysisHelper.h&quot;</FONT></B>
ToolHandle&lt;IMyTool&gt; m_tool(<B><FONT COLOR="#BC8F8F">&quot;MyTool/MyToolName&quot;</FONT></B>);
<B><FONT COLOR="#0000FF">AAH::setProperty</FONT></B>( m_tool, <B><FONT COLOR="#BC8F8F">&quot;whatever&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;blah&quot;</FONT></B> );
m_tool.retrieve(); <I><FONT COLOR="#B22222">//initializes the tool
</FONT></I></pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
<h2><a name="How_to_filter_by_GRL"></a> How to filter by GRL </h2>
For this you configure an instance of the GoodRunsListSelectionTool, then pass that to an instance of the GRLSelectorAlg. Add the alg to the filter sequencer if you want it to actually filter the events (stop processing of subsequent algorithms if event fails, moving onto next event):
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>ToolSvc += CfgMgr.GoodRunsListSelectionTool(<B><FONT COLOR="#BC8F8F">&quot;GRLTool&quot;</FONT></B>,GoodRunsListVec=[<B><FONT COLOR="#BC8F8F">&quot;my.grl.xml&quot;</FONT></B>])
filterSeq = CfgMgr.AthSequencer(<B><FONT COLOR="#BC8F8F">&quot;AthFilterSeq&quot;</FONT></B>)
filterSeq += CfgMgr.GRLSelectorAlg(Tool=ToolSvc.GRLTool)</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
<p />
<h2><a name="How_to_ask_for_the_total_number"></a> How to ask for the total number of events being processed in a job </h2>
The total number of events is something known to the EventSelector of the job, which implements the <a href="http://acode-browser.usatlas.bnl.gov/lxr/source/atlas/Control/AthenaKernel/AthenaKernel/ICollectionSize.h" target="_blank">ICollectionSize<img alt="" border="0" height="12" src="/twiki/pub/TWiki/TWikiDocGraphics/external-link.gif" width="13" /></a> interface that has a <code>size</code> method for exactly this piece of information. This means you need to obtain a handle to the EventSelector using this interface, and call the <code>size</code> method, like this:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;GaudiKernel/IEvtSelector.h&quot;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;AthenaKernel/ICollectionSize.h&quot;</FONT></B>

ServiceHandle&lt;IEvtSelector&gt; evtSelector(<B><FONT COLOR="#BC8F8F">&quot;EventSelector&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>); <I><FONT COLOR="#B22222">//the first arg is the instance name of the service you want to retrieve. second arg is somewhat arbitrary
</FONT></I>dynamic_cast&lt;ICollectionSize&amp;&gt;(*evtSelector).size(); <I><FONT COLOR="#B22222">//this is the number of events in the job
</FONT></I></pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
Note that at the moment I could not retrieve with the <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/ICollectionSize?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">ICollectionSize</a></span> interface directly, so used the <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/IEvtSelector?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">IEvtSelector</a></span> interface instead, just to retrieve the selector <img src="https://twiki.cern.ch/twiki/pub/TWiki/SmiliesPlugin/frown.gif" alt="frown" title="frown" border="0" />
<p />
<h2><a name="How_to_use_MCTruthClassifier"></a> How to use <a class="twikiLink" href="/twiki/bin/view/AtlasProtected/MCTruthClassifier">MCTruthClassifier</a> </h2>
<!-- 
checkout the following packages (all trunk versions for now):
<pre>
cmt co Generators/GeneratorObjects
cmt co Reconstruction/PFlow/PFlowUtils
cmt co Reconstruction/RecoTools/ParticlesInConeTools
cmt co PhysicsAnalysis/MCTruthClassifier
</pre>
Compile the whole lot. -->
You can use the <a class="twikiLink" href="/twiki/bin/view/AtlasProtected/MCTruthClassifier">MCTruthClassifier</a> as a usual tool with a <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/ToolHandle?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">ToolHandle</a></span>, using the <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/IMCTruthClassifier?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">IMCTruthClassifier</a></span> interface from the package, for example:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>ToolHandle&lt;IMCTruthClassifier&gt; m_truthClassifier(<B><FONT COLOR="#BC8F8F">&quot;MCTruthClassifier&quot;</FONT></B>);
<B><FONT COLOR="#228B22">const</FONT></B> xAOD::TruthParticleContainer* truthParticles = 0;
<B><FONT COLOR="#0000FF">CHECK</FONT></B>( evtStore()-&gt;retrieve(truthParticles,<B><FONT COLOR="#BC8F8F">&quot;TruthParticle&quot;</FONT></B>) );
<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">const</FONT></B> MCTruthPartClassifier::ParticleDef partDef;
<B><FONT COLOR="#0000FF">for</FONT></B>(<B><FONT COLOR="#228B22">auto</FONT></B> p : truthParticles) {
  <B><FONT COLOR="#228B22">auto</FONT></B> res = m_truthClassifier-&gt;particleTruthClassifier( p );
  ATH_MSG_INFO(<B><FONT COLOR="#BC8F8F">&quot;Type = &quot;</FONT></B> &lt;&lt; partDef.sParticleType[res.first] &lt;&lt; <B><FONT COLOR="#BC8F8F">&quot; Origin = &quot;</FONT></B> &lt;&lt; partDef.sParticleOrigin[res.second]);
}</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
<!--
The one thing you will need is <code>PDGTABLE.MeV</code>, a file that isn't shipped properly with the releases at the moment (will be fixed for next release: 2.1.32 and 2.3.12) .. but for now, you can get it from setting up any full athena release and doing: <code>get_files -data</code> <code>PDGTABLE.MeV</code>. Copy the file into the working directory. This will allow PartPropSvc to be initialized correctly (the <a class="twikiLink" href="/twiki/bin/view/AtlasProtected/MCTruthClassifier">MCTruthClassifier</a> uses this svc). -->
<p />
<h2><a name="How_to_read_EVNT_files_with_AthA"></a> How to read EVNT files with <a class="twikiCurrentTopicLink twikiLink" href="/twiki/bin/view/AtlasProtected/AthAnalysisBase">AthAnalysisBase</a> </h2>
It just works <img src="https://twiki.cern.ch/twiki/pub/TWiki/SmiliesPlugin/smile.gif" alt="smile" title="smile" border="0" /> ... <a class="twikiCurrentTopicLink twikiLink" href="/twiki/bin/view/AtlasProtected/AthAnalysisBase">AthAnalysisBase</a> 2.3.16 onwards can read EVNT files. You can provess the HepMCCollection directly, or if you wanted to run some xAOD truth-based code on an EVNT file, you can convert the EVNT into xAOD format 'on the fly' by adding the necessary convertors at the top of your algsequence:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>athAlgSeq += CfgMgr.xAODMaker__xAODTruthCnvAlg(AODContainerName=<B><FONT COLOR="#BC8F8F">&quot;GEN_EVENT&quot;</FONT></B>)
athAlgSeq += CfgMgr.xAODMaker__EventInfoCnvAlg()</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
This gives you something that is similar to, but not quite the same as, the TRUTH0 derivation. There are a few extra things to add, such as lepton dressing, but those tools should also be usable in <a class="twikiCurrentTopicLink twikiLink" href="/twiki/bin/view/AtlasProtected/AthAnalysisBase">AthAnalysisBase</a>. I just haven't investigated fully the setup of everything yet. But please, be my guest!
<p />
<h2><a name="How_to_read_HepMC_files_with_Ath"></a> How to read <a class="twikiLink" href="/twiki/bin/view/AtlasProtected/HepMC">HepMC</a> files with <a class="twikiCurrentTopicLink twikiLink" href="/twiki/bin/view/AtlasProtected/AthAnalysisBase">AthAnalysisBase</a> </h2>
You need a couple of extra packages on top of the release:
<p />
<pre>
cmt co Generators/GeneratorModules
cmt co Generators/TruthIO
cmt find&#95;packages
cmt compile
</pre>
<p />
Then you can read the input file like this (it will give you a GEN_EVENT <code>McEventCollection</code> object in the storegate):
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>athAlgSeq = CfgMgr.AthSequencer(<B><FONT COLOR="#BC8F8F">&quot;AthAlgSeq&quot;</FONT></B>)
athAlgSeq += CfgMgr.HepMCReadFromFile(InputFile=<B><FONT COLOR="#BC8F8F">&quot;my.input.hepmc&quot;</FONT></B>) <I><FONT COLOR="#B22222">#please make sure this is the first algorithm in the sequence!
</FONT></I></pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
You could then add the EVNT-&gt;xAOD converter algorithm (see section above) if you wanted to analyse your <a class="twikiLink" href="/twiki/bin/view/AtlasProtected/HepMC">HepMC</a> file with xAOD EDM code.
<p />
For the above, you may want to setup a basic <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/EventSelector?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">EventSelector</a></span>, which can create the <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/EventInfo?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">EventInfo</a></span> object for you. This is how:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>theApp.ExtSvc += [<B><FONT COLOR="#BC8F8F">&quot;McEventSelector/EventSelector&quot;</FONT></B>]  <I><FONT COLOR="#B22222">#will create this service when theApp is setup
</FONT></I>theApp.EvtSel = <B><FONT COLOR="#BC8F8F">&quot;EventSelector&quot;</FONT></B> <I><FONT COLOR="#B22222">#will use EventSelector as our selector
</FONT></I>svcMgr.EventPersistencySvc.CnvServices += [<B><FONT COLOR="#BC8F8F">&quot;McCnvSvc&quot;</FONT></B>]    <I><FONT COLOR="#B22222">#loads a simple converter for creating EventInfo objects
</FONT></I></pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
You will need to checkout an extra package for this as well:
<p />
<pre>
cmt co Generators/McEventSelector
</pre>
<p />
<h2><a name="How_to_get_the_bunch_train_posit"></a> How to get the bunch train position of an event (using the <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/TrigBunchCrossingTool?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">TrigBunchCrossingTool</a></span>) </h2>
You must be using a release that has the <code>Database/ConnectionManagement/AtlasAuthentication</code> package in it. If you are not, check out that package and compile it, including running <code>source setup.sh</code> from the cmt directory to ensure the <code>CORAL_DBLOOKUP_PATH</code> environment variable is set. Release 2.3.35 and onwards has all this done for you automatically
<p />
Joboptions look like this:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><I><FONT COLOR="#B22222">#if not already done, you should determine if you are running on MC or Data:
</FONT></I><B><FONT COLOR="#A020F0">from</FONT></B> PyUtils <B><FONT COLOR="#A020F0">import</FONT></B> AthFile
af = AthFile.fopen(svcMgr.EventSelector.InputCollections[0]) 
isMC = <B><FONT COLOR="#BC8F8F">'IS_SIMULATION'</FONT></B> <B><FONT COLOR="#A020F0">in</FONT></B> af.fileinfos[<B><FONT COLOR="#BC8F8F">'evt_type'</FONT></B>]

<I><FONT COLOR="#B22222">#must set the globalflags appropriately so that the correct conditions database is queried when you extract the bunch train
</FONT></I><B><FONT COLOR="#A020F0">from</FONT></B> AthenaCommon.GlobalFlags <B><FONT COLOR="#A020F0">import</FONT></B> globalflags
globalflags.DataSource = <B><FONT COLOR="#BC8F8F">'geant4'</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> isMC <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#BC8F8F">'data'</FONT></B> 
globalflags.DatabaseInstance = <B><FONT COLOR="#BC8F8F">'CONDBR2'</FONT></B> 
<B><FONT COLOR="#A020F0">from</FONT></B> TrigBunchCrossingTool.BunchCrossingTool <B><FONT COLOR="#A020F0">import</FONT></B> BunchCrossingTool
<B><FONT COLOR="#A020F0">if</FONT></B> isMC: ToolSvc += BunchCrossingTool( <B><FONT COLOR="#BC8F8F">&quot;MC&quot;</FONT></B> )
<B><FONT COLOR="#A020F0">else</FONT></B>: ToolSvc += BunchCrossingTool( <B><FONT COLOR="#BC8F8F">&quot;LHC&quot;</FONT></B> )</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
c++ code looks like this (please incorporate into your algorithm appropriately):
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;TrigAnalysisInterfaces/IBunchCrossingTool.h&quot;</FONT></B>

ToolHandle&lt;Trig::IBunchCrossingTool&gt; m_bcTool;
<B><FONT COLOR="#0000FF">if</FONT></B>(isMC) m_bcTool.setTypeAndName(<B><FONT COLOR="#BC8F8F">&quot;Trig::MCBunchCrossingTool/BunchCrossingTool&quot;</FONT></B>);
<B><FONT COLOR="#A020F0">else</FONT></B> m_bcTool.setTypeAndName(<B><FONT COLOR="#BC8F8F">&quot;Trig::LHCBunchCrossingTool/BunchCrossingTool&quot;</FONT></B>);
<B><FONT COLOR="#228B22">const</FONT></B> xAOD::EventInfo* ei = ...;
<B><FONT COLOR="#0000FF">if</FONT></B>( m_bcTool-&gt;distanceFromFront( ei-&gt;bcid() ) == 0 ) {
 <I><FONT COLOR="#B22222">// This is the first bunch in a train.
</FONT></I>} </pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
Note that the type of the tool you connect the toolhandle to will depend on whether you are running on mc or data (because the method in the joboption sets up one tool type or the other). An alternative to the above is to pass the toolhandle as a property of your algorithm, then you wont have to check if its mc or data (with an <code>isMC</code> flag).
<p />
requirements file needs this use statement:
<pre>
use TrigAnalysisInterfaces TrigAnalysisInterfaces-&#42; Trigger/TrigAnalysis
</pre>
<p />
<p />
<h2><a name="How_to_read_two_files_concurrent"></a> How to read two files concurrently in <a class="twikiCurrentTopicLink twikiLink" href="/twiki/bin/view/AtlasProtected/AthAnalysisBase">AthAnalysisBase</a> </h2>
To do this, we have to change the ApplicationMgr's EventLoop from the standard AthenaEventLoopMgr (which only takes one list of input files) into the PileUpEventLoopMgr, which is designed to take input from multiple files at the same time. In 2.3.16 you need to checkout and compile two additional packages:
<p />
<pre>
cmt co Control/PileUpTools
cmt co -r PileUpComps-00-14-00 Control/PileUpComps
</pre>
<p />
Then here's an example joboptions:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#A020F0">import</FONT></B> AthenaPoolCnvSvc.ReadAthenaPool
svcMgr.EventSelector.InputCollections = [<B><FONT COLOR="#BC8F8F">&quot;first.pool.root&quot;</FONT></B>]

theApp.EventLoop = <B><FONT COLOR="#BC8F8F">&quot;PileUpEventLoopMgr&quot;</FONT></B> <I><FONT COLOR="#B22222">#use the PileUpEventLoopMgr to read multiple files in sync ....
</FONT></I>
<I><FONT COLOR="#B22222">#create a BkgStreamCache with a new EventSelector for the second input file
</FONT></I>svcMgr += CfgMgr.EventSelectorAthenaPool(<B><FONT COLOR="#BC8F8F">&quot;SecondFileEventSelector&quot;</FONT></B>)
bkgCache = CfgMgr.BkgStreamsCache(<B><FONT COLOR="#BC8F8F">&quot;SecondFileCache&quot;</FONT></B>,IgnoreBeamInt=True,IgnoreBeamLumi=True,
               CollDistribution=<B><FONT COLOR="#BC8F8F">&quot;Fixed&quot;</FONT></B>,ReadDownscaleFactor=1,CollPerXing=1,
            EventSelector=svcMgr.SecondFileEventSelector )
svcMgr += CfgMgr.PileUpEventLoopMgr(<B><FONT COLOR="#BC8F8F">&quot;PileUpEventLoopMgr&quot;</FONT></B>, firstXing=0,lastXing=0, bkgCaches=[bkgCache])

<I><FONT COLOR="#B22222">#set inputcollections for second file
</FONT></I>svcMgr.SecondFileEventSelector.InputCollections = [<B><FONT COLOR="#BC8F8F">&quot;second.file.root&quot;</FONT></B>]


<I><FONT COLOR="#B22222">#the storegate that is created/used by the bkgstream is called 'BkgEvent_0_SG'
</FONT></I><I><FONT COLOR="#B22222">#the primary storegate becomes OriginalEvent_SG
</FONT></I>athAlgSeq = CfgMgr.AthSequencer(<B><FONT COLOR="#BC8F8F">&quot;AthAlgSeq&quot;</FONT></B>)
athAlgSeq += CfgMgr.MyAlg(EvtStore=<B><FONT COLOR="#BC8F8F">&quot;OriginalEvent_SG&quot;</FONT></B>,SecondStoreGate=<B><FONT COLOR="#BC8F8F">&quot;BkgEvent_0_SG&quot;</FONT></B>)</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
Note that you get two storegates now: an "OriginalEvent_SG" storegate and a "BkgEvent_0_SG" storegate (note: in future I might be able to improve the <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/PileupEventLoopMgr?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">PileupEventLoopMgr</a></span> setup to have more control over this storegate naming, but that's what it is for now). Then in my example algorithm I have told the default evtstore (specified with the EvtStore property) to point to the first of those new storegates, and I've created a new property in the alg to specify the second storegate. The alg code looks like this:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#5F9EA0">header</FONT></B>:
<I><FONT COLOR="#B22222">//add a data member like this:
</FONT></I>   ServiceHandle&lt;StoreGateSvc&gt; m_evtStore2;

<B><FONT COLOR="#5F9EA0">cxx</FONT></B>:

<B><FONT COLOR="#0000FF">MyAlg::MyAlg</FONT></B>( <B><FONT COLOR="#228B22">const</FONT></B> std::string&amp; name, ISvcLocator* pSvcLocator ) : AthAlgorithm( name, pSvcLocator ),
   m_evtStore2(<B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>,name) {
   declareProperty(<B><FONT COLOR="#BC8F8F">&quot;SecondStoreGate&quot;</FONT></B>,m_evtStore2);
}
StatusCode <B><FONT COLOR="#0000FF">MyAlg::execute</FONT></B>() {  
   <I><FONT COLOR="#B22222">//here's an example of getting the EventInfo of the first file and the second file:
</FONT></I>   <B><FONT COLOR="#228B22">const</FONT></B> xAOD::EventInfo* evtInfo1 = 0; CHECK( evtStore()-&gt;retrieve( evtInfo1 ) );
   <B><FONT COLOR="#228B22">const</FONT></B> xAOD::EventInfo* evtInfo2 = 0; CHECK( m_evtStore2-&gt;retrieve( evtInfo2 ) ); 
   ATH_MSG_INFO(<B><FONT COLOR="#BC8F8F">&quot;EventNumber #1 = &quot;</FONT></B> &lt;&lt; evtInfo1-&gt;eventNumber() &lt;&lt; <B><FONT COLOR="#BC8F8F">&quot; and EventNumber #2 = &quot;</FONT></B> &lt;&lt; evtInfo2-&gt;eventNumber() );

  <B><FONT COLOR="#A020F0">return</FONT></B> StatusCode::SUCCESS;
}</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
Note that if you want to use any tools, they will look at the default storegate (name is "StoreGateSvc") so you have to redirect them to look at the specific storegate in question, or otherwise use the ActiveStore mechanism, which I haven't actually tested myself in <a class="twikiCurrentTopicLink twikiLink" href="/twiki/bin/view/AtlasProtected/AthAnalysisBase">AthAnalysisBase</a>.
<p />
<h2><a name="How_to_check_the_luminosity_cove"></a> How to check the luminosity covered by a collection of data xAOD (i.e. Luminosity bookkeeping) </h2>
Luminosity metadata in xAOD is simply the list of lumiblocks covered by that file. Lumiblocks are either <ul>
<li> <b>Complete</b>: All events of the lumiblock are covered by the file
</li> <li> <b>Incomplete</b>: Some events of the lumiblock are covered by the file, the other events should be in another file
</li> <li> <b>Suspect</b>: Indicates something went wrong with the luminosity bookkeeping (for MC15a and b, almost all lumiblocks have ended up marked suspect)
</li></ul> 
<p />
If you want to check what luminosity a given xAOD file corresponds to, first you need a lumicalc file corresponding to all the data you hope you have run over. These are available centrally (<a href="http://atlas.web.cern.ch/Atlas/GROUPS/DATABASE/GroupData/GoodRunsLists" target="_blank">go here and look for lumicalc files<img alt="" border="0" height="12" src="/twiki/pub/TWiki/TWikiDocGraphics/external-link.gif" width="13" /></a>) or you can make your own if you know how. Then you can see what luminosity from that lumicalc file is covered by your given files by doing, e.g:
<p />
<pre>
getLumi.exe /afs/cern.ch/atlas/www/GROUPS/DATABASE/GroupData/GoodRunsLists/data15&#95;13TeV/20160606/physics&#95;25ns&#95;20.7.lumicalc.OflLumi-13TeV-004.root my.xaod.root
</pre>
<p />
You'll get a report of how much luminosity is complete, incomplete, or suspect. If your file doesn't cover the entirety of the luminosity held in your lumicalc file, it will also tell you there is <i>missing luminosity</i>. You can rerun <code>getLumi.exe</code> with the <code>-m</code> option to see the list of run numbers from your lumicalc file that contain missing luminosity.
<p />
The purpose of <code>getLumi.exe</code> is to help you confirm you have run over all the data covered by your lumicalc file. You want to end up seeing that all your lumicalc file's luminosity is in the <i>complete</i> category. The tool helps you identify which runs you still need to process events from in order to recover missing or incomplete luminosity.
<p />
If you want to propagate luminosity information to your output histogram files, from 2.4.25 analysis release onwards you just need to add the following to your joboptions (only needed when running on data):
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>svcMgr.MetaDataSvc.MetaDataTools += [ <B><FONT COLOR="#BC8F8F">&quot;LumiBlockMetaDataTool&quot;</FONT></B> ]
theApp.CreateSvc += [<B><FONT COLOR="#BC8F8F">'xAOD2NtupLumiSvc'</FONT></B>]</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
<p />
<h2><a name="How_to_read_a_folder_from_the_co"></a> How to read a folder from the conditions database </h2>
Much more detail on conditions database access is covered in my lesson at <a href="https://twiki.cern.ch/twiki/bin/view/Main/AthenaCodeSnippets#A_lesson_in_conditions_databases" target="_top">https://twiki.cern.ch/twiki/bin/view/Main/AthenaCodeSnippets#A_lesson_in_conditions_databases</a>
<p />
Suppose we wanted to connect to folder '/TRIGGER/L1Calo/V1/Calibration/Physics/PprChanCalib' in database 'COOLONL_TRIGGER'. I would add the following to my joboptions:
<p />
<pre>
#configure flags used by conddb
from AthenaCommon.GlobalFlags import globalflags
globalflags.DataSource &#61; &#39;data&#39;  # or set this to &#39;geant4&#39; if running on MC! ...
globalflags.DatabaseInstance &#61; &#39;CONDBR2&#39; # e.g. if you want run 2 data, set to COMP200 if you want run1. This is completely ignored in MC.

#configure folders to access
from IOVDbSvc.CondDB import conddb
conddb.addFolder(&#39;TRIGGER&#39;,&#34;/TRIGGER/L1Calo/V1/Calibration/Physics/PprChanCalib&#34;)
</pre>
<p />
In the job, the 'detector store' (accessed with <code>detStore()</code> in your c++ algorithm) you will get:
<p />
<pre>
Found 2 proxies for ClassID 1238547719 (CondAttrListCollection): 
...
 flags: (  valid,   locked,  reset) --- data:          0 --- key: /TRIGGER/L1Calo/V1/Calibration/Physics/PprChanCalib
...
</pre>
<p />
In this specific case, this is a multi-channel folder, where each channel is a different trigger tower. You can access the attribute list with:
<p />
<pre>
const CondAttrListCollection&#42; attrCollection &#61; 0; CHECK( detStore()-&#62;retrieve( attrCollection, &#34;/TRIGGER/L1Calo/V1/Calibration/Physics/PprChanCalib&#34;) );
CondAttrListCollection::AttributeList&#38; attributes &#61; attrCollection-&#62;attributeList( coolId ); //get attribute list for tower indentified by &#39;coolId&#39;
attributes&#91;&#34;FirCoeff1&#34;].data&#60;int&#62;() ; //example of reading the &#39;FirCoeff1&#39; attribute in the attribute list
</pre>
<p />
<p />
<h2><a name="How_to_read_the_truth_weight_nam"></a> How to read the truth weight names from non-xAOD metadata </h2>
First verify you have the weight names in the metadata by running <code>checkMetaSG.py</code> on the file and confirming you see a line like:
<p />
<pre>
        /Generation/Parameters &#124; HepMCWeightNames          &#124; dict    &#124; {&#39; nnlops-mtmb-11-H2 &#39;: 120, &#39; pdfset&#61; 260045 &#39;:  ....
</pre>
<p />
Then following the <a class="twikiCurrentTopicLink twikiAnchorLink" href="/twiki/bin/view/AtlasProtected/AthAnalysisBase#ReadingMetaDataInCpp">instructions above</a>, we want to retrieve a map of string to int from the metadata, below is an example of doing it with the <code>POOL::TEvent</code> object in a standalone job:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><I><FONT COLOR="#B22222">//this is the preamble in a standalone executable
</FONT></I>POOL::TEvent evt(POOL::TEvent::kClassAccess); <I><FONT COLOR="#B22222">//fast xAOD reading, instead of kPOOLAccess which is slowest (but is default)
</FONT></I>evt.readFrom(<B><FONT COLOR="#BC8F8F">&quot;my.xaod.root&quot;</FONT></B>);
evt.getEntry(0);

<I><FONT COLOR="#B22222">//here's the real code for this problem
</FONT></I>std::map&lt;std::string, <B><FONT COLOR="#228B22">int</FONT></B>&gt; weightNamesMap;
<B><FONT COLOR="#0000FF">AAH::retrieveMetadata</FONT></B>( <B><FONT COLOR="#BC8F8F">&quot;/Generation/Parameters&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;HepMCWeightNames&quot;</FONT></B> , weightNamesMap, evt.inputMetaStore() );
<I><FONT COLOR="#B22222">//convert map into ordered vector
</FONT></I>std::vector&lt;std::string&gt; weightNames(weightNamesMap.size());
<B><FONT COLOR="#0000FF">for</FONT></B>(<B><FONT COLOR="#228B22">auto</FONT></B>&amp; w : weightNamesMap) weightNames[w.second] = w.first;
<I><FONT COLOR="#B22222">//Now weightNames is a vector of weightnames in the correct order.
</FONT></I></pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
<h2><a name="How_to_catch_all_ROOT_errors_and"></a> How to catch all ROOT errors and ensure they stop event processing </h2>
If you are worried that ROOT errors are going unnoticed in your jobs, you can use the AthROOTErrorHandlerSvc to catch these. 
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#A020F0">import</FONT></B> ROOT
svcMgr += CfgMgr.AthROOTErrorHandlerSvc(CatchLevel=ROOT.kError)
theApp.CreateSvc += [<B><FONT COLOR="#BC8F8F">&quot;AthROOTErrorHandlerSvc&quot;</FONT></B>]</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
If you only want to catch messages from certain specifc sources, you can add them like this:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>svcMgr.AthROOTErrorHandlerSvc.ThrowSources = {<B><FONT COLOR="#BC8F8F">&quot;TFile::ReadBuffer&quot;</FONT></B>:ROOT.kError,<B><FONT COLOR="#BC8F8F">&quot;TBranch::GetBasket&quot;</FONT></B>:ROOT.kError}</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
This will catch all error messages (or higher) from these two sources.
<p />
<h1><a name="Testing_and_Debugging"></a> Testing and Debugging </h1>
<h2><a name="How_to_check_contents_of_an_xAOD"></a> How to check contents of an xAOD </h2>
<pre style="background: #e0ebf6;">
checkSG.py /afs/cern.ch/atlas/project/PAT/data/xAOD/mc12&#95;8TeV.105200.McAtNloJimmy&#95;CT10&#95;ttbar&#95;LeptonFilter.AOD.19.0.X&#95;rel&#95;4.pool.root
</pre>
This will tell you to the types of object in the xAOD (first column), and the keys (second column) that should be used to retrieve the object from the storegate. 
<p />
<pre style="background: #e0ebf6;">
checkMetaSG.py /afs/cern.ch/atlas/project/PAT/data/xAOD/mc12&#95;8TeV.105200.McAtNloJimmy&#95;CT10&#95;ttbar&#95;LeptonFilter.AOD.19.0.X&#95;rel&#95;4.pool.root
</pre>
This will tell you what types of metadata are available in the xAOD, including the value of the metadata items. Search this twiki page for examples of accessing metadata (can be done in both joboptions and in c++ algorithms).
<p />
<h2><a name="How_to_check_size_disk_usage_of"></a> How to check size (disk usage) of xAOD containers in a file </h2>
<pre style="background: #e0ebf6;">
checkxAOD.py myfile.pool.root
</pre>
or
<pre style="background: #e0ebf6;">
checkFile.py myfile.pool.root
</pre>
<p />
<h2><a name="How_to_add_processing_time_stati"></a> How to add processing time statistics to your job </h2>
You can use the <code>ChronoStatSvc</code> to monitor time spent in various parts of your job. In all athena jobs you will see messages at the end of the event loop from this svc, e.g. something as simple as:
<p />
<pre>
&#42;&#42;&#42;&#42;&#42;Chrono&#42;&#42;&#42;&#42;&#42;     INFO &#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;
&#42;&#42;&#42;&#42;&#42;Chrono&#42;&#42;&#42;&#42;&#42;     INFO  The Final CPU consumption ( Chrono ) Table (ordered)
&#42;&#42;&#42;&#42;&#42;Chrono&#42;&#42;&#42;&#42;&#42;     INFO &#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;
AthenaSealSvc::...   INFO Time User   : Tot&#61;    8 &#91;ms]                                             #&#61;  1
ChronoStatSvc        INFO Time User   : Tot&#61; 12.0  &#91;s]                                             #&#61;  1
&#42;&#42;&#42;&#42;&#42;Chrono&#42;&#42;&#42;&#42;&#42;     INFO &#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;
</pre>
<p />
This is reporting the <b>CPU Time</b>, which is pretty independent of disk access issues, but when it comes to analysis you are often interested in the actual wall clock time, which <code>ChronoStatSvc</code> calls the <b>Elapsed Time</b>. To display this, add the following to your joboptions:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>svcMgr.ChronoStatSvc.PrintEllapsedTime=True <I><FONT COLOR="#B22222">#show the wall clock time
</FONT></I></pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
If you rerun you will get a second table:
<p />
<pre>
&#42;&#42;&#42;&#42;&#42;Chrono&#42;&#42;&#42;&#42;&#42;     INFO &#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;
AthenaSealSvc::...   INFO TimeElapsed: Tot&#61;   10 &#91;ms]                                             #&#61;  1
ChronoStatSvc        INFO TimeElapsed: Tot&#61; 12.9  &#91;s]                                             #&#61;  1
&#42;&#42;&#42;&#42;&#42;Chrono&#42;&#42;&#42;&#42;&#42;     INFO &#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;
</pre>
<p />
This is the wall clock time of your job. 
<p />
<h3><a name="Time_spent_in_each_algorithm"></a> Time spent in each algorithm </h3>
Now you might want to enable logging of how much time is spent in each algorithm of your job. One way to do this is by adding the <code>ChronoAuditor</code> to the <code>AuditorSvc</code> ... the <code>ChronoAuditor</code> starts and stops the <code>ChronoStatSvc</code> as it is signalled by each algorithm that it is starting and stopping execution (Auditors are things that can 'monitor' such activity):
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>svcMgr.AuditorSvc += CfgMgr.ChronoAuditor() <I><FONT COLOR="#B22222">#monitor calls to functions in components
</FONT></I>theApp.AuditAlgorithms = True <I><FONT COLOR="#B22222">#enable auditors for algorithms
</FONT></I></pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
Note that at this point you might want to <a href="https://twiki.cern.ch/twiki/bin/viewauth/AtlasProtected/AthAnalysisBase#How_to_change_the_format_of_the" target="_top">increase the space for displaying algorithm names</a> in the log file.
<p />
<h3><a name="Time_spent_in_functions_of_algor"></a> Time spent in functions of algorithms or tools </h3>
If you want timing information at the sub-algorithm level (or on calls to tool methods, for example), you will need to interact with the <code>ChronoStatSvc</code> yourself. Thankfully all algorithms and tools have a built-in method called <code>chronoStatService()</code> that gives you a pointer to the service. So I can time a function call (or any other code execution) with:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#0000FF">chronoStatService</FONT></B>()-&gt;chronoStart( <B><FONT COLOR="#BC8F8F">&quot;myLabel&quot;</FONT></B> );
<B><FONT COLOR="#0000FF">myMethod</FONT></B>();
moreCode....
<B><FONT COLOR="#0000FF">chronoStatService</FONT></B>()-&gt;chronoStop( <B><FONT COLOR="#BC8F8F">&quot;myLabel&quot;</FONT></B> );</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
This will make a row appear in the table at the end of the job with the label of your choice.
<p />
<h3><a name="Time_spent_in_I_O_POOL"></a> Time spent in I/O (POOL) </h3>
You can see some basic information about the main EventLoop by doing:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>svcMgr.AthenaEventLoopMgr.UseDetailChronoStat=True</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
This will add four numbers to your ChronoStatSvc output, for example:
<p />
<pre>
EventLoopMgr&#95;ex...   INFO TimeElapsed: Tot&#61;  145 &#91;ms] Ave/Min/Max&#61; 28.9(+- 5.86)/   24/   89 &#91;us] #&#61;4999
EventLoopMgr&#95;po...   INFO TimeElapsed: Tot&#61; 1.29  &#91;s] Ave/Min/Max&#61;  258(+- 45.2)/  141/  625 &#91;us] #&#61;4999
EventLoopMgr&#95;pr...   INFO TimeElapsed: Tot&#61; 13.1  &#91;s] Ave/Min/Max&#61; 2.62(+-0.496)/  1.6/ 4.52 &#91;ms] #&#61;4999
EventLoopMgr         INFO TimeElapsed: Tot&#61; 14.6  &#91;s] Ave/Min/Max&#61; 2.91(+-0.521)/ 1.78/ 5.21 &#91;ms] #&#61;4999
</pre>
<p />
All numbers exclude time spent on the first event. The different numbers are: <ul>
<li> <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/EventLoopMgr?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">EventLoopMgr</a></span>: Time spent in total on the eventloop
</li> <li> <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/EventLoopMgr?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">EventLoopMgr</a></span>_preexec: Time spent with basic <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/DataHeader?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">DataHeader</a></span> reading. If this is a significant part of your total eventloop, your job is POOL-limited. We are working to improve this
</li> <li> <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/EventLoopMgr?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">EventLoopMgr</a></span>_postexec: This is usually time spent cleaning up the storegate before the start of the next event.
</li> <li> <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/EventLoopMgr?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">EventLoopMgr</a></span>_execute: This is the actual time spent executing code put in the algsequence
</li></ul> 
<p />
<p />
The POOL mechanism can provide details on time spent reading and writing each part of your input and output files by adding:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>svcMgr.AthenaPoolCnvSvc.UseDetailChronoStat=True <I><FONT COLOR="#B22222">#show details about I/O performance
</FONT></I></pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
For each object read, you should focus on the line beginning with <code>cObj_</code>, this is the time spent reading that object. If most of the bottom of your table is dominated by I/O lines like these, then your job is I/O-limited.
<p />
<p />
<h2><a name="How_to_assess_performance_using"></a> How to assess performance using built-in monitoring </h2>
Athena comes with built-in performance monitoring features to help you assess the speed of your jobs and identify bottlenecks. The first thing you are probably interested in is "what is the actual processing speed of my job?". This can be very system-dependent, and depends on what sort of disk the data you run on is kept, but it's still a number we are often interested in. Run your job with the following option:
<p />
<pre>
athena --pmon&#61;sdmon jobOptions.py
</pre>
<p />
This enables the 'semi-detailed monitoring'. You can read all about this information at the <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/PerfMonSD?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">PerfMonSD</a></span> twiki page, but the numbers you are interested in are in the <code>special</code> section and the <code>evt</code> section. First, the <code>special</code> section, which shows (among other things):
<p />
<pre>
PMonSD &#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61; special info &#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;
PMonSD          n      cpu     wall     vmem   malloc component
PMonSD &#91;---] 10000        4       10        -        - evtloop&#95;time
PMonSD &#91;---]    1     6756     7327        -        - overhead&#95;time
</pre>
<p />
This tells you that for a 10k event job, 10ms of wall-time is spent per event (i.e. processing speed of 100Hz), with a cpu time (less environment-sensitive) of 4ms (i.e. 250Hz). The overhead is what time was spent in the initialization and finalization of your job (in this case, ~7 seconds of wall time to start the job). You can then identify the bottleneck algorithms by looking at the <code>evt</code> section, e.g:
<pre>
PMonSD &#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61; step evt &#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;
PMonSD          n    cpu    max&#64;evt    vmem    max&#64;evt  malloc    max&#64;evt  component
PMonSD &#91;evt] 9999      0     10&#64;183       0      0&#64;0        18    217&#64;8000 MyPackageAlg
PMonSD &#91;evt] 9999      0     10&#64;647       0      0&#64;0         0      0&#64;0    AthMasterSeq
PMonSD &#91;evt] 9999      0     10&#64;2657      0      0&#64;0         0      0&#64;0    AthAlgSeq
PMonSD &#91;evt] 9999      0     10&#64;1446      0      0&#64;0         0      0&#64;0    xAODMaker::EventInfoCnvAlg
PMonSD &#91;evt] 9999      0     10&#64;9815      0      0&#64;0         0      0&#64;0    AthRegSeq
PMonSD &#91;evt] 9999      0      0&#64;0         0      0&#64;0         0      0&#64;0    AthOutSeq
PMonSD &#91;evt] 9999      0                  0                 18             &#91;total&#95;for&#95;6&#95;comps]
</pre>
This tells you how much cpu time is spent, on average, in each algrotihm. It also tells you the maximum cpu time, and memory consumptions (in kB). In this case, it is not telling us very much, because it is saying that none of the algorithms are taking significant time (i.e. none at limiting you to below 1kHz). This means that the 250Hz limit is being imposed by the read-speed of the POOL mechanism. This is the current (as of November 2015) limit on processing a primary xAOD. The limit on <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/DxAOD?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">DxAOD</a></span> is much-improved: there we see speeds in excess of 1kHz:
<p />
<pre>
PMonSD &#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61; special info &#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;
PMonSD          n      cpu     wall     vmem   malloc component
PMonSD &#91;---] 10000        1        1        -        - evtloop&#95;time
</pre>
<p />
Running on an EVNT file is even faster. 
<p />
<p />
<h2><a name="How_to_assess_performance_us_AN1"></a> How to assess performance using <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/GPerfTools?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">GPerfTools</a></span> CPUProfiler </h2>
These instructions are mainly taken from <a href="https://twiki.cern.ch/twiki/bin/view/AtlasComputing/OptimisingCode" target="_top">OptimisingCode</a>.
<p />
Then you can run your joboptions with 'gathena' instead of 'athena':
<pre>
gathena --profilerMode eventLoop --profilerInitEvent 15 --profilerOutput my.athena.profile yourJobOptions.py
</pre>
Produces <code>my.athena.profile</code> file, it starts the profiling after 15 events - you can change the number above to change when it starts.
Then you can do:
<pre>aprof.py my.athena.profile myAthenaProfile.pdf
</pre>
to make a nice pdf with a graph in it... see the 'Node information' section at <a href="http://gperftools.googlecode.com/svn/trunk/doc/cpuprofile.html" target="_blank">http://gperftools.googlecode.com/svn/trunk/doc/cpuprofile.html<img alt="" border="0" height="12" src="/twiki/pub/TWiki/TWikiDocGraphics/external-link.gif" width="13" /></a> to interpret.
<p />
If you prefer to use kcachegrind you can make a callgrind file out of this profile file and open it in kcachegrind like this:
<pre>
pprof --callgrind `which python` my.athena.profile &#62; callgrind.out.GProfile
kcachegrind callgrind.out.GProfile
</pre>
<p />
<h2><a name="How_to_debug_an_exception_with_G"></a> How to debug an exception with GDB </h2>
A common problem encountered when working with xAOD is the exception thrown about retrieving non-existent data items, for example:
<p />
<pre>
MyAlg               FATAL  Standard std::exception is caught 
MyAlg               ERROR SG::ExcBadAuxVar: Attempt to retrieve nonexistent aux data item `::blah&#39; (118).
</pre>
<p />
Sometimes it isn't obvious what is causing this - it might be one of the CP tools that you called that is causing it! To help you determine where the error is actually coming from you can start the GDB debugger, like this:
<p />
<pre>
athena --debug&#61;exec myJoboptions.py
</pre>
<p />
You'll reach the gdb prompt after a short while, at which point you tell gdb to catch any throws and then continue with the execution (which it will do until the throw is caught):
<p />
<pre>
(gdb) catch throw
Catchpoint 1 (throw)
(gdb) continue
</pre>
<p />
The program will return to the gdb prompt at the moment the exception is thrown. You then want to see the backtrace of this exception, so you know where the exception came from. Type:
<p />
<pre>
(gdb) backtrace
</pre>
<p />
You want to look for whatever occurs <strong>after</strong> the lines that say:
<p />
<pre>
#2  0x00007fb2026a3a24 in SG::AuxDataTraits&#60;int&#62;::const&#95;reference&#95;type SG::AuxElement::auxdata&#60;int&#62;(std::basic&#95;string&#60;char, std::char&#95;traits&#60;char&#62;, std::allocator&#60;char&#62; &#62; const&#38;) const ()
    at /cvmfs/atlas.cern.ch/repo/sw/software/AthAnalysisBase/x86&#95;64-slc6-gcc48-opt/2.2.6/AthAnalysisBase/2.2.6/InstallArea/include/AthContainers/AthContainers/AuxVectorData.icc:399
</pre>
<p />
The next thing (in this case it will be labeled <code>#3</code>) is what actually caused the exception to be thrown. 
<p />
If it's in locally checked out and compiled code, you'll get a line number e.g. <code>#3&nbsp; 0x00007fb20269e36d in <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/MyAlg?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">MyAlg</a></span>::execute() () at ../src/MyAlg.cxx:35</code>
<br>If the exception is thrown by a CP tool you haven't checked out, you just get a path to the library (i.e. /something/something/something/libSomePackage.so). At this point you could checkout the 'SomePackage' package and recompile it then rerun and it will help you find out which exact line the problem occurred in! But a quicker way would be to setup the release from the afs builds area: the version of the release in this area has all the debug symbols in it. You do this like this:
<p />
<pre>
asetup AthAnalysisBase,2.3.23,builds
</pre>
<p />
If you then recompile your testarea against that version of the project, you will have all debug symbols when you run gdb (although it will run slower since it's AFS, which is slower than CVMFS). 
<p />
To quit gdb type <code>quit</code>. Google gdb for other commands you can do, you can do lots of things to help debug your code (e.g. inspect values of variables during execution)!
<p />
<h2><a name="How_to_debug_an_abort_with_gdb"></a> How to debug an abort with gdb </h2>
If instead of an exception you get a straight abort, e.g:
<pre>
StatusCodeSvc       FATAL Unchecked StatusCode in ElectronSelector::passCuts(xAOD::Electron&#95;v1 const&#42;, xAOD::Vertex&#95;v1 const&#42;) from lib /var/clus/usera/will/testareas/xAHDev/InstallArea/x86&#95;64-slc6-gcc49-opt/lib/libxAODAnaHelpersLib.so
Aborted
</pre>
<p />
You can follow the above instructions for catching an exception, except you don't need to catch anything, just continue the program once you reach the gdb prompt. When the program aborts, you're back at gdb prompt where you can <code>bt</code> to show where the abort was fired from.
<p />
<h2><a name="How_to_investigate_a_potential_m"></a> How to investigate a potential memory leak </h2>
In this section I describe how to use three tool for looking for memory leaks. Valgrind is the most thorough of these but is also the slowest and most complicated to understand in terms of log file output. I recommend running either of Hephaestus or pmon to start to get an idea of where leaks may be coming from.
<p />
<h3><a name="Using_Hephaestus"></a> Using Hephaestus </h3>
This is built into athena via the --leak-check option. Rerun your job (not too many events though, it will slow down) with:
<pre>athena --leak-check&#61;execute myJobOptions.py</pre>
You might want to save the output to a log file too. At the end of the job you'll get printout of stack traces of all the memory leaks. Look for ones containing your algorithm, e.g:
<pre>
2 leaks (total 80 bytes), originating in:
boost::any::any&#60;std::function&#60;bool (CamObject&#38;)&#62; &#62;(std::function&#60;bool (CamObject&#38;)&#62; const&#38;) (40 bytes)
   0x7f76fcb19785 boost::any::any&#60;std::function&#60;bool (CamObject&#38;)&#62; &#62;(std::function&#60;bool (CamObject&#38;)&#62; const&#38;)
   0x7f76fcb18705 boost::any&#38; boost::any::operator&#61;&#60;std::function&#60;bool (CamObject&#38;)&#62; &#62;(std::function&#60;bool (CamObject&#38;)&#62; const&#38;)
   0x7f76fcb18dcb void CamObject::operator&#61;&#60;std::function&#60;bool (CamObject&#38;)&#62; &#62;(std::function&#60;bool (CamObject&#38;)&#62; const&#38;&#38;)
   0x7f76fcb0f103 CamEvent::CamEvent()
   0x7f76fcd90c75 MyAlg::execute()
   0x7f76fcb2a7c5 CamAlgorithm::sysExecute()
   0x7f76fd043ac0 AthSequencer::execute()
   0x7f7702ecf591 Algorithm::sysExecute()
   0x7f76fd043ac0 AthSequencer::execute()
</pre>
This is actually indicative of me creating an instance of a CamEvent (hence the call to the constructor) and then not deleting the CamEvent (it's not important what a CamEvent is). I.e. in my execute method I had:
<pre>
CamEvent&#42; evt &#61; new CamEvent;
</pre> and forgot to write <code>delete evt;</code>. It happened twice (2 leaks) because in this example I only executed on 2 events for the test job. It's a good idea to look for leaks that scale with the number of events you process.
<p />
<h3><a name="Using_Performance_Monitoring_pmo"></a> Using Performance Monitoring (pmon) </h3>
pmon is fast, but it doesn't seem to be that reliable at determining if you have a leak. It's ok if the leak is really bad (leaking 100kb per event), and works best if you run over a lot of events perhaps 500 or 1000 events ... it doesn't really slow your program down so that is ok.
<p />
If you think you have a memory leak, run your job full performance monitoring switched on, like so:
<pre>
athena --pmon&#61;fullmon myJobOptions.py
</pre>
You'll get quite a bit more output for the logs, but the thing to take a quick look at is right at the end of the job, where you might see something like:
<pre>
Py:PerfMonSvc        INFO vmem-leak estimation: (nevts&#61;100)
Py:PerfMonSvc        INFO   first-evt vmem:   714.348 Mb
Py:PerfMonSvc        INFO   10th -evt vmem:   717.957 Mb
Py:PerfMonSvc        INFO   last -evt vmem:   752.332 Mb
Py:PerfMonSvc        INFO   evt  2-20 fitted vmem-slope (19 points):   400.5 kb/evt
Py:PerfMonSvc        INFO   evt 21-50 fitted vmem-slope (30 points):   392.5 kb/evt
Py:PerfMonSvc        INFO   evt 51+   fitted vmem-slope (50 points):   392.1 kb/evt
</pre>
This is telling me that it my 100 event test job, it looks like I was leaking about 400kb per event. (The first three numbers are the state of virtual memory after the first event, 10th event, and last event respectively. The final three numbers try to do a linear slope fit to estimate the leak per event). If you look back up in the event loop you might see things like:
<pre>
PerfMonSvc:    INFO &#91;evt:  93] cpu&#61;   0.000 ms vmem&#61; 750.039 Mb dvmem&#61;   0.379 Mb alloc&#61; +84 -103  406.000 kb  &#61;&#62; &#91;/evt/PerfMonSlice]
</pre>
(you'll see others as well but you're interested in the ones that start with <code>[evt:</code> since those indicate memory leak during the event loop, which is really bad.
Basically, if you see anything other than fitted vmom-slope being less than 0.1kb/evt (even that is bad!) you really should investigate further... so move on to Valgrind...
<p />
<h3><a name="Using_Valgrind"></a> Using Valgrind </h3>
Valgrind is the most thorough way to look for memory leaks, but it is also the program that gives you the most confusing output - mainly because quite a few parts of the event loop, ROOT, and xAOD EDM, leak small amounts of memory. But here are best instructions of how to use it if you suspect a memory leak in a specific package. 
<p />
<!--
1. <b>I dont think this is needed any more, I need to check:</b> Turn on debug symbols for that package. I assume you have the package locally, so open the requirements file and at the bottom of it just add:
<pre>
private
macro cppdebugflags &#39;$(cppdebugflags&#95;s)&#39;
macro&#95;remove componentshr&#95;linkopts &#34;-Wl,-s&#34;
</pre>
Then do:
<pre>
make bin clean
make
</pre>
to remake the library but with the debugging symbols turned on. These symbols will help valgrind tell you exactly which lines in the code are leaking memory (assuming its coming from this package!). <b>I need to check if this is necessary, as I think you get debug symbols normally on a local compile anyway!</b>
-->
1. Re-execute your test job like this:
<pre>
valgrind --leak-check&#61;yes --trace-children&#61;yes --smc-check&#61;all  --suppressions&#61;$ROOTSYS/etc/valgrind-root.supp --suppressions&#61;$ROOTSYS/etc/valgrind-root-python.supp `which athena.py` --stdcmalloc jobOptions.py 2&#62;&#38;1 &#124; tee valgrind&#95;memcheck.log
</pre>
The above will run the <b>memcheck</b> tool of valgrind (this is the default tool of valgrind, there are other tools that can be chosen with --tool=<toolname> , e.g. massif or addrcheck, although I haven't tried these myself). The <code>leak-check</code> yes option forces memcheck to report the individual memory leaks. The <code>trace-children</code> option is necessary to get memcheck to look for leaks in the subprocesses that athena launches (the main event loop is in fact a subprocess. If you dont use this option then you wont get any memcheck running on your code). <code>smc-check</code> is needed in ROOT6 (see https//its.cern.ch/jira/browse/ATEAM-170). The <code>--suppressions</code> are to suppress known memory leaks coming from ROOT and PyROOT. The <code>--stdcmalloc</code> option is an option we have added to the athena command to enable to the standard memory allocator, which valgrind I guess works better with than the default that is used in athena (tcmalloc). We pipe that output (both the stdout and stderr) to the log file <code>valgrid_memcheck.log</code> use the <code>tee</code> program. Note that the last part of the command:
<pre>
`which athena.py` --stdcmalloc jobOptions.py
</pre>
is equivalent to doing:
<pre>
athena --stdcmalloc jobOptions.py
</pre>
And you can use the above command on any executable. 
<b>Note you can also add the --error-limit=no</b>
<p />
You can actually avoid having to trace the children (which will speed up your execution and declutter your log) if you do:
<p />
<pre>
export MYATHENA&#61;`which athena.py`
export MYPYTHON&#61;`which python`
valgrind --leak-check&#61;yes --smc-check&#61;all  --suppressions&#61;$ROOTSYS/etc/valgrind-root.supp --suppressions&#61;$ROOTSYS/etc/valgrind-root-python.supp $MYPYTHON -tt $MYATHENA --stdcmalloc jobOptions.py 2&#62;&#38;1 &#124; tee valgrind&#95;memcheck.log
</pre>
<p />
2. Once your job has finished (it will take a lot longer to run and complete, you will see your job's usual output interspersed with messages from valgrind about when things have gone wrong. It will seem like it's hanging even at the end of the run, just let it complete), open up <code>valgrind_memcheck.log</code> and the best thing is to search for the word 'definitely'. Basically the file contains information about each <b>definite</b> and <b>possible</b> (see valgrind manual for definition of the difference) memory leak. The former is much worse than the latter. As you go through the occurances of this word you'll see it appears in lines like the following:
<pre>
&#61;&#61;23182&#61;&#61; 3,921 (72 direct, 3,849 indirect) bytes in 1 blocks are definitely lost in loss record 105,515 of 106,136
...
&#61;&#61;23182&#61;&#61; 5,600 (2,400 direct, 3,200 indirect) bytes in 100 blocks are definitely lost in loss record 105,647 of 106,136
...
&#61;&#61;23182&#61;&#61; 3,491 (136 direct, 3,355 indirect) bytes in 1 blocks are definitely lost in loss record 105,469 of 106,136
...
</pre>
The first number is just the process number. The second number is the total number of bytes leaked by this type of leak... anything bigger than 10kb is probably worth investigating further. The number of 'blocks' is how many occurances of that type of memory leak there were ... if it equals the number of events you process in your job (or scales with it at least, i.e. is probably more than 2 or 3) then you should consider this a <b>BAD LEAK</b> (i.e. the more events you process, the worse the leak will get. In the above example I had run on 100 events so the second of the three example lines is something I should look at. Here is what it shows fully:
<pre>
&#61;&#61;23182&#61;&#61; 5,600 (2,400 direct, 3,200 indirect) bytes in 100 blocks are definitely lost in loss record 105,647 of 106,136
&#61;&#61;23182&#61;&#61;    at 0x4A075FC: operator new(unsigned long) (vg&#95;replace&#95;malloc.c:298)
&#61;&#61;23182&#61;&#61;    by 0x194FEE37: CamxAODExampleAlg::execute() (CamxAODExampleAlg.cxx:116)
&#61;&#61;23182&#61;&#61;    by 0x194F8C68: CamAlgorithm::sysExecute() (CamAlgorithm.cxx:159)
&#61;&#61;23182&#61;&#61;    by 0x1916EABF: AthSequencer::execute() (in /cvmfs/atlas.cern.ch/repo/sw/software/AthAnalysisBase/x86&#95;64-slc6-gcc47-opt/2.0.21/AthAnalysisBase/2.0.21/Control/GaudiSequencer/x86&#95;64-slc6-gcc47-opt/libGaudiSequencer.so)
</pre>
This is telling me that line 116 of <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/CamxAODExampleAlg?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">CamxAODExampleAlg</a></span> is causing a leak through a 'new' allocation, when it isn't being deleted after. In fact that's exactly what was going on in this example ... I had added 
<pre>
std::vector&#60;double&#62;&#42; oo &#61; new std::vector&#60;double&#62;(4);
</pre>
To my code to test valgrind to see if it would catch it. It did <img src="https://twiki.cern.ch/twiki/pub/TWiki/SmiliesPlugin/smile.gif" alt="smile" title="smile" border="0" />
<p />
You can also look at the bottom of the log file for the 'leak summary'. In a reasonably good job it looks like this (<b>make sure you are looking at the summary which matches the process number of the main event loop... i.e. ignore the summary that the top of the log file, which refers to the python process that executes in every athena job</b>):
<pre>
&#61;&#61;24691&#61;&#61; LEAK SUMMARY:
&#61;&#61;24691&#61;&#61;    definitely lost: 10,292 bytes in 58 blocks
&#61;&#61;24691&#61;&#61;    indirectly lost: 49,987 bytes in 864 blocks
&#61;&#61;24691&#61;&#61;      possibly lost: 2,496,363 bytes in 13,635 blocks
&#61;&#61;24691&#61;&#61;    still reachable: 41,987,921 bytes in 333,436 blocks
&#61;&#61;24691&#61;&#61;         suppressed: 0 bytes in 0 blocks
</pre>
Anything more than a few 10's of kb of definitely lost memory should be cause for concern. In particular, if you try running the above command on say 100 events, then run it again on 500 events, and if the memory loss increases by more than a small amount you know you are in trouble and should go looking for the causes of those 'definite' memory leaks. But dont get hung up on all of them, quite a few of them wont be from your code they will be from things that are part of core Athena or ROOT or xAOD pckages, just look at the stack trace for each leak to be sure. For example, I reran the above job again on 500 events and got:
<pre>
&#61;&#61;25162&#61;&#61; LEAK SUMMARY:
&#61;&#61;25162&#61;&#61;    definitely lost: 7,125 bytes in 58 blocks
&#61;&#61;25162&#61;&#61;    indirectly lost: 127,573 bytes in 1,901 blocks
&#61;&#61;25162&#61;&#61;      possibly lost: 2,420,824 bytes in 12,593 blocks
&#61;&#61;25162&#61;&#61;    still reachable: 41,990,028 bytes in 333,442 blocks
&#61;&#61;25162&#61;&#61;         suppressed: 0 bytes in 0 blocks
</pre>
It shows that I didn't get any extra definite losses (I still had 58 blocks of definite losses). Although I did end up doubling the number of indirect losses, but hopefully that isn't a problem <img src="https://twiki.cern.ch/twiki/pub/TWiki/SmiliesPlugin/smile.gif" alt="smile" title="smile" border="0" />
<p />
<h2><a name="How_to_recompile_an_entire_night"></a> How to recompile an entire nightly </h2>
You currently must copy over all the source code to a local area. First create a new testarea and set up the nightly you will want to recompile:
<pre>
mkdir MyTestarea
cd MyTestarea
asetup AthAnalysisBase,2.0.X,rel&#95;1
</pre>
Then efficiently copy the source code with rsync, and use the <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/AthAnalysisBaseRelease?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">AthAnalysisBaseRelease</a></span> "container package" to recompile everything:
<pre>
rsync --progress --recursive $AtlasBaseDir/$AtlasProject/$AtlasVersion/&#42; ./ --exclude&#61;$CMTCONFIG --exclude&#61;NICOS&#95;area --exclude&#61;InstallArea
rm -rf cmt
cd AthAnalysisBaseRelease/cmt
cmt br cmt config
source setup.sh
cmt br cmt make
</pre>
This currently takes about 90 minutes to rebuild the entire nightly (at time of testing). 
<p />
<h2><a name="How_to_protect_yourself_from_ROO"></a> How to protect yourself from ROOT-based errors </h2>
Occasionally ROOT will have trouble reading an input file during an athena job, but wont fail badly enough that athena catches it and fails itself. This can lead to problems such as events being incorrectly skipped or possibly duplicated accidentally.
<p />
From 2.4.14 onwards, a new service called <code>AthROOTErrorHandlerSvc</code> can be added to your job, which will catch known (but rare) problems with ROOT file reading and throw a runtime exception for these. Add it to your job like this:
<p />
<pre>
theApp.CreateSvc +&#61; &#91;&#34;AthROOTErrorHandlerSvc&#34;]
</pre>
<p />
<p />
<h1><a name="Standalone_executables_processin"></a> Standalone executables (processing events outside of athena) </h1>
<p />
<h2><a name="How_to_use_POOL_TEvent"></a> How to use POOL::TEvent </h2>
The <a href="https://svnweb.cern.ch/trac/atlasoff/browser/PhysicsAnalysis/POOLRootAccess/trunk/POOLRootAccess/TEvent.h" target="_blank">POOL::TEvent<img alt="" border="0" height="12" src="/twiki/pub/TWiki/TWikiDocGraphics/external-link.gif" width="13" /></a> class is a little helper utility for looping over any POOL file. This will work with both EVNT and xAOD, for example. The class can be used from the interactive root prompt, e.g. paste the following into the prompt:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>POOL::TEvent evt(POOL::TEvent::kClassAccess); <I><FONT COLOR="#B22222">//options are kPOOLAccess (default), kBranchAccess, kClassAcccess, kAthenaAccess;
</FONT></I>evt.readFrom( <B><FONT COLOR="#BC8F8F">&quot;xaod.pool.root&quot;</FONT></B> );
evt.getEntry(0);
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;xAODEventInfo/EventInfo.h&quot;</FONT></B> //so we can use the versionless type
<B><FONT COLOR="#228B22">const</FONT></B> xAOD::EventInfo* evtInfo = 0;
evt.retrieve( evtInfo, <B><FONT COLOR="#BC8F8F">&quot;EventInfo&quot;</FONT></B>);
evtInfo-&gt;eventNumber(); <I><FONT COLOR="#B22222">//print the event number
</FONT></I></pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
If you were running on an EVNT file (you must use kPOOLAccess for this), you could do:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#228B22">const</FONT></B> HepMcCollection* truth = 0;
evt.retrieve( truth ); <I><FONT COLOR="#B22222">//not specifying a key will mean it tries to read the default collection
</FONT></I>truth-&gt;at(0)-&gt;particles_begin()-&gt;status(); <I><FONT COLOR="#B22222">//status of first particle in the first GenEvent in the collection ... google GenEvent for help
</FONT></I></pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
If you want to incorporate this into a standalone executable, use the <code>new_analysisapp</code> cmt command from inside a package, <a href="https://twiki.cern.ch/twiki/bin/viewauth/AtlasProtected/AthAnalysisBase#How_to_create_a_standalone_POOL" target="_top">see here</a> for more information on that.
<p />
<b>Please note that you cannot use a kPOOLAccess TEvent in the same session/job/program as a different access mode. You either use POOL or your use one of the others.</b>
<p />
<h2><a name="How_to_execute_an_algorithm_with"></a> How to execute an algorithm with POOL::TEvent </h2>
You can use TEvent to create your own event loop application that can execute an algorithm. Lets suppose you want to execute an algorithm of type <code>MyAlgorithm</code>. You can write a standalone executable (will even work as a ROOT macro) to do it like this:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>POOL::TEvent evt(POOL::TEvent::kClassAccess); <I><FONT COLOR="#B22222">//assume I'm running over xAOD
</FONT></I>evt.readFrom(<B><FONT COLOR="#BC8F8F">&quot;$ASG_TEST_FILE_MC&quot;</FONT></B>); <I><FONT COLOR="#B22222">//read the file pointed at by this environment variable
</FONT></I><B><FONT COLOR="#0000FF">AAH::setProperty</FONT></B>( evt.evtLoop() , <B><FONT COLOR="#BC8F8F">&quot;TopAlg&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;['MyAlgorithm/myAlg']&quot;</FONT></B>); <I><FONT COLOR="#B22222">//setting the 'TopAlg' property of the event loop service, which is a list of strings of form 'AlgType/AlgName'
</FONT></I><B><FONT COLOR="#0000FF">AAH::addPropertyToCatalogue</FONT></B>( <B><FONT COLOR="#BC8F8F">&quot;myAlg&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;OutputLevel&quot;</FONT></B>, 2 ); <I><FONT COLOR="#B22222">//example of setting a property of the algorithm. Have to use this addPropertyToCatalogue method because alg not existing yet
</FONT></I>
<I><FONT COLOR="#B22222">//Now do the event loop ... will cause the alg to be executed automatically
</FONT></I><B><FONT COLOR="#0000FF">for</FONT></B>(<B><FONT COLOR="#228B22">int</FONT></B> i=0;i&lt;evt.getEntries();i++) {
  evt.getEntry(i);
}</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
Alternatively, you can create the algorithm directly yourself, but then you are responsible for initializing and executing it, e.g.
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>IAlgorithm* myAlg = AAH::createAlgorithm(<B><FONT COLOR="#BC8F8F">&quot;MyAlgorithm/myAlg&quot;</FONT></B>);
<B><FONT COLOR="#0000FF">AAH::setProperty</FONT></B>( myAlg, <B><FONT COLOR="#BC8F8F">&quot;OutputLevel&quot;</FONT></B>, 2 );
myAlg-&gt;initialize();

...
myAlg-&gt;execute();</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
<p />
<a name="PyROOTTEvent"></a>
<h2><a name="How_to_inspect_files_in_pyROOT"></a> How to inspect files in pyROOT </h2>
<p />
You can use POOL::TEvent to inspect files in pyROOT too:
<p />
Note: Please use <a class="twikiCurrentTopicLink twikiLink" href="/twiki/bin/view/AtlasProtected/AthAnalysisBase">AthAnalysisBase</a> 2.4.18 onwards for this example (contact me if you need to use an earlier version):
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#A020F0">import</FONT></B> ROOT
evt = ROOT.POOL.TEvent(ROOT.POOL.TEvent.kClassAccess)
evt.readFrom(<B><FONT COLOR="#BC8F8F">&quot;my.pool.root&quot;</FONT></B>)

<B><FONT COLOR="#A020F0">for</FONT></B> i <B><FONT COLOR="#A020F0">in</FONT></B> range(0,evt.getEntries()):
  evt.getEntry(i)
  particles = evt.retrieve(<B><FONT COLOR="#BC8F8F">&quot;xAOD::TruthParticleContainer&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;TruthParticles&quot;</FONT></B>)  
  <I><FONT COLOR="#B22222">#particles = evt.get_item(&quot;TruthParticles&quot;)   #alternative method that doesnt even need you to know the type, just the key ... but it is slower and can give different object back (e.g. in the case of EventInfo)
</FONT></I>  <B><FONT COLOR="#A020F0">for</FONT></B> p <B><FONT COLOR="#A020F0">in</FONT></B> particles:
    ROOT.AAH.printAuxElement(p)</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
The above example will loop over the <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/TruthParticles?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">TruthParticles</a></span> and print out the aux information on them. 
<p />
Below is the older example code:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#A020F0">from</FONT></B> AthenaPython <B><FONT COLOR="#A020F0">import</FONT></B> PyAthena
sg = PyAthena.py_svc(<B><FONT COLOR="#BC8F8F">&quot;StoreGateSvc&quot;</FONT></B>)
<I><FONT COLOR="#B22222">#methods of sg:
</FONT></I><I><FONT COLOR="#B22222">#sg.retrieve(&quot;xAOD::EventInfo&quot;,&quot;EventInfo&quot;) ... retrieve object with explicit type. Note: This is how you should retrieve EventInfo!
</FONT></I><I><FONT COLOR="#B22222">#sg.contains(&quot;MyType,&quot;MyKey&quot;) ... checks for presents of object of type 'MyType' and key 'MyKey'
</FONT></I><I><FONT COLOR="#B22222">#sg['MyObjects']  ... retrieves the storegate object with key called 'MyObjects' (using the default type). Note: This is slower than 'retrieve' and might not give you the object you expect, e.g. in the case of EventInfo
</FONT></I></pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
<h2><a name="How_to_create_tools_on_the_ROOT"></a> How to create tools on the ROOT prompt </h2>
<p />
Since the recommended way to work with tools is always to use a toolhandle, here is an example of doing just that. We will create an instance of the <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/PileupReweightingTool?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">PileupReweightingTool</a></span>
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><I><FONT COLOR="#B22222">//these first two lines are to tell ROOT what a ToolHandle is
</FONT></I>#<B><FONT COLOR="#5F9EA0">define</FONT></B> <FONT COLOR="#B8860B">GAUDI_V20_COMPAT</FONT>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;GaudiKernel/ToolHandle.h&quot;</FONT></B>

<I><FONT COLOR="#B22222">//ToolHandle&lt;CP::IEgammaCalibrationAndSmearingTool&gt; tool(&quot;CP::EgammaCalibrationAndSmearingTool&quot;);
</FONT></I><I><FONT COLOR="#B22222">//AAH::setProperty( tool , &quot;ESModel&quot;, &quot;es2016PRE&quot; ); //example of setting a property
</FONT></I>
ToolHandle&lt;CP::IPileupReweightingTool&gt; prwTool(<B><FONT COLOR="#BC8F8F">&quot;CP::PileupReweightingTool&quot;</FONT></B>);
<B><FONT COLOR="#0000FF">AAH::setProperty</FONT></B>( prwTool, <B><FONT COLOR="#BC8F8F">&quot;ConfigFiles&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;[]&quot;</FONT></B> ); <I><FONT COLOR="#B22222">//example of setting a property
</FONT></I>prwTool.retrieve(); <I><FONT COLOR="#B22222">//initializes the tool
</FONT></I></pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
<h2><a name="How_to_use_x_AODRootAccess_xAOD"></a> How to use xAODRootAccess (xAOD::TEvent) from the interactive prompt </h2>
All you need to do is load the libraries. The equivalent of the rootcore <code>load_packages</code> script can be accomplished with:
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#0000FF">THtml::LoadAllLibs</FONT></B>()</pre>
<!-- end SyntaxHighlightingPlugin -->
For example:
<p />
<pre style="background: #e0ebf6;">
root &#91;0] THtml::LoadAllLibs()
root &#91;1] xAOD::Init();
root &#91;2] f &#61; TFile::Open( &#34;$ROOTCORE&#95;TEST&#95;FILE&#34;, &#34;READ&#34; );
root &#91;3] t &#61; xAOD::MakeTransientTree( f )
root &#91;4] t-&#62;Draw( &#34;Electrons.pt() - Electrons.trackParticle().pt()&#34; );
</pre>
<p />
<h2><a name="How_to_write_your_own_athena_app"></a> How to write your own athena application or ROOT Macro </h2>
<p />
The following is an example of reading an xAOD using a ROOT Macro, but through the proper POOL mechanism. It shows how you can recreate what the main athena.py application is doing. 
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><I><FONT COLOR="#B22222">//Put this in a athenaMacro.C file:
</FONT></I>{
  <I><FONT COLOR="#B22222">//BOOTSTRAP GAUDI
</FONT></I>  <B><FONT COLOR="#5F9EA0">AAH</FONT></B>::initGaudi();

  <I><FONT COLOR="#B22222">//CONFIGURE: add properties to the catalogue for things we wont interact with ourselves
</FONT></I>  
  <I><FONT COLOR="#B22222">//The following two properties MUST be set for reading POOL files (i.e. xAOD)
</FONT></I>  <B><FONT COLOR="#5F9EA0">AAH</FONT></B>::addPropertyToCatalogue(<B><FONT COLOR="#BC8F8F">&quot;EventPersistencySvc&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;CnvServices&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;['AthenaPoolCnvSvc']&quot;</FONT></B>); <I><FONT COLOR="#B22222">//add AthenaPoolCnvSvc as a converter service
</FONT></I>  <B><FONT COLOR="#5F9EA0">AAH</FONT></B>::addPropertyToCatalogue(<B><FONT COLOR="#BC8F8F">&quot;ProxyProviderSvc&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;ProviderNames&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;['AthenaPoolAddressProviderSvc']&quot;</FONT></B>); <I><FONT COLOR="#B22222">//add AthenaPoolAddressProviderSvc as an address provider
</FONT></I>
  <I><FONT COLOR="#B22222">///HANDLES TO SERVICES
</FONT></I>  ServiceHandle&lt;IProperty&gt; theEvtSel(<B><FONT COLOR="#BC8F8F">&quot;EventSelectorAthenaPool/EventSelector&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>);
  ServiceHandle&lt;IEventProcessor&gt; theEventLoop(<B><FONT COLOR="#BC8F8F">&quot;AthenaEventLoopMgr/MyLoop&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>);
  ServiceHandle&lt;StoreGateSvc&gt; evtStore(<B><FONT COLOR="#BC8F8F">&quot;StoreGateSvc/StoreGateSvc&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>);

  <I><FONT COLOR="#B22222">//configure input files
</FONT></I>  <B><FONT COLOR="#5F9EA0">AAH</FONT></B>::setProperty( theEvtSel, <B><FONT COLOR="#BC8F8F">&quot;InputCollections&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;['/afs/cern.ch/user/a/asgbase/patspace/xAODs/r6630/mc15_13TeV.410000.PowhegPythiaEvtGen_P2012_ttbar_hdamp172p5_nonallhad.recon.AOD.e3698_s2608_s2183_r6630_tid05352803_00/AOD.05352803._000242.pool.root.1']&quot;</FONT></B>);

  <I><FONT COLOR="#B22222">//Connect EventLoop to Selector
</FONT></I>  <B><FONT COLOR="#5F9EA0">AAH</FONT></B>::setProperty( theEventLoop, <B><FONT COLOR="#BC8F8F">&quot;EvtSel&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;EventSelectorAthenaPool/EventSelector&quot;</FONT></B>);
  <I><FONT COLOR="#B22222">//And then ensure configured for interactive work 
</FONT></I>  <B><FONT COLOR="#5F9EA0">AAH</FONT></B>::setProperty( theEventLoop,<B><FONT COLOR="#BC8F8F">&quot;ClearStorePolicy&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;BeginEvent&quot;</FONT></B>);
  <B><FONT COLOR="#5F9EA0">AAH</FONT></B>::setProperty( theEventLoop,<B><FONT COLOR="#BC8F8F">&quot;EventPrintoutInterval&quot;</FONT></B>,99999999); <I><FONT COLOR="#B22222">//disable printout, which speeds up execution
</FONT></I>  

  <I><FONT COLOR="#B22222">//services are automatically initialized upon retrieve, since we have already initialized the applicationMgr
</FONT></I>  

  <I><FONT COLOR="#B22222">///ACTUAL LOOP
</FONT></I>
  <I><FONT COLOR="#B22222">//now we can loop on the events, like this:
</FONT></I>  <B><FONT COLOR="#228B22">int</FONT></B> numEvents = dynamic_cast&lt;ICollectionSize*&gt;(&amp;*theEvtSel)-&gt;size();
  dynamic_cast&lt;IEventSeek*&gt;(&amp;*theEventLoop)-&gt;seek(0); <I><FONT COLOR="#B22222">//must seek to the front of the loop for some strange reason, otherwise we miss the first event??
</FONT></I>  <B><FONT COLOR="#A020F0">for</FONT></B>(<B><FONT COLOR="#228B22">int</FONT></B> i=1;i&lt;=numEvents;i++) {
    theEventLoop-&gt;nextEvent(i);
    <B><FONT COLOR="#228B22">const</FONT></B> xAOD::EventInfo* evtInfo = 0; 
    evtStore-&gt;retrieve( evtInfo, <B><FONT COLOR="#BC8F8F">&quot;EventInfo&quot;</FONT></B>);
    <B><FONT COLOR="#5F9EA0">std</FONT></B>::cout &lt;&lt; <B><FONT COLOR="#BC8F8F">&quot;EventNumber = &quot;</FONT></B> &lt;&lt; evtInfo-&gt;eventNumber() &lt;&lt; std::endl;
  }

}</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
You can run this with:
<pre>
root athenaMacro.C
</pre>
<p />
The above can be accomplished more succinctly (and with reduced output from the services) by using a job options file to specify all the properties. If you put the following in a jobopt file:
<p />
<pre>
//Put this in myJobOptions.opts
#pragma print off //do not print the joboptions
ApplicationMgr.OutputLevel &#61; 0; //NIL ... so ApplicationMgr is silent
ApplicationMgr.EventLoop &#61; &#34;MinimalEventLoopMgr&#34;; //Ensures fewest possible services are created: MessageSvc, JobOptionsSvc, IncidentSvc, AppMgrRunable, MinimalEventLoopMgr

MessageSvc.OutputLevel &#61; 5; //ERROR

//basic POOL reading config
EventPersistencySvc.CnvServices &#61; {&#34;AthenaPoolCnvSvc&#34;};
ProxyProviderSvc.ProviderNames &#61; {&#34;AthenaPoolAddressProviderSvc&#34;};

//configure an event selector
EventSelector.InputCollections &#61; {&#34;/afs/cern.ch/user/a/asgbase/patspace/xAODs/r6630/mc15&#95;13TeV.410000.PowhegPythiaEvtGen&#95;P2012&#95;ttbar&#95;hdamp172p5&#95;nonallhad.recon.AOD.e3698&#95;s2608&#95;s2183&#95;r6630&#95;tid05352803&#95;00/AOD.05352803.&#95;000242.pool.root.1&#34;};

//configure an event loop
MyLoop.EvtSel &#61; &#34;EventSelectorAthenaPool/EventSelector&#34;;
MyLoop.ClearStorePolicy&#61;&#34;BeginEvent&#34;;
MyLoop.EventPrintoutInterval&#61;9999999; //disable the event loop printout, which slows the execution down
</pre>
<p />
And then the macro is simply:
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><I><FONT COLOR="#B22222">//put this in: athenaJoboMacro.C
</FONT></I>{
  <I><FONT COLOR="#B22222">//BOOTSTRAP GAUDI with our joboptions
</FONT></I>  <B><FONT COLOR="#5F9EA0">AAH</FONT></B>::initGaudi(<B><FONT COLOR="#BC8F8F">&quot;myJobOptions.opts&quot;</FONT></B>);

  <I><FONT COLOR="#B22222">///HANDLES TO SERVICES
</FONT></I>  ServiceHandle&lt;IProperty&gt; theEvtSel(<B><FONT COLOR="#BC8F8F">&quot;EventSelectorAthenaPool/EventSelector&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>);
  ServiceHandle&lt;IEventProcessor&gt; theEventLoop(<B><FONT COLOR="#BC8F8F">&quot;AthenaEventLoopMgr/MyLoop&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>);
  ServiceHandle&lt;StoreGateSvc&gt; evtStore(<B><FONT COLOR="#BC8F8F">&quot;StoreGateSvc/StoreGateSvc&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>);

  <I><FONT COLOR="#B22222">///ACTUAL LOOP
</FONT></I>
  <I><FONT COLOR="#B22222">//now we can loop on the events, like this:
</FONT></I>  <B><FONT COLOR="#228B22">int</FONT></B> numEvents = dynamic_cast&lt;ICollectionSize*&gt;(&amp;*theEvtSel)-&gt;size();
  dynamic_cast&lt;IEventSeek*&gt;(&amp;*theEventLoop)-&gt;seek(0); <I><FONT COLOR="#B22222">//must seek to the front of the loop for some strange reason, otherwise we miss the first event??
</FONT></I>  <B><FONT COLOR="#A020F0">for</FONT></B>(<B><FONT COLOR="#228B22">int</FONT></B> i=1;i&lt;=numEvents;i++) {
    theEventLoop-&gt;nextEvent(i);
    <B><FONT COLOR="#228B22">const</FONT></B> xAOD::EventInfo* evtInfo = 0; 
    evtStore-&gt;retrieve( evtInfo, <B><FONT COLOR="#BC8F8F">&quot;EventInfo&quot;</FONT></B>);
    <B><FONT COLOR="#5F9EA0">std</FONT></B>::cout &lt;&lt; <B><FONT COLOR="#BC8F8F">&quot;EventNumber = &quot;</FONT></B> &lt;&lt; evtInfo-&gt;eventNumber() &lt;&lt; std::endl;
  }
}</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
<h1><a name="PyROOT_in_AthAnalysisBase"></a> <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/PyROOT?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">PyROOT</a></span> in <a class="twikiCurrentTopicLink twikiLink" href="/twiki/bin/view/AtlasProtected/AthAnalysisBase">AthAnalysisBase</a> </h1>
<h2><a name="Looping_over_xAOD_with_PyROOT_no"></a> Looping over xAOD with <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/PyROOT?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">PyROOT</a></span> (no athena) </h2>
Please see <a class="twikiCurrentTopicLink twikiAnchorLink" href="/twiki/bin/view/AtlasProtected/AthAnalysisBase#PyROOTTEvent">this section</a> for an example.
<p />
<h2><a name="Looping_over_xAOD_with_PyROOT_in"></a> Looping over xAOD with <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/PyROOT?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">PyROOT</a></span> in interactive athena </h2>
Strictly this is an athena job, but you can write python code to quickly inspect an xAOD, say, by doing:
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#A020F0">import</FONT></B> AthenaPoolCnvSvc.ReadAthenaPool <I><FONT COLOR="#B22222">#or for fast reading: import AthenaRootComps.ReadAthenaxAOD
</FONT></I>svcMgr.EventSelector.InputCollections=[<B><FONT COLOR="#BC8F8F">'my.xaod.root'</FONT></B>]
theApp.initialize()
sg = PyAthena.py_svc(<B><FONT COLOR="#BC8F8F">'StoreGateSvc'</FONT></B>)
<B><FONT COLOR="#A020F0">for</FONT></B> i <B><FONT COLOR="#A020F0">in</FONT></B> range(0, theApp.size()):
	theApp.nextEvent();
	evtInfo = sg[<B><FONT COLOR="#BC8F8F">'EventInfo'</FONT></B>]
	<B><FONT COLOR="#A020F0">print</FONT></B> evtInfo.eventNumber()</pre>
<!-- end SyntaxHighlightingPlugin -->
and you can execute it with:
<pre>
athena -i mytest.py
</pre>
<p />
<p />
<h1><a name="Advanced_usage"></a> Advanced usage </h1>
<p />
<h2><a name="How_to_use_public_and_private_To"></a> How to use public and private <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/ToolHandles?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">ToolHandles</a></span> </h2>
Here are some development notes regarding the use of ToolHandles and ToolHandleArrays, and using them as properties.
<p />
1. A public ToolHandle (one that doesn't have a parent) is the same as a private ToolHandle with parent = ToolSvc. The same goes for ToolHandleArray.<br>
2. When a ToolHandle is declared as a property, you should think of it as a string property, the value of which is passed to the constructor of the ToolHandle (ToolHandleArray is a vector of strings).<br>
3. When setting a property with a ToolHandle, the value of the ToolHandle is the name of the tool is <code>toolHandle.typeAndName()</code> ... i.e. the parent name is name part of the value.
<p />
With these three rules, you can understand how to get ToolHandles to pick up the tools you want. 
<p />
If you had a tool that has declared a public ToolHandle as a property (with property name <code>SubTool</code>), and you wanted to configure and pass a tool to this handle, you would do:
<p />
<pre>
ToolHandle&#60;..&#62; parentTool(&#34;ParentType/ParentName&#34;); //a handle to &#34;ToolSvc.ParentName&#34;
ToolHandle&#60;..&#62; subTool(&#34;Type/Name&#34;); //a handle to &#34;ToolSvc.Name&#34;
AthAnalysisHelper::setProperty(subTool,&#34;Property&#34;, value); //for example
AthAnalysisHelper::setProperty( parentTool , &#34;SubTool&#34; , subTool ); //sets private handle to &#34;Type/Name&#34;, i.e. a handle to &#34;ToolSvc.Name&#34;
</pre>
<p />
If the property was instead a private tool, you would need to do:
<p />
<pre>
ToolHandle&#60;..&#62; parentTool(&#34;ParentType/ParentName&#34;); //a handle to &#34;ToolSvc.ParentName&#34;
ToolHandle&#60;..&#62; subTool(&#34;Type/ParentName.Name&#34;); //a handle to &#34;ToolSvc.ParentName.Name&#34;
AthAnalysisHelper::setProperty(subTool,&#34;Property&#34;, value); //for example
AthAnalysisHelper::setProperty( parentTool , &#34;SubTool&#34; , subTool ); //sets private handle to &#34;Type/Name&#34;, i.e. a handle to &#34;ToolSvc.ParentName.Name&#34;
</pre>
<p />
The last line relies on some code in the <code>setProperty</code> method to strip out <code>ParentName</code> from the subTool name, effectively making the value of <code>subTool</code> be <code>Type/Name</code>
<p />
<p />
<h2><a name="How_to_add_a_new_asg_tool_to_you"></a> How to add a new asg tool to your package </h2>
Please note that for 2.3.43 you should first checkout and compile <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/PyUtils?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">PyUtils</a></span>-00-14-57 (will be present in future releases)
<pre>
cmt checkout&#95;pkg PyUtils-00-14-57
cmt find&#95;packages
cmt compile
</pre>
Then you can do:
<pre>
cmt new&#95;asgtool MyTool &#91;--googleTest]
</pre>
The --googleTest option will set up a google test for your tool (look in the <code>test</code> directory), instead of a simple executable unit test.
<p />
<h2><a name="How_to_add_an_atn_athena_test_fo"></a> How to add an atn athena test for cmt releases </h2>
inside your package do:
<pre>
cmt new&#95;analysisalg MyToolTest --newJobo --atnTest
</pre>
This creates a <code>Test::MyToolTest</code> algorithm, with a joboption for it, and adds the necessary text to the xml file in the <code>test</code> directory to execute the test as part of atn tests.
<p />
<h2><a name="How_to_add_an_atn_standalone_app"></a> How to add an atn standalone application test for cmt releases </h2>
1. Create a standalone application in the <code>test</code> directory of your package, similar to the one <a href="https://svnweb.cern.ch/trac/atlasoff/browser/PhysicsAnalysis/AnalysisCommon/CPAnalysisExamples/tags/CPAnalysisExamples-00-00-54/test/ut_ath_EgammaCalibrationAndSmearingTool_test.cxx" target="_blank">here<img alt="" border="0" height="12" src="/twiki/pub/TWiki/TWikiDocGraphics/external-link.gif" width="13" /></a>. Ensure your test ends in <code>_test.cxx</code>
<p />
2. Add the test to the requirements file, like done <a href="https://svnweb.cern.ch/trac/atlasoff/browser/PhysicsAnalysis/AnalysisCommon/CPAnalysisExamples/tags/CPAnalysisExamples-00-00-54/cmt/requirements#L77" target="_blank">here<img alt="" border="0" height="12" src="/twiki/pub/TWiki/TWikiDocGraphics/external-link.gif" width="13" /></a>. Note that <code>unit_test</code> is set to the name of the test without the <code>_test.cxx</code> end.
<p />
3. If the test will reside in the same package as the code for the tool, you will want to ensure the tool is compiled before the test application. To do this, you need to declare to cme your main package library as a dependency of the test application. Do this like <a href="https://svnweb.cern.ch/trac/atlasoff/browser/PhysicsAnalysis/AnalysisCommon/PileupReweighting/tags/PileupReweighting-00-03-22/cmt/requirements#L86" target="_blank">this<img alt="" border="0" height="12" src="/twiki/pub/TWiki/TWikiDocGraphics/external-link.gif" width="13" /></a>. 
<p />
4. Finally, to ensure the test application will be executed by NICOS nightly system, ensure your package has a <code>makecheck</code> test declaration in its test xml configuration, like <a href="https://svnweb.cern.ch/trac/atlasoff/browser/PhysicsAnalysis/AnalysisCommon/CPAnalysisExamples/tags/CPAnalysisExamples-00-00-54/test/CPAnalysisExamples.xml#L27" target="_blank">here<img alt="" border="0" height="12" src="/twiki/pub/TWiki/TWikiDocGraphics/external-link.gif" width="13" /></a>
<p />
The nice thing about these standalone application tests is that they can be easily executed with <strong>make check</strong> command called from the cmt directory of the package.
<p />
<h2><a name="How_to_execute_atn_tests_locally"></a> How to execute atn tests locally </h2>
If not already done at least once:
<pre>
cmt find&#95;packages
</pre>
Then do:
<pre>
/afs/cern.ch/atlas/software/dist/nightlies/atn/atn Path/To/Package
</pre>
The path to the package is relative to the top of the testarea. The results of the test will go into the <code>www</code> directory at the top of your testarea. Navigate to the <code>index.html</code> in there on your webbrowser, and check all the results passed
<p />
Alternatively to the above, you can take a look at the xml configuration file in the <code>test</code> directory of the package, and manually execute each of the tests.  <ul>
<li> A <code>makecheck</code> test can be executed with <code>make check</code> called from the cmt directory.
</li> <li> A <code>athena</code> test can be executed with the joboptions specified in that test
</li> <li> A <code>script</code> test is executed by running the script/executable specified in the test.
</li></ul> 
<p />
You can/should also validate your xml configuration file using:
<p />
<pre>
python /afs/cern.ch/user/r/rtt/public/validateXML.py MyPackage.xml
</pre>
<p />
If you get errors, look at a good example, e.g: <a href="https://svnweb.cern.ch/trac/atlasoff/browser/Reconstruction/Jet/JetReclustering/trunk/test/JetReclustering.xml" target="_blank">https://svnweb.cern.ch/trac/atlasoff/browser/Reconstruction/Jet/JetReclustering/trunk/test/JetReclustering.xml<img alt="" border="0" height="12" src="/twiki/pub/TWiki/TWikiDocGraphics/external-link.gif" width="13" /></a> - note all the preambles, the validation script will want all that
<p />
<h2><a name="How_to_use_AnaToolHandle"></a> How to use AnaToolHandle </h2>
The AnaToolHandle was introduced in 2.3.43 . It is dual use (same code to use it in rootcore and cmt releases). The idea is to strongly encourage creating tools through factory methods, and interacting with tools via interface classes. The workings of the tool were overhauled in 2.4.19. Here's how to use it (in 2.4.19 onwards):
<p />
<pre>
asg::AnaToolHandle&#60;IMyTool&#62; tool;    //use instead of: IMyTool&#42; tool &#61; 0;
tool.setTypeAndName(&#34;Type/Name&#34;); //use instead of: tool &#61; new Type(&#34;Name&#34;);
tool.setProperty(&#34;Property&#34;,&#34;Value&#34;);   //use instead of: tool-&#62;setProperty(&#34;Property&#34;,&#34;Value&#34;);
tool.retrieve();                                      //use instead of: tool-&#62;initialize();
</pre>
<p />
The above code will create a <i>public tool</i>. Public tools can then be accessed from other parts of your code like this:
<p />
<pre>
asg::AnaToolHandle&#60;IMyTool&#62; tool;    
tool.setTypeAndName(&#34;Type/Name&#34;);
tool.isUserConfigured(); //this will be TRUE
tool.setProperty(&#34;Property&#34;,&#34;Value&#34;); //this will be IGNORED
tool.retrieve();     //this will just connect the tool to the already existing public tool
</pre>
<p />
Tools can have other tools as private tools, so if you are a CP tool developer, you can do:
<p />
<pre>
{ //inside ParentTool
asg::AnaToolHandle&#60;IMyTool&#62; tool;    
tool.setParent(this); //this is the tool you are writing code in
tool.declarePropertyFor(this, &#34;PropertyName&#34;, &#34;Property Description&#34;); //makes this tool be a subtool of the &#39;this&#39; tool
tool.setTypeAndName(&#34;Type/Name&#34;);
tool.isUserConfigured(); //can use this to check if the user as set and properties
}

</pre>
<p />
Where <code>IMyTool</code> is an appropriate interface for the tool. You should demand that developers provide appropriate interface classes. 
<p />
If you are a user who wants to set properties of a tool's private tool, e.g. the one above, you can do either:
<p />
<pre>
asg::AnaToolHandle&#60;IParentTool&#62; tool(&#34;ParentType/ParentName&#34;);
tool.setProperty(&#34;PropertyName&#34; , &#34;Type/MyName&#34;); //where &#39;Type&#39; is the type you want the private subtool to be
tool.setProperty(&#34;MyName.SubToolProperty&#34;, &#34;Value&#34;); //setting &#39;SubToolProperty&#39; property of the subtool
</pre>
<p />
Or you can do:
<pre>
asg::AnaToolHandle&#60;ISubTool&#62; subTool(&#34;Type/ParentName.MyName&#34;); //note the name must start with &#39;ParentName.&#39;
subTool.setProperty(&#34;SubToolProperty&#34;,&#34;Value&#34;);
subTool.initialize(); //initialize the subtool first, so that parent tool can&#39;t try to overwrite properties

asg::AnaToolHandle&#60;IParentTool&#62; tool(&#34;ParentType/ParentName&#34;);
tool.setProperty(&#34;PropertyName&#34;, subTool.getHandle() );
</pre>
<p />
This effectively allows you to configure tools in c++ on the athena and eventloop frameworks in the same way. When the toolhandle is destroyed, the tool will be destroyed, unless another toolhandle is still referencing it.
<p />
One curiosity about ToolHandles is that there is a difference in when you define the tool and when you use it.  When you define it, you are interacting with the <strong>tool handle</strong> and it is treated like an object.  However, when you execute some method of the tool interface within your code, you are interacting with the <strong>tool</strong> itself, at which point you treat it like a pointer.  In short, instantiating a tool handle proceeds as
<pre>
asg::AnaToolHandle&#60;IParentTool&#62; tool(&#34;ParentType/ParentName&#34;);
tool.setProperty(&#34;PropertyName&#34; , &#34;Type/MyName&#34;); //where &#39;Type&#39; is the type you want the private subtool to be
tool.setProperty(&#34;MyName.SubToolProperty&#34;, &#34;Value&#34;); //setting &#39;SubToolProperty&#39; property of the subtool
</pre>
but if you then want to execute the method <code>IParentTool::myFunc()</code> which has been defined in the <code>ParentType</code> of the tool, then you must call
<pre>
tool-&#62;myFunc();
</pre>
<strong>NOTE</strong> that you are now using a <code>-&gt;</code> instead of a <code>.</code>
<p />
<h3><a name="A_Note_for_RootCore_users"></a> A Note for <a class="twikiLink" href="/twiki/bin/view/AtlasProtected/RootCore">RootCore</a> users </h3>
<p />
Sometimes the factory method for the tool you are trying to create is not properly defined. You will get, e.g, an error like this:
<p />
<pre>
AsgTools&#95;AnaToolHandle    ERROR   /build2/atnight/localbuilds/nightlies/AnalysisBase-2.4.X/AnalysisBase/rel&#95;nightly/AsgTools/Root/AnaToolHandle.cxx:143 (StatusCode asg::detail::makeToolRootCore(const string&#38;, const string&#38;, asg::AsgTool&#42;&#38;)): Unable to load class dictionary for type CP::IsolationCorrectionTool
</pre>
<p />
A workaround for this would be to replace:
<p />
<pre>
toolHandle.setTypeAndName(&#34;CP::IsolationCorrectionTool/toolName&#34;);
</pre>
<p />
with:
<p />
<pre>
ASG&#95;SET&#95;ANA&#95;TOOL&#95;TYPE( toolHandle, CP::IsolationCorrectionTool);
toolHandle.setName(&#34;toolName&#34;);
</pre>
<p />
<p />
<p />
<h1><a name="Known_Issues"></a> Known Issues </h1>
2.3.8 requires update to xAODMuonAthenaPool-00-03-00
2.3.11 (and 2.1.32) and earlier have a leaky version of the <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/TriggerDecisionTool?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">TriggerDecisionTool</a></span>. Please use at least 2.3.12 or 2.1.33
<p />
<a class="twikiLink" href="/twiki/bin/view/AtlasProtected/ElementLink">ElementLinks</a> will not work outside of the athena setup. This is because the version of <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/AthLinks?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">AthLinks</a></span> used in the cmt releases assumes the presence and population of a '!CurrentEventStore', which is an instance of a storegate in practice. If you use TEvent in the cmt releases, it wont populate a storegate, and so the element links wont be followed. This could hopefully be fixed at some point in the future: either modifying xAODRootAccess so that it does interact with storegate, or otherwise possibly altering the CurrentEventStore global method to return a TEvent instead .. but this will require TEvent to implement the IProxyDictWithPool interface
<p />
<!-- Add the main topic here. i.e. create some new headings as follows: -->
<p />
<!-- <strong>*********************************************************</strong> --> <!-- Do NOT remove the remaining lines, but add requested info as appropriate --> <!-- <strong>*********************************************************</strong> -->
<p />
<hr />
<p />
<!-- For significant updates to the topic, consider adding your 'signature' (beneath this editing box) --> <strong>Major updates</strong>:<br /> -- <a class="twikiLink" href="/twiki/bin/view/Main/WillButtinger">WillButtinger</a> - 02 Oct 2014
<p />
<!-- Person responsible for the page: 
Either leave as is - the creator's name will be inserted; 
Or replace the complete REVINFO tag (including percentages symbols) with a name in the form <a class="twikiLink" href="/twiki/bin/view/Main/TwikiUsersName">TwikiUsersName</a> --> 
Responsible: <a class="twikiLink" href="/twiki/bin/view/Main/WillButtinger">WillButtinger</a> <br /> <!-- Once this page has been reviewed, please add the name and the date e.g. <a class="twikiLink" href="/twiki/bin/view/Main/StephenHaywood">StephenHaywood</a> - 31 Oct 2006 --> 
Last reviewed by: <strong>Never reviewed</strong>
<p /> </div><!-- /patternTopic-->
<div class="twikiContentFooter"></div><div class="twikiAttachments">
<div class="twistyPlugin twikiMakeVisibleInline">  <span id="topicattachmentslistshow" class="twistyRememberSetting twistyFirstStartShow twistyTrigger twikiUnvisited twistyHidden twistyInited1"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Attachments</span></a> </span> <span id="topicattachmentslisthide" class="twistyRememberSetting twistyFirstStartShow twistyTrigger twikiUnvisited twistyInited1"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleclose.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Attachments</span></a> </span>  </div><!--/twistyPlugin twikiMakeVisibleInline--> <div class="twistyPlugin"><div id="topicattachmentslisttoggle" class="twistyRememberSetting twistyFirstStartShow twistyContent twistyInited1">
<table border="1" cellpadding="0" cellspacing="0" class="twikiTable" id="twikiAttachmentsTable" rules="rows" summary="Topic attachments"><caption>Topic attachments</caption>
<tr class="twikiTableOdd twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
<th bgcolor="#ffffff" class="twikiTableCol0 twikiFirstCol" valign="middle"> <a href="/twiki/bin/view/AtlasProtected/AthAnalysisBase?sortcol=0;table=6;up=0#sorted_table" rel="nofollow" title="Sort by this column"><font color="#0066cc">I</font></a> </th>
<th bgcolor="#ffffff" class="twikiTableCol1" valign="middle"> <a href="/twiki/bin/view/AtlasProtected/AthAnalysisBase?sortcol=1;table=6;up=0#sorted_table" rel="nofollow" title="Sort by this column"><font color="#0066cc">Attachment</font></a> </th>
<th bgcolor="#ffffff" class="twikiTableCol2" valign="middle"> <a href="/twiki/bin/view/AtlasProtected/AthAnalysisBase?sortcol=2;table=6;up=0#sorted_table" rel="nofollow" title="Sort by this column"><font color="#0066cc">History</font></a> </th>
<th bgcolor="#ffffff" class="twikiTableCol3" valign="middle"> <a href="/twiki/bin/view/AtlasProtected/AthAnalysisBase?sortcol=3;table=6;up=0#sorted_table" rel="nofollow" title="Sort by this column"><font color="#0066cc">Action</font></a> </th>
<th bgcolor="#ffffff" class="twikiTableCol4" valign="middle"> <a href="/twiki/bin/view/AtlasProtected/AthAnalysisBase?sortcol=4;table=6;up=0#sorted_table" rel="nofollow" title="Sort by this column"><font color="#0066cc">Size</font></a> </th>
<th bgcolor="#ffffff" class="twikiTableCol5" valign="middle"> <a href="/twiki/bin/view/AtlasProtected/AthAnalysisBase?sortcol=5;table=6;up=0#sorted_table" rel="nofollow" title="Sort by this column"><font color="#0066cc">Date</font></a> </th>
<th bgcolor="#ffffff" class="twikiTableCol6" valign="middle"> <a href="/twiki/bin/view/AtlasProtected/AthAnalysisBase?sortcol=6;table=6;up=0#sorted_table" rel="nofollow" title="Sort by this column"><font color="#0066cc">Who</font></a> </th>
<th bgcolor="#ffffff" class="twikiTableCol7 twikiLastCol" valign="middle"> <a href="/twiki/bin/view/AtlasProtected/AthAnalysisBase?sortcol=7;table=6;up=0#sorted_table" rel="nofollow" title="Sort by this column"><font color="#0066cc">Comment</font></a> </th>
</tr>
<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
<td align="center" bgcolor="#ffffff" class="twikiTableCol0 twikiFirstCol twikiLast" valign="top"> <img src="/twiki/pub/TWiki/TWikiDocGraphics/png.gif" width="16" height="16" alt="PNG" title="PNG" border="0" /><span class="twikiHidden">png</span> </td>
<td align="left" bgcolor="#ffffff" class="twikiTableCol1 twikiLast" valign="top"> <a href="https://twiki.cern.ch/twiki/pub/AtlasProtected/AthAnalysisBase/arr_logo2.png">arr_logo2.png</a> </td>
<td align="left" bgcolor="#ffffff" class="twikiTableCol2 twikiLast" valign="top"> r1 </td>
<td align="right" bgcolor="#ffffff" class="twikiTableCol3 twikiLast" valign="top"> <a href="/twiki/bin/attach/AtlasProtected/AthAnalysisBase?filename=arr_logo2.png;revInfo=1" title="change, update, previous revisions, move, delete..." rel="nofollow">manage</a> </td>
<td align="left" bgcolor="#ffffff" class="twikiTableCol4 twikiLast" valign="top"> 45.5&nbsp;K </td>
<td align="left" bgcolor="#ffffff" class="twikiTableCol5 twikiLast" valign="top"> <span class="twikiNoBreak">2016-11-15 - 15:22</span> </td>
<td align="left" bgcolor="#ffffff" class="twikiTableCol6 twikiLast" valign="top"> <a class="twikiLink" href="/twiki/bin/view/Main/WillButtinger">WillButtinger</a> </td>
<td align="left" bgcolor="#ffffff" class="twikiTableCol7 twikiLastCol twikiLast" valign="top"> &nbsp; </td>
</tr></table>
</div></div> <!--/twistyPlugin--></div><!--//twikiAttachments--></div><!-- /patternContent-->
<div class="clear"></div>
<a name="topic-actions"></a><div class="patternTopicActions"><div class="patternTopicAction"><span class="patternActionButtons"><span style=''><span><a href='https://twiki.cern.ch/twiki/bin/edit/AtlasProtected/AthAnalysisBase?t=1763376423;nowysiwyg=1' rel='nofollow' title='Edit this topic text' accesskey='e'><img src='/twiki/pub/TWiki/TWikiDocGraphics/uweb-o14.gif' width='14' height='14' border='0' alt='' /> <span class='twikiAccessKey'>E</span>dit</a></span><span class='twikiSeparator'>&nbsp;|&nbsp;</span></span><span style=''><span><a href='/twiki/bin/attach/AtlasProtected/AthAnalysisBase' rel='nofollow' title='Attach an image or document to this topic' accesskey='a'><span class='twikiAccessKey'>A</span>ttach</a></span><span class='twikiSeparator'>&nbsp;|&nbsp;</span></span><span><a href='/twiki/bin/view/AtlasProtected/AthAnalysisBase?cover=print' rel='nofollow' title='Printable version of this topic' accesskey='p'><span class='twikiAccessKey'>P</span>rint version</a></span><span class='twikiSeparator'>&nbsp;|&nbsp;</span><span><span><a href='/twiki/bin/oops/AtlasProtected/AthAnalysisBase?template=oopshistory' rel='nofollow' title='View total topic history' accesskey='h'><span class='twikiAccessKey'>H</span>istory</a></span>: r202&nbsp;<a href="/twiki/bin/rdiff/AtlasProtected/AthAnalysisBase?rev1=202;rev2=201" rel="nofollow">&lt;</a>&nbsp;<a href="/twiki/bin/view/AtlasProtected/AthAnalysisBase?rev=201" rel="nofollow">r201</a>&nbsp;<a href="/twiki/bin/rdiff/AtlasProtected/AthAnalysisBase?rev1=201;rev2=200" rel="nofollow">&lt;</a>&nbsp;<a href="/twiki/bin/view/AtlasProtected/AthAnalysisBase?rev=200" rel="nofollow">r200</a>&nbsp;<a href="/twiki/bin/rdiff/AtlasProtected/AthAnalysisBase?rev1=200;rev2=199" rel="nofollow">&lt;</a>&nbsp;<a href="/twiki/bin/view/AtlasProtected/AthAnalysisBase?rev=199" rel="nofollow">r199</a>&nbsp;<a href="/twiki/bin/rdiff/AtlasProtected/AthAnalysisBase?rev1=199;rev2=198" rel="nofollow">&lt;</a>&nbsp;<a href="/twiki/bin/view/AtlasProtected/AthAnalysisBase?rev=198" rel="nofollow">r198</a></span><span class='twikiSeparator'>&nbsp;|&nbsp;</span><span><a href='/twiki/bin/oops/AtlasProtected/AthAnalysisBase?template=backlinksweb' rel='nofollow' title='Search the AtlasProtected Web for topics that link to here' accesskey='b'><span class='twikiAccessKey'>B</span>acklinks</a></span><span class='twikiSeparator'>&nbsp;|&nbsp;</span><span><a href='/twiki/bin/view/AtlasProtected/AthAnalysisBase?raw=on' rel='nofollow' title='View raw text without formatting' accesskey='r'><span class='twikiAccessKey'>R</span>aw View</a></span><span class='twikiSeparator'>&nbsp;|&nbsp;</span><span style=''><span><a href='https://twiki.cern.ch/twiki/bin/edit/AtlasProtected/AthAnalysisBase?t=1763376423;nowysiwyg=0' rel='nofollow' title='WYSIWYG editor' accesskey='w'>WYSIWYG</a></span><span class='twikiSeparator'>&nbsp;|&nbsp;</span></span><span><a href='/twiki/bin/oops/AtlasProtected/AthAnalysisBase?template=oopsmore&amp;param1=202&amp;param2=202' rel='nofollow' title='Delete or rename this topic; set parent topic; view and compare revisions' accesskey='m'><span class='twikiAccessKey'>M</span>ore topic actions</a></span></span></div><!--/patternTopicAction--></div><!--/patternTopicActions-->
<div class="patternInfo twikiGrayText"><div class="patternRevInfo">Topic revision: r202 - 2021-03-13 <a href="https://twiki.cern.ch/twiki/bin/edit/AtlasProtected/AthAnalysisBase?t=1763376423;nowysiwyg=1" target="_top">-</a> <span class="twikiNewLink"><a href="/twiki/bin/edit/Main/AndresFelipeMorenoSarria?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">AndresFelipeMorenoSarria</a></span></div><!-- /patternRevInfo--></div><!-- /patternInfo-->
</div><!-- /patternMainContents-->
</div><!-- /patternMain--><div id="patternLeftBar"><div id="patternClearHeaderLeft"></div>
<div id="patternLeftBarContents"><div class="patternLoginActions"><span style="padding: 0 0 0 20px; word-wrap:break-word; display:block;"><img src="https://twiki.cern.ch/twiki/pub/TWiki/TWikiDocGraphics/person.gif" style="position:absolute; margin: 0 0 0 -20px;" /> <span class="twikiNewLink"><a href="/twiki/bin/edit/Main/RoySchimmelBrener?topicparent=AtlasProtected.AthAnalysisBase;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">RoySchimmelBrener</a></span></span>  <img src="/twiki/pub/TWiki/TWikiDocGraphics/lock.gif" width="16" height="16" alt="Lock" title="Lock" border="0" /> <a href="https://twiki.cern.ch/twiki/bin/view/AtlasProtected/AthAnalysisBase?logout=1">Log Out</a></div><div class="patternWebIndicator"> <ul>
<li> <a class="twikiCurrentWebHomeLink twikiLink" href="/twiki/bin/view/AtlasProtected/WebHome"><img src="/twiki/pub/TWiki/TWikiDocGraphics/web-bg-small.gif" width="13" height="13" alt="Web background" title="Web background" border="0" /> AtlasProtected</a>
</li></ul> 
</div> <ul>
<li> <strong><a href="https://atlas-collaboration.web.cern.ch" target="_blank"><span style="color: blue">ATLAS Collaboration</span><img alt="" border="0" height="12" src="/twiki/pub/TWiki/TWikiDocGraphics/external-link.gif" width="13" /></a></strong>
</li></ul> 
<hr /> <ul>
<li> <strong><a class="twikiLink" href="/twiki/bin/view/Atlas/WebHome"><span style="color: #0000ff"> ATLAS TWiki</span></verbatim></a></strong>
</li> <li> <strong><a class="twikiCurrentWebHomeLink twikiLink" href="/twiki/bin/view/AtlasProtected/WebHome"><span style="color: #0000ff"> ATLAS Protected</span></verbatim></a></strong>
</li> <li> <strong><a class="twikiLink" href="/twiki/bin/view/AtlasComputing/WebHome"><span style="color: #0000ff"> ATLAS Computing </span></verbatim></a></strong>
</li> <li> <strong><a class="twikiLink" href="/twiki/bin/view/AtlasPublic/WebHome"><span style="color: #0000ff"> Public Results </span></verbatim></a></strong>
</li></ul> 
<hr /> <ul>
<li> <strong><a href="https://its.cern.ch/jira/secure/CreateIssueDetails!init.jspa?pid=22679&amp;issuetype=3&amp;summary=Problem+with+AthAnalysisBase+TWiki+topic&amp;description=The+topic+https://twiki.cern.ch/twiki/bin/viewauth/AtlasProtected/AthAnalysisBase+has+an+issue.+Describe+it+below:&amp;reporter=rbrener" target="_blank"><span style="color: #ff0000"> Report outdated page </span></verbatim><img alt="" border="0" height="12" src="/twiki/pub/TWiki/TWikiDocGraphics/external-link.gif" width="13" /></a></strong>
</li> <li> <strong><a href="mailto&#58;atlas&#45;twiki&#45;support&#64;cern&#46;ch"><span style="color: #ff0000"> Twiki-Support </span></verbatim></a></strong>
</li></ul> 
<hr />
<p /> <ul>
 <li>
 <ul>
<li> <strong><a href="https://twiki.cern.ch/twiki/bin/view/AtlasPublic" target="_top"><span style="color: navy;"> Public Results </span></a></strong>
</li> <li> <strong><a class="twikiLink" href="/twiki/bin/view/AtlasProtected/AtlasPhysics"><span style="color: navy;"> Physics </span></a></strong>
</li> <li> <strong><a class="twikiLink" href="/twiki/bin/view/Atlas/AtlasDetectors"><span style="color: navy;"> Detectors </span></a></strong>
</li> <li> <strong><a class="twikiLink" href="/twiki/bin/view/Atlas/AtlasTrigger"><span style="color: navy;"> Trigger </span></a></strong>
</li> <li> <strong><a class="twikiLink" href="/twiki/bin/view/AtlasComputing/WebHome"><span style="color: navy;"> Computing </span></a></strong>
</li> <li> <strong><a class="twikiLink" href="/twiki/bin/view/Atlas/DataPreparation"><span style="color: navy;"> Data Preparation </span></a></strong>
</li> <li> <a class="twikiLink" href="/twiki/bin/view/Atlas/DocumentationManagement">Documentation Help</a>
</li> <li> <a class="twikiLink" href="/twiki/bin/view/Atlas/AtlasGlossary">Glossary</a>
</li></ul> 
</li></ul> 
<p />
<div class="twikiLeftBarBase">
  <a href="/twiki/bin/edit/AtlasProtected/AthAnalysisBaseLeftBar?templatetopic=AtlasProtected.WebLeftBarTemplate">Create</a> a LeftBar for this page
</div>
<p />
<hr />
<span style="color: #008000"> <img src='https://twiki.cern.ch/twiki/pub/TWiki/TWikiDocGraphics/searchtopic.gif'> <strong><a href="https://search.cern.ch/Pages/TwikiResults.aspx?k=generic2%3AATLAS" target="_blank">TWiki Search<img alt="" border="0" height="12" src="/twiki/pub/TWiki/TWikiDocGraphics/external-link.gif" width="13" /></a></strong> </span></verbatim>
<hr />
<p />
<!-- <ul>
 <li>
 <ul>
<li> <a class="twikiCurrentWebHomeLink twikiLink" href="/twiki/bin/view/AtlasProtected/WebHome">AtlasProtected Wiki</a>
</li></ul> 
</li></ul> 
-->
</div><!-- /patternLeftBarContents--></div><!-- /patternLeftBar-->
</div><!-- /patternFloatWrap-->
<div class="clear">&nbsp;</div>
</div><!-- /patternOuter--></div><!-- /patternWrapper--><div id="patternTopBar"><div id="patternTopBarContents"><table border="0" cellpadding="0" cellspacing="0" style="width:100%; margin-top:12px;">
<tr><td valign="middle"><span id="twikiLogo" class="twikiImage"><a href="https://twiki.cern.ch/twiki/bin/view/AtlasProtected/WebHome"><img src="/twiki/pub/AtlasPublic/AtlasTWikiLogos/AtlasTwikiProtectedLogo.png" border="0" alt="CERN" style="border:none;" /></a></span></td>
<td align="right" valign="top" class="patternMetaMenu">
 <ul>
<li> <form name="jumpForm" action="/twiki/bin/view/AtlasProtected/AthAnalysisBase"><input id="jumpFormField" type="text" class="twikiInputField" name="topic" value="" size="18" /><noscript>&nbsp;<input type="submit" class="twikiButton" size="5" name="submit" value="Jump" />&nbsp;</noscript>   </form>
</li> <li> <form name="quickSearchForm" action="https://search.cern.ch/Pages/TwikiResults.aspx" target="search" class="cernTWikiSearch">    <ul class="engineList" style="background-image: url('https://twiki.cern.ch/twiki/pub/TWiki/CernSearchBar/arrow.png');">        <li class="active" id="twikisearch">            <img src="https://twiki.cern.ch/twiki/pub/TWiki/CernSearchBar/twikisearchicon.gif" alt="TWiki Search Icon" />            <span class="engineDescription">TWiki Search</span>        </li>        <!-- Due to a security incident <a href="https://cern.service-now.com/service-portal?id=outage&amp;n=OTG0156848" target="_blank">OTG0156848<img alt="" border="0" height="12" src="/twiki/pub/TWiki/TWikiDocGraphics/external-link.gif" width="13" /></a>, the legacy CERN Search Service has been shut down        <li id="cernsearch">            <img src="https://twiki.cern.ch/twiki/pub/TWiki/CernSearchBar/cernsearchicon.png" alt="Cern Search Icon" />            <span class="engineDescription">Cern Search</span>        </li>         -->        <li id="googlesearch">            <img class="engine" src="https://twiki.cern.ch/twiki/pub/TWiki/CernSearchBar/googlesearchicon.png" alt="Google Search Icon" />            <span class="engineDescription">Google Search</span>        </li>    </ul>    <input type="text" class="twikiInputField" id="quickSearchBox" name="k" value="" size="18" /> <br />    <input type="radio" name="scope" value=Atlas checked />     <span class="webScopeDescription">Atlas</span>    <input type="radio" name="scope" value="AllWebs" />    <span class="allWebsScopeDescription">All webs</span>    <input type='hidden' name='autologin' value='1'/>     <noscript>        &nbsp; <input type="submit" size="5" class="twikiButton" name="submit" value="Search"/>&nbsp;    </noscript>
</li></ul> 
</form>
<p />
<p />
<!-- <pre> -->
<script language="javascript">
<!--
$(function() {
    // We use the current web name to form the redirect in the TWiki search
    var currentWeb = undefined;
    // If the web starts with alice* atlas* cms* or lhcb* (case-insensitive),
    // the "Web search" should be altered so that AtlasFoo => Atlas
    var specialWeb = undefined;
    // Remembering what the user have entered into the searchbox to after
    // he has selected a new search engine from the dropdown
    var searchPhrase = '';

    // --- BEGIN: CONFIGURABLE LIST FOR SUBWEB SEARCH ---
    // List of webs for which sub-web searching should be enabled
    var subWebSearchWebs = ['AtlasProtected', 'AtlasComputing', 'Atlas'];
    // --- END: CONFIGURABLE LIST FOR SUBWEB SEARCH ---

    // --- ORIGINAL WEB DETECTION LOGIC ---
    // We want to store the current web for later use.
    var currentWebSearch = window.location.pathname.match(/\/([A-Z][^\/]+)/);
    if (currentWebSearch != null) {
        currentWeb = currentWebSearch[1];

        // Do we have a special kind of web? If so, the web search should be altered a little to fetch more broader results.
        var specialWebSearch = currentWeb.match(/^(alice|atlas|cms|lhcb)/i);
        if (specialWebSearch != null) {
            var lowercaseToCorrect = {
                'alice' : 'Alice',
                'atlas' : 'Atlas',
                'cms'   : 'CMS',
                'lhcb'  : 'LHCb'
            };
            specialWeb = lowercaseToCorrect[specialWebSearch[1].toLowerCase()];
            $('span.webScopeDescription').text(specialWeb);
        }
    } else {
        currentWeb = 'DefaultWeb';
    }

    // --- BEGIN: SUBWEB LOGIC TO EXTRACT SUBWEB PATH (EXCLUDING TOPIC) ---
    var subWebSearchWebs = ['AtlasProtected', 'AtlasComputing', 'Atlas'];
    // Build regex to match web/subweb path and topic
    var subWebsPattern = new RegExp(
        '/((' + subWebSearchWebs.join('|') + ')(?=(?:/|$))(?:/[A-Za-z0-9_]+)*)/([A-Za-z0-9_]+)$'
    );
    var subWebMatch = window.location.pathname.match(subWebsPattern);
    if (subWebMatch) {
        // subWebMatch[1] is the full web/subweb path (e.g. "AtlasComputing/AtlasComputingArchive")
        // subWebMatch[3] is the topic (e.g. "WebHome")
        currentWeb = subWebMatch[1];
        specialWeb = currentWeb;
        $('span.webScopeDescription').text(specialWeb);
    }
    // --- END: SUBWEB LOGIC TO EXTRACT SUBWEB PATH (EXCLUDING TOPIC) ---

    // Do we have a favourite search engine in localStorage? We set Twiki search as default anyways
    if (window.localStorage) {
        // var storedEngine = localStorage.getItem('defaultSearchEngine');
        // console.log('stored engine preference: ' + storedEngine);
        var storedEngine = 'twikisearch';
        var storedEngineLi = $('.cernTWikiSearch li#' + storedEngine);
        if (!storedEngineLi.hasClass('active')) {
            changeActiveSearchEngine(storedEngineLi);
        }
        if (storedEngine == 'twikisearch') {
            $('input[name=scope][value=AllWebs]').attr('disabled','disabled');
            $('.allWebsScopeDescription').addClass('disabled');
        }
    }
    
    // Toggle the searchEngines list on and off on click
    $('.cernTWikiSearch ul.engineList').click(function(e) {
        e.stopPropagation();
        if ($(this).hasClass('open')) {
            $(this).removeClass('open');
        } else {
            $(this).addClass('open');
        }
    });

    // Stupid IE8 hack because the click handler on ul.engineList does not work properly there.
    if ($.browser.msie && document.documentMode && document.documentMode < 9) {
        $('.cernTWikiSearch #quickSearchBox').focus(function(e) {
            $('.cernTWikiSearch ul.engineList').removeClass('open');
        });
    }
    
    // Handle clicks on one of the search engines
    $('.cernTWikiSearch ul.engineList li').click(function(e) {
        // If we clicked on a <li> that does not has class 'active', it means this should become active and swap places with this.
        if (!$(this).hasClass('active')) {
            changeActiveSearchEngine($(this));
        }  
        if ($(this).parent().hasClass('open')) {
            $('.cernTWikiSearch #quickSearchBox').val(searchPhrase);
            $('.cernTWikiSearch #quickSearchBox').focus();                          
        }
        if ($(this).attr('id') == 'twikisearch') {
            var allWebsRadio = $('input[name=scope][value=AllWebs]');
            allWebsRadio.attr('disabled','disabled');
            allWebsRadio.siblings('input[type=radio]').attr('checked',true)
            $('.allWebsScopeDescription').addClass('disabled');
        } else {
            $('input[name=scope][value=AllWebs]').attr('disabled','');
            $('.allWebsScopeDescription').removeClass('disabled');
        }
    });
    
    // Show the engine description text on hover
    $('.engineList.open li').live('hover',function() {
        var displayText = $(this).find('span.engineDescription').text();
        $('.cernTWikiSearch #quickSearchBox').val(displayText);
    });


    // The form is submitted, now let's do the search.
    $('.cernTWikiSearch').submit(function(e) {
        e.preventDefault();

        var scope = $('input[name=scope]:checked', $(this)).val();
        if (scope != 'AllWebs' && specialWeb !== undefined) {
            scope = specialWeb;
        }
        var val = $('.cernTWikiSearch #quickSearchBox').val();
        var engine = $('.engineList li.active').attr('id')
        
        switch (engine) {
            case 'googlesearch':
                window.open('https://google.com/search?q=site:' + encodeURIComponent('https://twiki.cern.ch') + (scope != 'AllWebs' ? ' ' + scope : '') + ' ' + val);
                break;
            case 'cernsearch':
                window.open('https://search.cern.ch/Pages/TwikiResults.aspx?k=' + val + (scope != 'AllWebs' ? ' cernscope:' + scope : '') + '&autologin=1');
                break;
            case 'twikisearch':
                window.open(window.location.pathname.replace(/\/[A-Z].+$/,'') + '/' + currentWeb + '/WebSearch?search=' + val + '&scope=all');
                break;
        default:
            break;
        }
        
        // Save the search engine. If the user reloads the page he should get the last one used.
        if (window.localStorage) { 
            console.log('store engine preference: ' + engine);
            localStorage.setItem('defaultSearchEngine',engine);
        }
    });
    
    // Save the search phrase on every key up
    $('.cernTWikiSearch #quickSearchBox').keyup(function() {
        searchPhrase = $(this).val();
    });
    
    // If a user clicks outside the search engine list, the search engine list should be closed.
    $('html').click(function() {
        if ($('.engineList').hasClass('open')) {
            $('.engineList').removeClass('open');
            $('.cernTWikiSearch #quickSearchBox').val(searchPhrase);
        }
    });
});

// We want to change the active search engine
function changeActiveSearchEngine(engineLi) {
    var activeEngine = engineLi.siblings(':first');
    engineLi.detach().insertBefore(activeEngine);
    activeEngine.removeClass('active');
    engineLi.addClass('active');
    if (engineLi.attr('id') == 'twikiSearch') {
        deactivateAllWebsOption();
    }
}

// The user has chosen twiki search (or the preference was stored in localStorage). 
// We will then disable the 'All Webs' option since this will time out.
function deactivateAllWebsOption() {
}

// Helper method to check input attribute browser compability
function checkInputAttributeSupport(attribute) {
    var i = document.createElement("input");
    return typeof i.placeholder !== 'undefined';
}
//-->
</script>
<!-- </pre> --> <ul>
<li> 
</li></ul> 
</td></tr></table></div></div><!-- /patternTopBar--><div id="patternBottomBar"><div id="patternBottomBarContents"><div id="patternWebBottomBar"><div class="twikiCopyright"><span class="twikiRight"> <a href="http://twiki.org/"><img src="/twiki/pub/TWiki/TWikiLogos/T-badge-88x31.gif" alt="This site is powered by the TWiki collaboration platform" width="88" height="31" title="This site is powered by the TWiki collaboration platform" border="0" /></a></span><span class="twikiRight" style="padding:0 10px 0 10px"> <a href="http://www.perl.org/"><img src="/twiki/pub/TWiki/TWikiLogos/perl-logo-88x31.gif" alt="Powered by Perl" width="88" height="31" title="Powered by Perl" border="0" /></a></span>Copyright &amp; 2008-2025 by the contributing authors. All material on this collaboration platform is the property of the contributing authors. <br />  or Ideas, requests, problems regarding TWiki? use <a href="https://discourse.web.cern.ch/c/collaborative-editing/wikis/12">Discourse</a> or <a href='https://twiki.cern.ch/twiki/bin/view/Main/ServiceNow'>Send feedback</a> </div><!--/twikiCopyright--></div><!--/patternWebBottomBar--></div><!-- /patternBottomBarContents--></div><!-- /patternBottomBar-->
</div><!-- /patternPage-->
</div><!-- /patternPageShadow-->
</div><!-- /patternScreen-->
<p />
<p />
<p />
<!-- Matomo -->
<script>
  var _paq = window._paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
	 var u="https://webanalytics.web.cern.ch/";
	 _paq.push(['setTrackerUrl', u+'matomo.php']);
	 _paq.push(['setSiteId', '5']);
	 var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
	 g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Matomo Code -->
<p />
</body></html>