<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<script type="text/javascript" src="/twiki/pub/TWiki/JQueryPlugin/jquery.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/JQueryPlugin/jquery-migrate.js"></script>
<link rel="stylesheet" href="/twiki/pub/TWiki/JQueryPlugin/jquery-all.css" type="text/css" media="all" />
<script type="text/javascript" src="/twiki/pub/TWiki/JQueryPlugin/jquery-all.js"></script>
<link rel="stylesheet" href="https://twiki.cern.ch/twiki/pub/TWiki/ImagePlugin/style.css" type="text/css" media="all" />
<link rel="stylesheet" href="https://twiki.cern.ch/twiki/pub/TWiki/ImageGalleryPlugin/style.css" type="text/css" media="all" />
<title> TopRun2WorkshopTutorial2017 &lt; AtlasProtected &lt; TWiki</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<link rel="icon" href="/twiki/pub/AtlasProtected/WebPreferences/favicon_new.ico" type="image/x-icon" />
<link rel="shortcut icon" href="/twiki/pub/AtlasProtected/WebPreferences/favicon_new.ico" type="image/x-icon" />
<link rel="alternate" href="https://twiki.cern.ch/twiki/bin/edit/AtlasProtected/TopRun2WorkshopTutorial2017?t=1763376494" type="application/x-wiki" title="Edit TopRun2WorkshopTutorial2017" />
<link rel="edit" href="https://twiki.cern.ch/twiki/bin/edit/AtlasProtected/TopRun2WorkshopTutorial2017?t=1763376494" title="Edit TopRun2WorkshopTutorial2017" />
<meta name="SCRIPTURLPATH" content="/twiki/bin" />
<meta name="SCRIPTSUFFIX" content="" />
<meta name="TEXT_JUMP" content="Jump" />
<meta name="TEXT_SEARCH" content="Search" />
<meta name="TEXT_NUM_TOPICS" content="Number of topics:" />
<meta name="TEXT_MODIFY_SEARCH" content="Modify search" />
<link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/twiki/bin/view/AtlasProtected/WebRss" />
<base href="https://twiki.cern.ch/twiki/bin/view/AtlasProtected/TopRun2WorkshopTutorial2017"></base>
<!--BEHAVIOURCONTRIB--><script type="text/javascript" src="/twiki/pub/TWiki/BehaviourContrib/behaviour.compressed.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikilib.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiWindow.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiEvent.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiHTML.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiCSS.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiForm.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/PatternSkin/pattern.js"></script>
<style type="text/css" media="all">
@import url('/twiki/pub/TWiki/TWikiTemplates/base.css');
</style>
<style type="text/css" media="all">
#patternTopBar,
#patternClearHeaderCenter,
#patternClearHeaderLeft,
#patternClearHeaderRight,
#patternTopBarContentsOuter,
#patternTopBarContents {
	height:64px; /* top bar height; make room for header columns */
	overflow:hidden;
}
#patternOuter {
	margin-left:14em;
}
#patternLeftBar {
	width:14em;
	margin-left:-14em;
}
</style>
<style type="text/css" media="all">
@import url('/twiki/pub/TWiki/PatternSkin/layout.css');
@import url('/twiki/pub/TWiki/PatternSkin/style.css');
@import url('/twiki/pub/TWiki/PatternSkin/colors.css');
</style>
<style type="text/css" media="all">
	/* Styles that are set using variables */
	.patternBookView .twikiTopRow,
	.patternWebIndicator a img,
	.patternWebIndicator a:hover img {
		background-color:#0b048c ;
	}
	#patternTopBarContents { background-image:url(/twiki/pub/TWiki/PatternSkin/TWiki_header.gif); background-repeat:no-repeat;}
	
	.patternBookView {
		border-color:#0b048c ;
	}
	.patternPreviewPage #patternMain {
		/* uncomment to set the preview image */
		/*background-image:url("/twiki/pub/TWiki/PreviewBackground/preview2bg.gif");*/
	}
	
</style><style type="text/css" media="all">



</style>
<style type="text/css" media="all">
	@import url("/twiki/pub/TWiki/PatternSkin/print.css");
</style>
<!--[if IE]><style type="text/css" media="screen">
pre {
	overflow-x:auto;
	padding-bottom:expression(this.scrollWidth > this.offsetWidth ? 16 : 0);
}
</style>
<![endif]-->
<!--[if lte IE 6]> 
<style type="text/css">
#patternLeftBar {
	position:relative; /* IE 5.5 needs this or the contents won't show outside the parent container on print. IE 6.0 needs it only during printable copy! */
}
</style><![endif]-->
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiStyles.js"></script>

<script src="https://twiki.cern.ch/twiki/pub/TWiki/ChecklistPlugin/itemstatechange.js" language="javascript" type="text/javascript"></script><!--GENERATED_HEADERS--><!-- TWISTYPLUGIN_TWISTY --> <style type="text/css" media="all">
@import url("https://twiki.cern.ch/twiki/pub/TWiki/TwistyContrib/twist.css");
</style>
<script type='text/javascript' src='https://twiki.cern.ch/twiki/pub/TWiki/BehaviourContrib/behaviour.compressed.js'></script>
<script type="text/javascript" src="https://twiki.cern.ch/twiki/pub/TWiki/TWikiJavascripts/twikilib.js"></script>
<script type="text/javascript" src="https://twiki.cern.ch/twiki/pub/TWiki/TWikiJavascripts/twikiPref.js"></script>
<script type="text/javascript" src="https://twiki.cern.ch/twiki/pub/TWiki/TWikiJavascripts/twikiCSS.js"></script>
<script type="text/javascript" src="https://twiki.cern.ch/twiki/pub/TWiki/TwistyContrib/twist.compressed.js"></script>
<script type="text/javascript">
// <![CDATA[
var styleText = '<style type="text/css" media="all">.twikiMakeVisible{display:inline;}.twikiMakeVisibleInline{display:inline;}.twikiMakeVisibleBlock{display:block;}.twikiMakeHidden{display:none;}</style>';
document.write(styleText);
// ]]>
</script>

<!-- CERNSEARCHBAR_CSS --> <link rel='stylesheet' href='/twiki/pub/TWiki/CernSearchBar/CernSearchBar.css' type='text/css' media='all' /></head>
<body class="patternViewPage">
<a name="PageTop"></a>
<div id="patternScreen">
<div id="patternPageShadow">
<div id="patternPage">
<div id="patternWrapper"><div id="patternOuter">
<div id="patternFloatWrap">
<div id="patternMain"><div id="patternClearHeaderCenter"></div>
<div id="patternMainContents"><div class="patternTop"><span class="patternHomePath twikiLeft"><a class="twikiLink" href="/twiki/bin/view/Main/WebHome">TWiki</a><span class='twikiSeparator'>&gt;</span><img src="/twiki/pub/TWiki/TWikiDocGraphics/web-bg-small.gif" border="0" alt="" width="13" height="13" style="background-color:#0b048c " />&nbsp;<a href="/twiki/bin/view/AtlasProtected/WebHome">AtlasProtected Web</a><span class='twikiSeparator'>&gt;</span><a class="twikiLink" href="/twiki/bin/view/AtlasProtected/AtlasPhysics">AtlasPhysics</a><span class='twikiSeparator'>&gt;</span><a class="twikiLink" href="/twiki/bin/view/AtlasProtected/TopWorkingGroup">TopWorkingGroup</a><span class='twikiSeparator'>&gt;</span><a class="twikiLink" href="/twiki/bin/view/AtlasProtected/TopReconstructionGroup">TopReconstructionGroup</a><span class='twikiSeparator'>&gt;</span><a class="twikiLink" href="/twiki/bin/view/AtlasProtected/TopxAODStartGuide">TopxAODStartGuide</a><span class='twikiSeparator'>&gt;</span><a href="https://twiki.cern.ch/twiki/bin/view/AtlasProtected/TopRun2WorkshopTutorial2017" title='Topic revision: 29 (2018-05-22 - 16:28:20)'>TopRun2WorkshopTutorial2017</a> <span class='patternRevInfo'>(2018-05-22, <a class="twikiLink" href="/twiki/bin/view/Main/TimotheeTheveneauxPelzer">TimotheeTheveneauxPelzer</a>)</span></span><!-- /patternHomePath--><span class="patternToolBar twikiRight"><span><a href='https://twiki.cern.ch/twiki/bin/edit/AtlasProtected/TopRun2WorkshopTutorial2017?t=1763376494;nowysiwyg=1' rel='nofollow' title='Edit this topic text' accesskey='e'><img src='/twiki/pub/TWiki/TWikiDocGraphics/uweb-o14.gif' width='14' height='14' border='0' alt='' /> <span class='twikiAccessKey'>E</span>dit</a></span><span><a href='/twiki/bin/attach/AtlasProtected/TopRun2WorkshopTutorial2017' rel='nofollow' title='Attach an image or document to this topic' accesskey='a'><span class='twikiAccessKey'>A</span>ttach</a></span><span><a href='/twiki/bin/genpdf/AtlasProtected/TopRun2WorkshopTutorial2017' rel='nofollow' title='Create a PDF file for the topic' accesskey='f'><span class='twikiAccessKey'>P</span>DF</a></span></span><!-- /patternToolBar--><br class="twikiClear" /></div><!--/patternTop--><div class="twikiContentHeader"></div><div class="patternContent"><div class="patternTopic"> <table align="right"> <tbody> <tr><th><br />Responsible:<br>(no spam please!)</th></tr> <tr> <td align="center"><br /> <br />Main.TimotheeTheveneauxPelzer</td> </tr> </tbody> </table> 
<p />
 <br />
<p />
<h1><a name="TopRun2WorkshopTutorial2017"></a> <a class="twikiCurrentTopicLink twikiLink" href="/twiki/bin/view/AtlasProtected/TopRun2WorkshopTutorial2017">TopRun2WorkshopTutorial2017</a> </h1>
<p />
<div class="twikiToc"> <ul>
<li> <a href="#TopRun2WorkshopTutorial2017"> TopRun2WorkshopTutorial2017 </a>
</li> <li> <a href="#1_Getting_Started"> 1. Getting Started </a>
</li> <li> <a href="#2_Setup_run_time_environment_nee"> 2. Setup run-time environment (needs to be done for each new shell) </a>
</li> <li> <a href="#3_Running_locally"> 3. Running locally </a> <ul>
<li> <a href="#3_1_Make_a_flat_ntuple_containin"> 3.1 Make a flat ntuple containing only corrected and selected objects </a>
</li> <li> <a href="#3_2_Modify_the_event_selection_l"> 3.2 Modify the event selection locally </a>
</li> <li> <a href="#3_3_Compare_the_two_output_files"> 3.3 Compare the two output files </a>
</li> <li> <a href="#3_4_Run_the_selection_together_w"> 3.4 Run the selection together with event reconstruction </a>
</li> <li> <a href="#3_5_Run_the_event_selection_and"> 3.5 Run the event selection and make an xAOD output file </a>
</li> <li> <a href="#3_6_Optional_Converting_your_min"> 3.6 (Optional) Converting your mini-xAOD to a flat ntuple </a>
</li></ul> 
</li> <li> <a href="#4_Submit_a_job_to_the_grid"> 4 Submit a job to the grid </a> <ul>
<li> <a href="#4_1_Get_a_copy_of_the_helper_scr"> 4.1 Get a copy of the helper scripts </a>
</li> <li> <a href="#4_2_Submission"> 4.2 Submission </a>
</li> <li> <a href="#4_2_X_Job_submission_sans_script"> 4.2.X Job submission sans scripts </a>
</li> <li> <a href="#4_3_Grid_job_monitoring"> 4.3 Grid job monitoring </a>
</li></ul> 
</li> <li> <a href="#5_Making_changes"> 5. Making changes </a> <ul>
<li> <a href="#5_1_Change_the_object_selection"> 5.1 Change the object selection (and calculate a scale factor like quantity) </a> <ul>
<li> <a href="#5_1_1_Look_at_existing_object_se"> 5.1.1 Look at existing object selection </a>
</li> <li> <a href="#5_1_2_Make_a_new_empty_package"> 5.1.2 Make a new, empty, package </a>
</li> <li> <a href="#5_1_3_Update_the_CMakeLists_txt"> 5.1.3 Update the CMakeLists.txt </a>
</li> <li> <a href="#5_1_4_Add_your_new_object_select"> 5.1.4 Add your new object selection </a>
</li> <li> <a href="#5_1_5_Update_LinkDef_h"> 5.1.5 Update LinkDef.h </a>
</li> <li> <a href="#5_1_6_Compile"> 5.1.6 Compile </a>
</li> <li> <a href="#5_1_7_Run"> 5.1.7 Run </a>
</li></ul> 
</li></ul> 
</li> <li> <a href="#6_Analysis_of_grid_output_Option"> 6 Analysis of grid-output (Optional) </a> <ul>
<li> <a href="#6_1_Download_output_files"> 6.1 Download output files </a>
</li> <li> <a href="#6_2_Check_if_the_download_is_com"> 6.2 Check if the download is complete </a>
</li></ul> 
</li> <li> <a href="#7_Run_with_systematic_uncertaint"> 7 Run with systematic uncertainties </a>
</li> <li> <a href="#8_Add_you_own_boosted_jet_select"> 8 Add you own boosted jet selector </a> <ul>
<li> <a href="#8_1_Make_the_large_R_jet_object"> 8.1 Make the large-R jet object </a>
</li> <li> <a href="#8_2_Create_new_selector_class"> 8.2 Create new selector class </a>
</li> <li> <a href="#8_3_Define_the_AnalysisLoader"> 8.3 Define the AnalysisLoader </a>
</li> <li> <a href="#8_4_Use_new_class_in_analysis"> 8.4 Use new class in analysis </a>
</li></ul> 
</li> <li> <a href="#9_Dynamic_keys"> 9 Dynamic keys </a>
</li> <li> <a href="#10_Normalisation_to_the_integrat"> 10 Normalisation to the integrated luminosity </a> <ul>
<li> <a href="#10_1_Retrieving_the_integrated_l"> 10.1 Retrieving the integrated luminosity </a>
</li> <li> <a href="#10_2_Retrieving_the_number_of_pr"> 10.2 Retrieving the number of processed MC events </a>
</li> <li> <a href="#10_3_Retrieving_the_cross_sectio"> 10.3 Retrieving the cross-section of the MC sample </a>
</li></ul> 
</li> <li> <a href="#11_Internal_generator_reweightin"> 11 Internal generator reweighting </a>
</li></ul> 
</div>
<p />
<p />
<p />
<h1><a name="1_Getting_Started"></a> 1. Getting Started </h1>
<p />
 <a class="twikiLink" href="/twiki/bin/view/AtlasProtected/AnalysisTop">AnalysisTop</a> consists of a large number of packages (about 153 at the moment) and it takes a long time to compile all of those locally and on the grid. To save you this work, we regularly build pre-compiled versions on cvmfs and on the grid, that you can use directly. Many people will be familiar with RootCore which has been used since Run-1 but now in Release 21 we will be moving away from RootCore to manage our software packages and moving to CMake (and in principal Git, but for now we give instructions relating to SVN). If you are familiar with RootCore, it will be useful to look at this <a class="twikiLink" href="/twiki/bin/view/AtlasComputing/RootCoreToCMake">twiki page</a> which is designed to show the change in build steps and commands that we will be using below.
<p />
 Login to lxplus.cern.ch.
<p />
 Make a directory:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>mkdir AnalysisTop-2.6.2
<B><FONT COLOR="#A020F0">cd</FONT></B> AnalysisTop-2.6.2
<B><FONT COLOR="#A020F0">export</FONT></B> TUTORIAL=$PWD
mkdir source build run
<B><FONT COLOR="#A020F0">cd</FONT></B> $TUTORIAL/source</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 With athena/CMake based setups, the source directory is used to hold any project information and packages. The build directory is used to compile out-of-source, and after compilation we can use the run directory hold any input/output. This should be considered the standard method for building projects in Release 21.
<p />
 Then make a file called setup.sh that contains:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>setupATLAS
lsetup panda
lsetup rucio
lsetup pyami</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 Run this script:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>source setup.sh
asetup AnalysisTop,2.6.2,here</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 This will produce a CMakeLists.txt file in your source folder which is for building AnalysisTop.<br /><br />Warning: it is important that the commands related to grid (lsetup panda, lsetup rucio, lsetup pyami), that you'll bundle in this setup.sh script, are run before the asetup command (otherwise you'll be facing problems in the rest of the tutorial).
<p />
 To find a list of packages included in this build, and then checkout the trunk of TopAnalysis, you can run:
<sticky><!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>svnco -a</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 You can search for the TopAnalysis package in this list; normally it should be TopAnalysis-00-05-27 which comes with AnalysisTop-2.6.2. For this tutorial, we need a more recent tag, so run the following to checkout the tag we need:
<sticky><!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>svnco TopAnalysis-00-05-30</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 Note that to checkout the trunk (e.g. for code developpment), you would have to do svnco TopAnalysis.
<p />
 To build a local copy of <a class="twikiLink" href="/twiki/bin/view/AtlasProtected/AnalysisTop">AnalysisTop</a> using the local packages you have checked out, you need to move to the build directory and then run the following (don't run cmake in the source folder otherwise you end up with a lot of files in the wrong place):
<sticky><!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#A020F0">cd</FONT></B> $TUTORIAL/build
cmake ../source
cmake --build ./</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 CMake will use the project configuration, identify local packages and configure everything to be build locally. We then compile using cmake to ensure all enviroment variables are correctly propagated through all compilation steps. When this compilation completes successfully, you will find a folder which the name ${CMTCONFIG} (eg. x86_64-slc6-gcc49-opt), and inside this folder is the installtion area. To then load all variables into your PATH, you need to run:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>source ${CMTCONFIG}/setup.sh</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 Each time you add new packages to your source folder, you need to rerun the cmake configruation and compilation, and resource the enviroment.
<p />
 Note, if setupATLAS didn't work for you, you might need to do this first:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#A020F0">export</FONT></B> ATLAS_LOCAL_ROOT_BASE=/cvmfs/atlas.cern.ch/repo/ATLASLocalRootBase
alias setupATLAS='source ${ATLAS_LOCAL_ROOT_BASE}/user/atlasLocalSetup.sh'</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
<h1><a name="2_Setup_run_time_environment_nee"></a> 2. Setup run-time environment (needs to be done for each new shell) </h1>
<p />
 When you return to an environment setup with athena, it requires a couple more steps than were previously required with RootCore.
<sticky><!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#A020F0">cd</FONT></B> $TUTORIAL/source

<I><FONT COLOR="#B22222">#This is the file you made in the previous step
</FONT></I><I><FONT COLOR="#B22222">#that sets-up AMI, panda and rucio (dq2 is no more).
</FONT></I>source setup.sh
asetup AnalysisTop,2.6.2,here
<B><FONT COLOR="#A020F0">cd</FONT></B> $TUTORIAL/build
source ${CMTCONFIG}/setup.sh</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 If you don't want to specify the <a class="twikiLink" href="/twiki/bin/view/AtlasProtected/AnalysisTop">AnalysisTop</a> version, you can do asetup --restore instead of asetup <a class="twikiLink" href="/twiki/bin/view/AtlasProtected/AnalysisTop">AnalysisTop</a>,2.6.2,here. It will use the file <code>$TUTORIAL/source/.asetup.save</code> to determine the project name (<a class="twikiLink" href="/twiki/bin/view/AtlasProtected/AnalysisTop">AnalysisTop</a>) and its version (2.6.2). But you would still have to run the <code>${CMTCONFIG}/setup.sh</code> script afterwards.
<br />Note that if you only source the enviroment script in the build directory, you will experience runtime errors. If you are continuing development, it is reccommended you fully clean your build directory before you continue:
<sticky><!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#A020F0">cd</FONT></B> $TUTORIAL/build
rm -rf *
cmake ../source
cmake --build ./
source ${CMTCONFIG}/setup.sh</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
<h1><a name="3_Running_locally"></a> 3. Running locally </h1>
<p />
 The main program you will be using today is called top-xaod and is installed such that you can call it without having to specify the path of the executable (also known as magic).
<p />
 One additional bit of magic which comes from athena is the use of the get_files script. Once asetup has been run, one can do the following:
<sticky><!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#A020F0">cd</FONT></B> $TUTORIAL/run
get_files validation.py
get_files validation-cuts.txt
get_files input-mc-rel21.txt</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
<h2><a name="3_1_Make_a_flat_ntuple_containin"></a> 3.1 Make a flat ntuple containing only corrected and selected objects </h2>
<p />
 This code, top-xaod, takes the input and applies the CP corrections and object selection. After that it does the event-level cuts specified in the configuration file, with only corrected and selected objects written out, and only for those events that pass the selection.
<p />
 To jump straight in we can try to run on some events from a test MC16 ttbar sample. The code needs two inputs: a steering file that specify the object definition, settings and cuts, as well as a file that has a list of samples to run over. We have provided both for your first test already, so from your run directory, do:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>top-xaod validation-cuts.txt input-mc-rel21.txt</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 In case you want to run on data, you can try with input-data-rel21.txt after retrieving it with get_files as above - but for this tutorial we'll keep running on MC.
<p />
 Now the event selection is running and once its done you should see in your shell five different cut flows: three for the dilepton channel and two for the lepton+jets channel. If you now do an ls in your folder, you will see that you have now a file called output.root . Please open it:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>root -l output.root</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 and open it with a TBrowser:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>new TBrowser()</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 Now you can have a look at its content. You will see five folders and three trees inside. Lets start with the folders: one folder per selected channel is available. If you click for example on the ejets folder, you will find the content of the cutflow stored in histograms. Futhermore you find histograms for the events that survived the electron+jets selection, containing information about all objects and event information like weights, missing et, etc.
<p />
 Lets now have a look at the trees. The most important tree for today is the nominal tree. It contains the information of all five selections together stored in branches and allows for further analysis of the event. For each type of selection there is a boolean variable stored that tells you if the event passed the specific selection or not. If you for example click in that tree on the ejets branch, you will find that out of the 3524 events that are in the tree, about 1738 have been selected by the electron+jets channel.
<p />
<h2><a name="3_2_Modify_the_event_selection_l"></a> 3.2 Modify the event selection locally </h2>
<p />
 Now lets have a closer look at the exact settings and play with them.Open the file validation-cuts.txt to examine its content. As a first step, please find the line:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>OutputFilename output.root
<I><FONT COLOR="#B22222">## and modify it to:
</FONT></I>OutputFilename output-modifiedSelection.root</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 In this way, we won't overwrite the first output file that was created. Now lets modify the electron+jets selection. For that, go futher down in the steering file and find the line starting with SELECTION ejets . For the cut on the number of jets for example you can find four columns: The first column defines the cut, the second column defines the current default cut value on the transverse momentum used in the object definition (that value you cannot change here), the third column defines the relation and the last value defines the number of jets. So in total this line means: select events with at least 1 jet as defined in the object definition. Now lets modify something! Lets start with the cut on the missing transverse energy (MET) that in your previous selection a few minutes ago was defined as &gt; 30000 MeV. Change it to 20000 MeV and close the file. Run the selection again now, using the LOCAL version of the validation-cuts.txt file:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>top-xaod validation-cuts.txt input-mc-rel21.txt</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 Now you should see in the output on the screen, that the cutflows for all channels are unchanged, except for the selection of the ejets channel. The total number of events selected should be now 3701 events, with 1915 events selected in the ejets channel.
<p />
<h2><a name="3_3_Compare_the_two_output_files"></a> 3.3 Compare the two output files </h2>
<p />
 You have now two output root files that contain trees as well as histograms. If you now would like to make a quick cross check if your change has been applied successfully, we have a script provided for you that can to that. First make the output folder for the plots:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>mkdir comparison_plots</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 And now run the python script as follows:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>validation.py comparison_plots/ output.root output-modifiedSelection.root</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 If you now do an ls in the comparison_plots folder, you should be able to see a long list of plots, as well as an html file. If you open the html file as follows:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>firefox comparison_plots/index.html </pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 you can conveniently browse through the plots and see if they changed. Can you find the change in your missing ET distribution?
<p />
<h2><a name="3_4_Run_the_selection_together_w"></a> 3.4 Run the selection together with event reconstruction </h2>
<p />
 In many analyses it is neccessary not only to select the events, but also make a full event reconstruction to be able to reconstruct the top quark or W-boson quantities. One possibility to do that is to use the kinematic likelihood fitter package KLFitter . This package is already part of <a class="twikiLink" href="/twiki/bin/view/AtlasProtected/AnalysisTop">AnalysisTop</a> and can be easily run with your event selection. To test this, please open the validation-cuts.txt file again and modify the following values:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>OutputFilename output-modifiedSelection.root
<I><FONT COLOR="#B22222">## and modify it to:
</FONT></I>OutputFilename output-modifiedSelection_KLFitter.root</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 and then find for the ejets and mujets selection the following lines:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><I><FONT COLOR="#B22222">#RECO::KLFITTERRUN kElectron
</FONT></I><I><FONT COLOR="#B22222">#RECO::KLFITTERRUN kMuon
</FONT></I></pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 and comment them in by removing the hash. These two lines would enable KLFitter; the first one is relevant for the electron+jets channel, and the second one for the muon+jets channel. <br /><br />The event reconstruction is a bit CPU intensive, so we run it only over a subset of events. This is done by commenting in the line:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><I><FONT COLOR="#B22222">#NEvents 500
</FONT></I></pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 in the validation-cuts.txt file.
<p />
 Now run the selection again:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>top-xaod validation-cuts.txt input-mc-rel21.txt</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 This step will run a bit longer than the previous step, since the event reconstruction takes more CPU to calculate all possible jet permutations. So only comment the KLFitter in if you really need it in your analysis!
<p />
 Now open the output file:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>root output-modifiedSelection_KLFitter.root
new TBrowser()</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 and you will see that the variables calculated for the KLFitter are stored in the nominal tree now as well.
<p />
<h2><a name="3_5_Run_the_event_selection_and"></a> 3.5 Run the event selection and make an xAOD output file </h2>
<p />
 Instead of writing out a flat ntuple you can also write out the file in the original xAOD format. To be able to do this, you need to edit the steering file validation-cuts.txt again.
<p />
 First rename the output file as follows:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>OutputFilename output-xAOD.root</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 and change the line:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>OutputFormat top::EventSaverFlatNtuple</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 to
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>OutputFormat top::EventSaverxAODNext</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 and also add the following (in order to set the b-tagging discriminant to the correct one)
<sticky><!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>BTagVariableSaveList MV2c10_discriminant</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 close the file, and run the event selection again.
<p />
<img src="/twiki/pub/TWiki/TWikiDocGraphics/warning.gif" width="16" height="16" alt="Warning, important" title="Warning, important" border="0" /> For this we need to remove the LargeR jet collection as the b-tagging information is not available (and our current tools will attempt to access it). Set LargeJetCollectionName None in order to do this.
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>top-xaod validation-cuts.txt input-mc-rel21.txt</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 Open it again with a TBrowser. You will see that instead of the flat nominal tree, you have now a tree called CollectionTree where the information is stored in a much more complex format.
<p />
<h2><a name="3_6_Optional_Converting_your_min"></a> 3.6 (Optional) Converting your mini-xAOD to a flat ntuple </h2>
<p />
 <br /><br /><div class="twistyPlugin twikiMakeVisibleInline">  <span id="twistyIdAtlasProtectedTopRun2WorkshopTutorial20171show" class="twistyTrigger twikiUnvisited twistyHidden twistyInited"><a href="#"><span class="twikiLinkLabel twikiUnvisited">More...</span></a> </span> <span id="twistyIdAtlasProtectedTopRun2WorkshopTutorial20171hide" class="twistyTrigger twikiUnvisited twistyHidden twistyInited"><a href="#"><span class="twikiLinkLabel twikiUnvisited">Close</span></a> </span>  </div><!--/twistyPlugin twikiMakeVisibleInline--> <div class="twistyPlugin"><div id="twistyIdAtlasProtectedTopRun2WorkshopTutorial20171toggle" class="twikiHelp twistyContent twikiMakeHidden twistyInited"> It is also be possible to produce flat ntuples from these mini-xAODs. This may be useful because updates to SFs can be run from the mini-xAOD which may be faster than rerunning everything straight to flat ntuples.
<p />
 This feature has been available for a while in <a class="twikiLink" href="/twiki/bin/view/AtlasProtected/AnalysisTop">AnalysisTop</a>, although not actively developed or used at the moment.
<p />
 To be able to convert a mini-xAOD to flat tuple, we need to make sure that we save all the variables we that we need that write out the ntuple. At the moment this involves adding lines such as the following to your cuts file:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>EventVariableSaveList runNumber.eventNumber.eventTypeBitmask.averageInteractionsPerCrossing.ejets.mujets.TRIGDEC_HLT_mu50.TRIGDEC_HLT_mu20_iloose_L1MU15.TRIGDEC_HLT_e24_lhmedium_L1EM18VH.TRIGDEC_HLT_e60_lhmedium.TRIGDEC_HLT_e120_lhloose
JetVariableSaveList AnalysisTop_JVT.pt.eta.phi.m.passPreORSelection.btaggingLink.HadronConeExclTruthLabelID.DetectorEta
ElectronVariableSaveList pt.eta.phi.m.charge.ptvarcone20.topoetcone20.passPreORSelection.TRIGMATCH_HLT_e24_lhmedium_L1EM18VH.TRIGMATCH_HLT_e60_lhmedium.TRIGMATCH_HLT_e120_lhloose.d0sig.delta_z0_sintheta.caloClusterLinks
BTagVariableSaveList MV2c10_discriminant.SV1_pu.SV1_pb.IP3D_pb.IP3D_pu
MuonVariableSaveList pt.eta.phi.m.author.charge.ptvarcone30.topoetcone20.muonType.passPreORSelection.TRIGMATCH_HLT_mu50.TRIGMATCH_HLT_mu20_iloose_L1MU15.d0sig.delta_z0_sintheta</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 Some of these variables are already stored inside the default settings of <a class="twikiLink" href="/twiki/bin/view/AtlasProtected/AnalysisTop">AnalysisTop</a>, but you need to ensure that the following is set in your cut file:
<sticky><!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>BTagVariableSaveList MV2c10_discriminant</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 These lines make sure that information we need to recalculate SFs and write to the flat ntuple are saved to our mini-xAOD. Note that if you are using different triggers, you should make sure you have the TRIGDEC_ and TRIGMATCH_ variables added to the appropriate places. This is obviously not a very user friendly thing to have to do at the moment and so we will try to move common variables "behind the scenes". If you have a custom event saver, you might still need to add these by yourself however.
<p />
 Now, with the above lines and:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>OutputFormat top::EventSaverxAODNext</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 run:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>top-xaod validation-cuts.txt input-mc-rel21.txt</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 to produce your mini-xAOD again. Ok nothing new so far, but if you make a new input file containing the location of the mini-xAOD you just made:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>ls output.root &gt; mini_in.txt</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 and run:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>mini-to-flat validation-cuts.txt mini_in.txt</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 you will end up with a new file called miniout.root in the flat ntuple format. Look in the file paying particular attention to the btagSF branches and then add the following line to your cuts file:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>BTaggingWP 70% 77%</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 You should now end up with a new branch:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>weight_bTagSF_70</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 the b-tagging SFs have been recalculated for this additional working point. Note this is very much work in progress and there are several things that need to be improved. The name of the output file from mini-to-flat as well as the flat ntuple format are currently hard coded (the code lives in TopExamples if you are interested) and this will be changes in the future so that you can use your custom event saver.
<p />
</div></div> <!--/twistyPlugin-->
<p />
<h1><a name="4_Submit_a_job_to_the_grid"></a> 4 Submit a job to the grid </h1>
<p />
 The number and sizes of files you will need to run over for a full analysis is very large, so you will need to be able to run on the grid. Since the grid job will take a while to start and run, we will submit these jobs over night. As before, we've put together some handy scripts. We're also looking at central tools (sample handler) to see if that might be better.
<br /><img src="/twiki/pub/TWiki/TWikiDocGraphics/warning.gif" width="16" height="16" alt="Warning, important" title="Warning, important" border="0" />Warning: this section makes use of python modules, and for some reason after checking out the TopExamples package, the <code>PYTHONPATH</code> environment variable isn't updated properly, and it wouldn't point to the locally checked out version. Therefore you may have to start from a new session again (i.e. logout and login again), run the commands related to grid (lsetup panda, lsetup rucio, lsetup pyami), then asetup, then cmake. We'll follow up on this issue to have it fixed in the near future.
<p />
<h2><a name="4_1_Get_a_copy_of_the_helper_scr"></a> 4.1 Get a copy of the helper scripts </h2>
<p />
 First of all you need to update to a newer version of TopExamples. For that please to the following in your installation folder:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#A020F0">cd</FONT></B> source
svnco TopExamples-00-00-81
<B><FONT COLOR="#A020F0">cd</FONT></B> ../build
cmake ../source
cmake --build ./
source ${CMTCONFIG}/setup.sh</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 Now you need to get a local copy of the scripts so you can edit them. Run this command below which will make a directory called grid . The move into the "grid" directory:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#A020F0">cd</FONT></B> run
<I><FONT COLOR="#B22222"># Currently this does not work as we need to update the package to install these scripts
</FONT></I><I><FONT COLOR="#B22222"># So we do the equivalent by hand for now
</FONT></I><I><FONT COLOR="#B22222">#get_files getExamples
</FONT></I><I><FONT COLOR="#B22222"># . getExamples
</FONT></I>mkdir grid
<B><FONT COLOR="#A020F0">cd</FONT></B> grid
cp $TUTORIAL/source/PhysicsAnalysis/TopPhys/xAOD/TopExamples/scripts/*.py ./</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 You can now find several python scripts in your folder. You also need to get a copy of the steering file for the job, and put it in the submission directory. To make it simple, just take the file you started from in the earlier steps:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>get_files validation-cuts.txt .</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 Open up 01SubmitToGrid_Tutorial.py. For this tutorial let's change config.gridUsername to your grid name. Furthermore you have to change config.settingsFile to validation-cuts.txt .
<p />
<h2><a name="4_2_Submission"></a> 4.2 Submission </h2>
<p />
 To submit the grid jobs we then run:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>voms-proxy-init -voms atlas <I><FONT COLOR="#B22222"># enter your grid password when you are asked for it
</FONT></I>./01SubmitToGrid_Tutorial.py</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 The code will now produce a tarball top-xaod.tar.gz that will be submitted to the grid. You will be running over the files that you specified in 01SubmitToGrid_Tutorial.py.
The MC sample to be submitted will be taken from the MC16_TOPQ1.py script.
<br /><img src="/twiki/pub/TWiki/TWikiDocGraphics/warning.gif" width="16" height="16" alt="Warning, important" title="Warning, important" border="0" />The MC sample is a MC16 one, despite the fact that it has mc15 in its name (it's a privately produced sample that was incorrectly named).
<p />
 Since it takes a while to run on the grid, we have to wait until tomorrow morning to download the files and make some fancy plots. Go have a beer/coffee/ice-cream!
<p />
<h2><a name="4_2_X_Job_submission_sans_script"></a> 4.2.X Job submission sans scripts </h2>
<p />
 If the helper scripts are not working, or the athena commands are not updated, the following should allow submission to the GRID.
<p />
<sticky>
<p />
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>lsetup panda
<B><FONT COLOR="#A020F0">export</FONT></B> AtlasProject=AnalysisBase
<B><FONT COLOR="#A020F0">export</FONT></B> AnalysisBase_VERSION=2.6.2 
<B><FONT COLOR="#A020F0">export</FONT></B> AnalysisBaseExternals_VERSION=2.6.2
prun --useAthenaPackages --cmtConfig=x86_64-slc6-gcc49-opt --writeInputToTxt=IN:<B><FONT COLOR="#A020F0">in</FONT></B>.txt --outputs=output.root --<B><FONT COLOR="#A020F0">exec</FONT></B>=<B><FONT COLOR="#BC8F8F">&quot;top-xaod run/validation-cuts.txt in.txt&quot;</FONT></B> --maxNFilesPerJob=1 --skipScout --inDS=group.phys-top.mc16_13TeV.410501.PowhegPythia8EvtGen_A14_ttbar_lep.DAOD_TOPQ1.e5458_s3126_r9364_r9315.<B><FONT COLOR="#A020F0">test</FONT></B>.v1_EXT0/ --outDS=user.$USER.mc16_13TeV.410501.PowhegPythia8EvtGen_A14_ttbar_lep.DAOD_TOPQ1.e5458_s3126_r9364_r9315.ws</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
</sticky>
<p />
<h2><a name="4_3_Grid_job_monitoring"></a> 4.3 Grid job monitoring </h2>
<p />
 If you want to monitor your running jobs, you can do that on bigPanda:
<p />
 <a href="http://bigpanda.cern.ch/?mode=quicksearch" target="_blank">http://bigpanda.cern.ch/?mode=quicksearch<img alt="" border="0" height="12" src="/twiki/pub/TWiki/TWikiDocGraphics/external-link.gif" width="13" /></a>
<p />
 scroll all the way down in the search menu and put in your name at "user" . Then you should be able to find yourself! You should be able to see if your jobs are running/done or (hopefully not) crashing!
<p />
<h1><a name="5_Making_changes"></a> 5. Making changes </h1>
<p />
 We have three ways that you can modify the code without having to change and of the core packages. Which, very generally, are: <ul>
<li> Modify the object selection to change the pT cuts, or maybe everything about which objects are "good"
</li> <li> Add cuts to select certain events. We provide a few already, but you can now add your own
</li> <li> Modify the output file. At the moment we support xAOD and flat ntuples. <p> </p> All of these can be done in your own package, so when we update AnalysisTop in the future (and we will!) then you just need to add your new package. <p> </p> These are covered in more detail in the following sections. <p> </p>
</li></ul> 
<h2><a name="5_1_Change_the_object_selection"></a> 5.1 Change the object selection (and calculate a scale factor like quantity) </h2>
<p />
 Ok, this seems like a fairly reasonable thing to start with.
<p />
<h3><a name="5_1_1_Look_at_existing_object_se"></a> 5.1.1 Look at existing object selection </h3>
<p />
 The default code that decides which objects are selected lives here: <a href="http://epweb2.ph.bham.ac.uk/user/head/AnalysisTop-2.3.13/classtop_1_1ObjectLoaderStandardCuts.html#ab43806c67be1b0ce2c70ff5068d71f1a" target="_blank">ObjectLoaderStandardCuts<img alt="" border="0" height="12" src="/twiki/pub/TWiki/TWikiDocGraphics/external-link.gif" width="13" /></a>.
<p />
 You can see that the electron, muon, jet (and large-R jet) selection is configured here and the overlap removal too.
<p />
 Rather than modify this directly (which is possible) a better solution is to make your own object selection code that can be loaded at run-time via the config file. So let's have a go at that. It's a bit more work initially, but it means that you will be able to just update to new AnalysisTop versions and include your own package.
<p />
<h3><a name="5_1_2_Make_a_new_empty_package"></a> 5.1.2 Make a new, empty, package </h3>
<p />
 First you need to make a new directory in your source folder to hold your new package. There is not yet a convinient package to allow you to prepare a skeleton package as there was in RootCore, so we have prepared a script at-pkg which is attached to this twiki. You should download and copy this file to your source directory, and then run:
<sticky><!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#A020F0">cd</FONT></B> $TUTORIAL/source
cp /afs/cern.ch/work/i/iconnell/public/TopRecoWorkshop17/at-pkg ./
./at-pkg MyAwesomeAnalysis AwesomeObjectLoader</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 This will create a package and will create a single empty class file AwesomeObjectLoader.cxx and AwesomeObjectLoader.h.
<p />
 This way, any changes we make will be independent of AnalysisTop, so if a future AnalysisTop comes out you can just copy across your package. The CMakeLists.txt file controls the build and dependencies. Here all the packages which the new package is dependent on should be listed (in a similar was to the RootCore.Makefile used to work).
<p />
<h3><a name="5_1_3_Update_the_CMakeLists_txt"></a> 5.1.3 Update the CMakeLists.txt </h3>
<p />
 Open the file MyAwesomeAnalysis/!CMakeLists.txt and have a look at the packages which are listed. Here you list libraries which need to depend upon and link against them. All the main AnalysisTop packages are listed, but you may want to reduce this list.
<p />
<h3><a name="5_1_4_Add_your_new_object_select"></a> 5.1.4 Add your new object selection </h3>
<p />
 Make a new file MyAwesomeAnalysis/MyAwesomeAnalysis/AwesomeObjectLoader.h and fill it with
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>#<B><FONT COLOR="#5F9EA0">ifndef</FONT></B> <FONT COLOR="#B8860B">AWESOMEOBJECTLOADER_H_</FONT>
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <FONT COLOR="#B8860B">AWESOMEOBJECTLOADER_H_</FONT>

#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;TopAnalysis/ObjectLoaderBase.h&quot;</FONT></B>

<I><FONT COLOR="#B22222">/**
 * A class that can be loaded by name at run time and creates our object selection
 */</FONT></I>
<B><FONT COLOR="#228B22">class</FONT></B> AwesomeObjectLoader : <B><FONT COLOR="#228B22">public</FONT></B> top::ObjectLoaderBase {
<B><FONT COLOR="#228B22">public</FONT></B>:
    <I><FONT COLOR="#B22222">//A method that creates a pointer to a TopObjectSelection tool which contains info on which cuts to enable and configure
</FONT></I>    <B><FONT COLOR="#5F9EA0">top</FONT></B>::TopObjectSelection* init(std::shared_ptr&lt;top::TopConfig&gt; topConfig);

    <I><FONT COLOR="#B22222">//Clever root stuff
</FONT></I>    ClassDef(AwesomeObjectLoader, 0)
};

#<B><FONT COLOR="#5F9EA0">endif</FONT></B></pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 and the corresponding MyAwesomeAnalysis/Root/AwesomeObjectLoader.cxx and fill that with:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;MyAwesomeAnalysis/AwesomeObjectLoader.h&quot;</FONT></B>
<I><FONT COLOR="#B22222">//So we can read stuff from the configuration text file at run time
</FONT></I>#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;TopConfiguration/TopConfig.h&quot;</FONT></B>
<I><FONT COLOR="#B22222">//We need this to do our magic
</FONT></I>#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;TopObjectSelectionTools/TopObjectSelection.h&quot;</FONT></B>
<I><FONT COLOR="#B22222">//For top::check
</FONT></I>#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;TopEvent/EventTools.h&quot;</FONT></B>
<I><FONT COLOR="#B22222">//We'll need these so we can apply some cuts
</FONT></I>#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;TopObjectSelectionTools/ElectronLikelihoodMC15.h&quot;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;TopObjectSelectionTools/ElectronCutBasedMC15.h&quot;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;TopObjectSelectionTools/IsolationTools.h&quot;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;TopObjectSelectionTools/MuonMC15.h&quot;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;TopObjectSelectionTools/TauMC15.h&quot;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;TopObjectSelectionTools/JetMC15.h&quot;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;TopObjectSelectionTools/TrackJetMC15.h&quot;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;TopObjectSelectionTools/PhotonMC15.h&quot;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;TopObjectSelectionTools/AntiMuonMC15.h&quot;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;TopObjectSelectionTools/OverlapRemovalASG.h&quot;</FONT></B>
<I><FONT COLOR="#B22222">//Run once at the start of the program to setup our object selection (and overlap removal)
</FONT></I>top::TopObjectSelection* AwesomeObjectLoader::init(std::shared_ptr&lt;top::TopConfig&gt; topConfig) {

 <B><FONT COLOR="#5F9EA0">top</FONT></B>::TopObjectSelection* objectSelection = <B><FONT COLOR="#A020F0">new</FONT></B> top::TopObjectSelection(topConfig-&gt;objectSelectionName());
 <B><FONT COLOR="#5F9EA0">top</FONT></B>::check(objectSelection-&gt;setProperty( <B><FONT COLOR="#BC8F8F">&quot;config&quot;</FONT></B> , topConfig ) , <B><FONT COLOR="#BC8F8F">&quot;Failed to setProperty for top::TopObjectSelection&quot;</FONT></B> );
 <B><FONT COLOR="#5F9EA0">top</FONT></B>::check(objectSelection-&gt;initialize() , <B><FONT COLOR="#BC8F8F">&quot;Failed to initialize top::TopObjectSelection&quot;</FONT></B> );
 
 <I><FONT COLOR="#B22222">// Debug messages?
</FONT></I> <I><FONT COLOR="#B22222">// objectSelection-&gt;msg().setLevel(MSG::DEBUG);
</FONT></I> <I><FONT COLOR="#B22222">///-- Photons --//
</FONT></I> <B><FONT COLOR="#A020F0">if</FONT></B>(topConfig-&gt;usePhotons()) {
 objectSelection-&gt;photonSelection(<B><FONT COLOR="#A020F0">new</FONT></B> top::PhotonMC15(topConfig-&gt;photonPtcut(),
 topConfig-&gt;photonEtacut(),
 topConfig-&gt;photonIdentification(),
 topConfig-&gt;photonIdentificationLoose(),
 <B><FONT COLOR="#A020F0">new</FONT></B> top::StandardIsolation(
 topConfig-&gt;photonIsolation(),
 topConfig-&gt;photonIsolationLoose() )) );
 }
 
 <I><FONT COLOR="#B22222">///-- Electrons --///
</FONT></I> <B><FONT COLOR="#A020F0">if</FONT></B> (topConfig-&gt;useElectrons()) {
<B><FONT COLOR="#0000FF">if</FONT></B> (topConfig-&gt;electronID().find(<B><FONT COLOR="#BC8F8F">&quot;LH&quot;</FONT></B>) == std::string::npos &amp;&amp; topConfig-&gt;electronIDLoose().find(<B><FONT COLOR="#BC8F8F">&quot;LH&quot;</FONT></B>) == std::string::npos) { 
<I><FONT COLOR="#B22222">//both the tight and loose user settings do not contain LH -&gt; cut based
</FONT></I> objectSelection-&gt;electronSelection(<B><FONT COLOR="#A020F0">new</FONT></B> top::ElectronCutBasedMC15(topConfig-&gt;electronPtcut(),
 topConfig-&gt;electronVetoLArCrack(),
 topConfig-&gt;electronID(),
 topConfig-&gt;electronIDLoose(),
 <B><FONT COLOR="#A020F0">new</FONT></B> top::StandardIsolation(
 topConfig-&gt;electronIsolation() ,
 topConfig-&gt;electronIsolationLoose() )) );
 
 } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (topConfig-&gt;electronID().find(<B><FONT COLOR="#BC8F8F">&quot;LH&quot;</FONT></B>) != std::string::npos &amp;&amp; topConfig-&gt;electronIDLoose().find(<B><FONT COLOR="#BC8F8F">&quot;LH&quot;</FONT></B>) != std::string::npos) {
 <I><FONT COLOR="#B22222">//user wants likelihood electrons
</FONT></I> objectSelection-&gt;electronSelection(<B><FONT COLOR="#A020F0">new</FONT></B> top::ElectronLikelihoodMC15(topConfig-&gt;isPrimaryxAOD(),
 topConfig-&gt;electronPtcut(),
 topConfig-&gt;electronVetoLArCrack(),
 topConfig-&gt;electronID(),
 topConfig-&gt;electronIDLoose(),
 <B><FONT COLOR="#A020F0">new</FONT></B> top::StandardIsolation(
 topConfig-&gt;electronIsolation() ,
 topConfig-&gt;electronIsolationLoose() ),
 topConfig-&gt;applyTTVACut()
 ) );
 
 } <B><FONT COLOR="#A020F0">else</FONT></B> {
 <B><FONT COLOR="#5F9EA0">std</FONT></B>::cout &lt;&lt; <B><FONT COLOR="#BC8F8F">&quot;\nHo hum\n&quot;</FONT></B>;
 <B><FONT COLOR="#5F9EA0">std</FONT></B>::cout &lt;&lt; <B><FONT COLOR="#BC8F8F">&quot;Not sure it makes sense to use a mix of LH and cut-based electrons for the tight/loose definitions\n&quot;</FONT></B>;
 <B><FONT COLOR="#5F9EA0">std</FONT></B>::cout &lt;&lt; <B><FONT COLOR="#BC8F8F">&quot;Tight electron definition is &quot;</FONT></B> &lt;&lt; topConfig-&gt;electronID() &lt;&lt; <B><FONT COLOR="#BC8F8F">&quot;\n&quot;</FONT></B>;
 <B><FONT COLOR="#5F9EA0">std</FONT></B>::cout &lt;&lt; <B><FONT COLOR="#BC8F8F">&quot;Loose electron definition is &quot;</FONT></B> &lt;&lt; topConfig-&gt;electronIDLoose() &lt;&lt; <B><FONT COLOR="#BC8F8F">&quot;\n&quot;</FONT></B>;
 <B><FONT COLOR="#5F9EA0">std</FONT></B>::cout &lt;&lt; <B><FONT COLOR="#BC8F8F">&quot;If it does make sense, feel free to fix this\n&quot;</FONT></B>;
 exit(1);
 }
 }
 
 <I><FONT COLOR="#B22222">///-- Muons --///
</FONT></I> <B><FONT COLOR="#A020F0">if</FONT></B> (topConfig-&gt;useMuons()) {
 
 
 
 
<B><FONT COLOR="#0000FF">if</FONT></B> (topConfig-&gt;useAntiMuons())
 objectSelection -&gt; muonSelection(<B><FONT COLOR="#A020F0">new</FONT></B> top::AntiMuonMC15(topConfig-&gt;muonPtcut(), <B><FONT COLOR="#A020F0">new</FONT></B> top::StandardIsolation(topConfig-&gt;muonIsolation(), topConfig-&gt;muonIsolationLoose()) ));
 <B><FONT COLOR="#A020F0">else</FONT></B>
 objectSelection -&gt; muonSelection(<B><FONT COLOR="#A020F0">new</FONT></B> top::MuonMC15(topConfig-&gt;muonPtcut(), <B><FONT COLOR="#A020F0">new</FONT></B> top::StandardIsolation(topConfig-&gt;muonIsolation(), topConfig-&gt;muonIsolationLoose()), topConfig-&gt;applyTTVACut()) );
  }
 
 
 
 <I><FONT COLOR="#B22222">///-- Taus --///
</FONT></I> <B><FONT COLOR="#A020F0">if</FONT></B> (topConfig-&gt;useTaus()) {
 objectSelection-&gt;tauSelection(<B><FONT COLOR="#A020F0">new</FONT></B> top::TauMC15());
 }
 
 <I><FONT COLOR="#B22222">///-- Jets --///
</FONT></I><I><FONT COLOR="#B22222">/// Some adjustment - pT cut increase by 1.5 
</FONT></I> <B><FONT COLOR="#A020F0">if</FONT></B> (topConfig-&gt;useJets()) {
 objectSelection -&gt; jetSelection(<B><FONT COLOR="#A020F0">new</FONT></B> top::JetMC15(1.5*topConfig-&gt;jetPtcut(), topConfig-&gt;jetEtacut(), topConfig-&gt;fwdJetAndMET()));
 }
 
 
 <I><FONT COLOR="#B22222">///-- Large R Jets --///
</FONT></I> <B><FONT COLOR="#A020F0">if</FONT></B> (topConfig-&gt;useLargeRJets()) {<I><FONT COLOR="#B22222">// not doing JVT cut for large-R jets
</FONT></I> objectSelection -&gt; largeJetSelection(<B><FONT COLOR="#A020F0">new</FONT></B> top::JetMC15(topConfig-&gt;largeRJetPtcut(), topConfig-&gt;largeRJetEtacut(), false));
 }
 
<I><FONT COLOR="#B22222">///-- Track Jets --///
</FONT></I> <B><FONT COLOR="#A020F0">if</FONT></B> (topConfig-&gt;useTrackJets()) {
 objectSelection -&gt; trackJetSelection(<B><FONT COLOR="#A020F0">new</FONT></B> top::TrackJetMC15(topConfig-&gt;trackJetPtcut(), topConfig-&gt;trackJetEtacut()));
 }
 
<I><FONT COLOR="#B22222">///-- Overlap removal --///&lt;/span&gt;
</FONT></I> <I><FONT COLOR="#B22222">/// single parameter: boolean to do OR with large-R jets
</FONT></I> objectSelection-&gt;overlapRemovalPostSelection(<B><FONT COLOR="#A020F0">new</FONT></B> top::OverlapRemovalASG( (topConfig-&gt;doLargeJetOverlapRemoval() &amp;&amp; topConfig-&gt;useLargeRJets())) );
 
 <B><FONT COLOR="#A020F0">return</FONT></B> objectSelection;
 }
 </pre>
<!-- end SyntaxHighlightingPlugin -->
 </sticky>
<h3><a name="5_1_5_Update_LinkDef_h"></a> 5.1.5 Update LinkDef.h </h3>
<p />
 We also need to edit the empty LinkDef.h file (MyAwesomeAnalysis/Root/LinkDef.h). First you need to add
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;MyAwesomeAnalysis/AwesomeObjectLoader.h&quot;</FONT></B></pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 at the very top and then create ifdef / endif blocks:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>#<B><FONT COLOR="#5F9EA0">ifdef</FONT></B> <FONT COLOR="#B8860B">__CINT__</FONT>
#<B><FONT COLOR="#5F9EA0">pragma</FONT></B> <FONT COLOR="#B8860B">extra_include</FONT> <B><FONT COLOR="#BC8F8F">&quot;MyAwesomeAnalysis/AwesomeObjectLoader.h&quot;</FONT></B>;
#<B><FONT COLOR="#5F9EA0">pragma</FONT></B> <FONT COLOR="#B8860B">link</FONT> <FONT COLOR="#B8860B">off</FONT> <FONT COLOR="#B8860B">all</FONT> <FONT COLOR="#B8860B">globals</FONT>;
#<B><FONT COLOR="#5F9EA0">pragma</FONT></B> <FONT COLOR="#B8860B">link</FONT> <FONT COLOR="#B8860B">off</FONT> <FONT COLOR="#B8860B">all</FONT> <FONT COLOR="#B8860B">classes</FONT>;
#<B><FONT COLOR="#5F9EA0">pragma</FONT></B> <FONT COLOR="#B8860B">link</FONT> <FONT COLOR="#B8860B">off</FONT> <FONT COLOR="#B8860B">all</FONT> <FONT COLOR="#B8860B">functions</FONT>;
#<B><FONT COLOR="#5F9EA0">pragma</FONT></B> <FONT COLOR="#B8860B">link</FONT> <FONT COLOR="#B8860B">C</FONT>++ <FONT COLOR="#B8860B">nestedclass</FONT>;
 
 
<I><FONT COLOR="#B22222">// For loading the object selection at run time
</FONT></I>#<B><FONT COLOR="#5F9EA0">pragma</FONT></B> <FONT COLOR="#B8860B">link</FONT> <FONT COLOR="#B8860B">C</FONT>++ <FONT COLOR="#B8860B">class</FONT> <FONT COLOR="#B8860B">AwesomeObjectLoader</FONT>+;
#<B><FONT COLOR="#5F9EA0">endif</FONT></B></pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 This will allow the code to run your object selection if it is set in the config file. Note that compared to <a class="twikiLink" href="/twiki/bin/view/AtlasProtected/RootCore">RootCore</a>, we appear to need to define the extra_include for the headers to be picked up correctly in cmake.
<p />
<h3><a name="5_1_6_Compile"></a> 5.1.6 Compile </h3>
<p />
 First we need to tell cmake about our new, shiny, package and compile it. You do this with the command
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#A020F0">cd</FONT></B> $TUTORIAL/build
cmake ../source
cmake --build ./
source ${CMTCONFIG}/setup.sh</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
<h3><a name="5_1_7_Run"></a> 5.1.7 Run </h3>
<p />
 Let's say I want to modify the validation-cuts.txt example file. First, we need a copy of it:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#A020F0">cd</FONT></B> $TUTORIAL/run
cp validation-cuts.txt myOwnCuts.txt</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
You need to ensure you are using <b>top::EventSaverFlatNtuple </b>as the output event saver, otherwise you will get an error relating to b-tagging links (which comes from the LargeR jets).
<p />
 Now I need to add our new package, so that it's loaded at run time. Edit myOwnCuts.txt and add libMyAwesomeAnalysis to the LibraryNames line.
<p />
 Now find the ObjectSelectionName line and change top::ObjectLoaderStandardCuts to AwesomeObjectLoader.
<p />
 You can now decide if you want cut based electrons (Loose, Medium or Tight) or Likelihood based electrons (LHMedium or LHTight for example).
<p />
 Now run the code with
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>top-xaod myOwnCuts.txt input-mc-rel21.txt</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
<h1><a name="6_Analysis_of_grid_output_Option"></a> 6 Analysis of grid-output (Optional) </h1>
<p />
 Good Morning! Now we hope that the jobs were running fine over night. If only some of them are finished thats not a problem, we can download the ones which are already available.
<p />
<h2><a name="6_1_Download_output_files"></a> 6.1 Download output files </h2>
<p />
 Login to lxplus and make sure first that you setup your environment properly:
<sticky><!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#A020F0">cd</FONT></B> $TUTORIAL/source
setupATLAS
asetup AnalysisTop,2.6.2,here
<B><FONT COLOR="#A020F0">cd</FONT></B> $TUTORIAL/build
cmake ../source
cmake --build ./
source ${CMTCONFIG}/setup.sh</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 and go into the folder where you stored the submission scripts:
<sticky><!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><B><FONT COLOR="#A020F0">cd</FONT></B> grid</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 Make a folder to store the files you download:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>mkdir /tmp/YOURUSERNAME/DownloadFolder/</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 For the download, you can edit 02DownloadFromGrid.py. You need to change the datasetPattern so that it includes the sample you created. Note that (annoyingly) the output filename has been appended to the dataset name. You also need to edit directory to be DownloadFolder. Then run:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>voms-proxy-init -voms atlas <I><FONT COLOR="#B22222"># to setup your grid certificate
</FONT></I>./02DownloadFromGrid.py</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 In case your job did not run properly due to problems with the grid, you can use a test-sample I made for that case. Simply edit the 02DownloadFromGrid.py in the following way:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>scope          = 'user.aknue'
datasetPattern = '*test_02-03-45a_output-xAOD.root'
directory      = '/tmp/YOURUSERNAME/DownloadFolder/'</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 and run the script. This should download the files to your local folder. For simplicity and space issues we specified here your tmp folder, but please be aware that the samples can only stay there for a short amount of time!
<p />
<h2><a name="6_2_Check_if_the_download_is_com"></a> 6.2 Check if the download is complete </h2>
<p />
 To make sure that you ran all available events on the grid and you also downloaded the output completely, we have an additional script to help you. First you have to setup rucio and pyAMI:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>localSetupPyAMI
localSetupRucioClients</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 Open now 03LocalAnalysis_Tutorial.py and modify the inputDirectory folder so that it matches the folder that you used in the 02Download script. Now execute the script:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>python 03LocalAnalysis_Tutorial.py</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 The code now first obtains all available ami information, this might take a few seconds. Then it calculates the number of events in your Downloads folder and compares it with the initial number of events from the derivation. If the numbers do not match, you will get a red printout to the screen. If they agree, the printout will be black.
<p />
<h1><a name="7_Run_with_systematic_uncertaint"></a> 7 Run with systematic uncertainties </h1>
<p />
 Up to now we were only running the nominal selection, but what happens to all the systematic uncertainties? These can be easily switched on. Go back to your <code>$TUTORIAL/run</code> folder and open your validation-cuts.txt file again.
<p />
 Change the output file name:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>OutputFilename output-systematics.root</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 and modify:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>Systematics Nominal</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 to
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>Systematics All</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 Since this run will take a while, better comment the KLFitter out for the lepton+jets channel. To be able to analyse the ntuples more easily, also better switch back to the <strong>EventSaverFlatNtuple</strong>. Now run <strong>top-xaod</strong> again as done above. After the run has finished, open the root file and examine the content. If everything ran as planned, you should be able to find one tree per systematic uncertainty.
<p />
<h1><a name="8_Add_you_own_boosted_jet_select"></a> 8 Add you own boosted jet selector </h1>
<p />
 Now that you have your MyAwesomeAnalysis package, its time to make some modifications. You might want to use large R jets here to do a boosted Analysis. To be able to do that, we first need to add the object and a corresponding selector to the package.
<p />
<h2><a name="8_1_Make_the_large_R_jet_object"></a> 8.1 Make the large-R jet object </h2>
<p />
 Open for that first MyAwesomeAnalysis/MyAwesomeAnalysis/LargeRJet.h and fill it as follows:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>#<B><FONT COLOR="#5F9EA0">ifndef</FONT></B> <FONT COLOR="#B8860B">LARGERJET_H_</FONT>
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <FONT COLOR="#B8860B">LARGERJET_H_</FONT>

#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;TopObjectSelectionTools/JetSelectionBase.h&quot;</FONT></B>

<B><FONT COLOR="#228B22">class</FONT></B> LargeRJet : <B><FONT COLOR="#228B22">public</FONT></B> top::JetSelectionBase {

 <B><FONT COLOR="#228B22">public</FONT></B>:

  LargeRJet(<B><FONT COLOR="#228B22">double</FONT></B> ptcut, <B><FONT COLOR="#228B22">double</FONT></B> etamax);

  ~LargeRJet();

  <B><FONT COLOR="#228B22">virtual</FONT></B> <B><FONT COLOR="#228B22">bool</FONT></B> passSelection(<B><FONT COLOR="#228B22">const</FONT></B> xAOD::Jet&amp; jet) <B><FONT COLOR="#228B22">const</FONT></B> override;

  <B><FONT COLOR="#228B22">virtual</FONT></B> <B><FONT COLOR="#228B22">void</FONT></B> print(std::ostream&amp; os) <B><FONT COLOR="#228B22">const</FONT></B> override;

 <B><FONT COLOR="#228B22">private</FONT></B>:
  <B><FONT COLOR="#228B22">double</FONT></B> m_ptcut;

  <B><FONT COLOR="#228B22">double</FONT></B> m_etamax;

};
#<B><FONT COLOR="#5F9EA0">endif</FONT></B></pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 and define the body of this class in MyAwesomeAnalysis/Root/LargeRJet.cxx :
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;MyAwesomeAnalysis/LargeRJet.h&quot;</FONT></B>

<B><FONT COLOR="#0000FF">LargeRJet::LargeRJet</FONT></B>(<B><FONT COLOR="#228B22">double</FONT></B> ptcut, <B><FONT COLOR="#228B22">double</FONT></B> etamax) :
  m_ptcut(ptcut),
  m_etamax(etamax) {
  }

<B><FONT COLOR="#0000FF">LargeRJet::~LargeRJet</FONT></B>() {}

<B><FONT COLOR="#228B22">bool</FONT></B> <B><FONT COLOR="#0000FF">LargeRJet::passSelection</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> xAOD::Jet&amp; jet) <B><FONT COLOR="#228B22">const</FONT></B> {
  <B><FONT COLOR="#A020F0">if</FONT></B> (jet.pt() &lt; m_ptcut)
    <B><FONT COLOR="#A020F0">return</FONT></B> false;

  <B><FONT COLOR="#A020F0">if</FONT></B> (std::fabs(jet.eta()) &gt; m_etamax)
    <B><FONT COLOR="#A020F0">return</FONT></B> false;

  jet.auxdecor&lt;<B><FONT COLOR="#228B22">int</FONT></B>&gt;(<B><FONT COLOR="#BC8F8F">&quot;char&quot;</FONT></B>) = 1;

  <B><FONT COLOR="#A020F0">return</FONT></B> true;
}

<B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">LargeRJet::print</FONT></B>(std::ostream&amp; os) <B><FONT COLOR="#228B22">const</FONT></B> {
  os &lt;&lt; <B><FONT COLOR="#BC8F8F">&quot;LargeRJet \n&quot;</FONT></B>
     &lt;&lt; <B><FONT COLOR="#BC8F8F">&quot;    * pT &gt; &quot;</FONT></B> &lt;&lt; m_ptcut &lt;&lt; <B><FONT COLOR="#BC8F8F">&quot;\n&quot;</FONT></B>
     &lt;&lt; <B><FONT COLOR="#BC8F8F">&quot;    * |eta| &lt; &quot;</FONT></B> &lt;&lt; m_etamax &lt;&lt; <B><FONT COLOR="#BC8F8F">&quot;\n&quot;</FONT></B>;

}</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'></pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 Now you have a class that allows to run over a jet collection and apply pT and eta cuts. Replace in your AwesomeObjectLoader.cxx the line:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>objectSelection-&gt;largeJetSelection(nullptr);
#<B><FONT COLOR="#5F9EA0">with:</FONT></B>
objectSelection-&gt;largeJetSelection(<B><FONT COLOR="#A020F0">new</FONT></B> LargeRJet(300000, 2.0));</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 Instead of hardcoding the pT and eta cuts, you may do intstead:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>objectSelection-&gt;largeJetSelection(<B><FONT COLOR="#A020F0">new</FONT></B> LargeRJet(topConfig-&gt;largeRJetPtcut(), topConfig-&gt;largeRJetEtacut()));</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 and the pT, eta cuts for large-R jets can be set in validation-cuts.txt with LargeRJetPt and LargeRJetEta, e.g.:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>LargeRJetPt 300000
LargeRJetEta 2.0</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 This will give more flexibility since you wouldn't need to recompile each time to want to change the cuts on the objects.
<p />
 Then you should also include the corresponding header on top of AwesomeObjectLoader.cxx:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;MyAwesomeAnalysis/LargeRJet.h&quot;</FONT></B></pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 Furthermore you have to edit your config-file to specify the large R jet collection for example like this:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'><I><FONT COLOR="#B22222"># replace:
</FONT></I>LargeJetCollectionName None
<I><FONT COLOR="#B22222"># with:
</FONT></I>LargeJetCollectionName AntiKt10LCTopoTrimmedPtFrac5SmallR20Jets</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 to apply the current boosted top recommendations. Thats all fine, but now you also want to be able to use this in a cutflow. Therefore we have to create a special selector now.
<p />
<h2><a name="8_2_Create_new_selector_class"></a> 8.2 Create new selector class </h2>
<p />
 Create the file MyAwesomeAnalysis/MyAwesomeAnalysis/NLargeSelector.h and fill it:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>#<B><FONT COLOR="#5F9EA0">ifndef</FONT></B> <FONT COLOR="#B8860B">NLARGESELECTOR_H_</FONT>
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <FONT COLOR="#B8860B">NLARGESELECTOR_H_</FONT>

#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;TopEventSelectionTools/SignValueSelector.h&quot;</FONT></B>


<B><FONT COLOR="#228B22">class</FONT></B> NLargeSelector : <B><FONT COLOR="#228B22">public</FONT></B> top::SignValueSelector {
 <B><FONT COLOR="#228B22">public</FONT></B>:
  explicit NLargeSelector(<B><FONT COLOR="#228B22">const</FONT></B> std::string&amp; params);

  <B><FONT COLOR="#228B22">bool</FONT></B> apply(<B><FONT COLOR="#228B22">const</FONT></B> top::Event&amp; event) <B><FONT COLOR="#228B22">const</FONT></B> override;
};
#<B><FONT COLOR="#5F9EA0">endif</FONT></B></pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 in the NLargeSelector.cxx file you can now specify the name of the selector:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;MyAwesomeAnalysis/NLargeSelector.h&quot;</FONT></B>


<B><FONT COLOR="#0000FF">NLargeSelector::NLargeSelector</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> std::string&amp; params) :
  SignValueSelector(<B><FONT COLOR="#BC8F8F">&quot;LARGEJET_N&quot;</FONT></B>, params, true) {
  checkMultiplicityIsInteger();
}

<B><FONT COLOR="#228B22">bool</FONT></B> <B><FONT COLOR="#0000FF">NLargeSelector::apply</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> top::Event&amp; event) <B><FONT COLOR="#228B22">const</FONT></B> {
  <B><FONT COLOR="#228B22">auto</FONT></B> func = [&amp;](<B><FONT COLOR="#228B22">const</FONT></B> xAOD::Jet* jetPtr){<B><FONT COLOR="#A020F0">return</FONT></B> jetPtr-&gt;pt() &gt; value();};
  <B><FONT COLOR="#228B22">auto</FONT></B> count = std::count_if(event.m_largeJets.begin(), event.m_largeJets.end(), func);
  <B><FONT COLOR="#A020F0">return</FONT></B> checkInt(count, multiplicity());
}</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
<h2><a name="8_3_Define_the_AnalysisLoader"></a> 8.3 Define the AnalysisLoader </h2>
<p />
 The AnalysisLoader is neccessary in order to call the new selector correctly. Please create MyAwesomeAnalysisLoader.h and MyAwesomeAnalysisLoader.cxx:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>#<B><FONT COLOR="#5F9EA0">ifndef</FONT></B> <FONT COLOR="#B8860B">MYAWESOMEANALYSISLOADER</FONT>
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <FONT COLOR="#B8860B">MYAWESOMEANALYSISLOADER</FONT>

#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;TopEventSelectionTools/ToolLoaderBase.h&quot;</FONT></B>

<B><FONT COLOR="#228B22">class</FONT></B> MyAwesomeAnalysisLoader: <B><FONT COLOR="#228B22">public</FONT></B> top::ToolLoaderBase{
<B><FONT COLOR="#228B22">public</FONT></B>:

  <B><FONT COLOR="#5F9EA0">top</FONT></B>::EventSelectorBase* initTool(
                                   <B><FONT COLOR="#228B22">const</FONT></B> std::string&amp; name,
                                   <B><FONT COLOR="#228B22">const</FONT></B> std::string&amp; line,
                                   TFile* outputFile,
                                   <B><FONT COLOR="#5F9EA0">std</FONT></B>::shared_ptr&lt;top::TopConfig&gt; config,
                                   <B><FONT COLOR="#5F9EA0">EL</FONT></B>::Worker* wk = nullptr
                                   );
  ClassDef(MyAwesomeAnalysisLoader, 0)
};

#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;MyAwesomeAnalysis/MyAwesomeAnalysisLoader.h&quot;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;MyAwesomeAnalysis/NLargeSelector.h&quot;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&lt;iostream&gt;</FONT></B>

top::EventSelectorBase* MyAwesomeAnalysisLoader::initTool(
                                                <B><FONT COLOR="#228B22">const</FONT></B> std::string&amp; name,
                                                <B><FONT COLOR="#228B22">const</FONT></B> std::string&amp; line,
                                                TFile* outputFile,
                                                <B><FONT COLOR="#5F9EA0">std</FONT></B>::shared_ptr&lt;top::TopConfig&gt; config,
                                                <B><FONT COLOR="#5F9EA0">EL</FONT></B>::Worker* wk
                                                      ){
  <B><FONT COLOR="#5F9EA0">std</FONT></B>::istringstream iss(line);
  <B><FONT COLOR="#5F9EA0">std</FONT></B>::string toolname;
  getline(iss, toolname, <B><FONT COLOR="#BC8F8F">' '</FONT></B>);

  <B><FONT COLOR="#5F9EA0">std</FONT></B>::string param;
  <B><FONT COLOR="#A020F0">if</FONT></B> (line.size() &gt; toolname.size())
    param = line.substr(toolname.size() + 1);

  <B><FONT COLOR="#A020F0">if</FONT></B> (toolname == <B><FONT COLOR="#BC8F8F">&quot;LARGEJET_N&quot;</FONT></B>)
    <B><FONT COLOR="#A020F0">return</FONT></B> <B><FONT COLOR="#A020F0">new</FONT></B> NLargeSelector(param);

  <B><FONT COLOR="#A020F0">return</FONT></B> nullptr;
}</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
<h2><a name="8_4_Use_new_class_in_analysis"></a> 8.4 Use new class in analysis </h2>
<p />
 Now you can put the additional cutflow with our new LARGEJET_N selection into your myOwnCuts.txt file:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>SELECTION BoostedMuJets
INITIAL
MU_N 25000 &gt;= 1
MU_N 25000 == 1
EL_N 25000 == 0
JETCLEAN LooseBad
JET_N 25000 &gt;= 1
LARGEJET_N 300000 &gt;= 1
EXAMPLEPLOTS
SAVE</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 Did you add the new classes to the LinkDef.h file? If yes, then you can compile the package and then run top-xaod again.
<p />
<h1><a name="9_Dynamic_keys"></a> 9 Dynamic keys </h1>
<p />
 In addition to the various options such as NEvents or BTaggingWP, you can also define your new configuration keys in the configuration file. Use the DynamicKeys option and add all of them comma-separated. For example you can do:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>DynamicKeys customkey,customkey2
customkey keyvalue
customkey2 keyvalue2</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 The custom key value can then be accessed in a tool via:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>top::ConfigurationSettings* configSettings = top::ConfigurationSettings::get();
std::string keyvalue = configSettings-&gt;value(<B><FONT COLOR="#BC8F8F">&quot;customkey&quot;</FONT></B>);</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 If you want to try it, you could for example add an option IncreaseLargeRJetpTCutAtHighEta that would multiply the large-R jet pT cut by a factor 1.5 if eta is above 1.0. You could add a boolean in your MyAwesomeAnalysis/MyAwesomeAnalysis/LargeRJet.h header:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>#<B><FONT COLOR="#5F9EA0">ifndef</FONT></B> <FONT COLOR="#B8860B">LARGERJET_H_</FONT>
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <FONT COLOR="#B8860B">LARGERJET_H_</FONT>

#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;TopObjectSelectionTools/JetSelectionBase.h&quot;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;TopConfiguration/ConfigurationSettings.h&quot;</FONT></B>

<B><FONT COLOR="#228B22">class</FONT></B> LargeRJet : <B><FONT COLOR="#228B22">public</FONT></B> top::JetSelectionBase {

 <B><FONT COLOR="#228B22">public</FONT></B>:

  LargeRJet(<B><FONT COLOR="#228B22">double</FONT></B> ptcut, <B><FONT COLOR="#228B22">double</FONT></B> etamax);

  ~LargeRJet();

  <B><FONT COLOR="#228B22">virtual</FONT></B> <B><FONT COLOR="#228B22">bool</FONT></B> passSelection(<B><FONT COLOR="#228B22">const</FONT></B> xAOD::Jet&amp; jet) <B><FONT COLOR="#228B22">const</FONT></B> override;

  <B><FONT COLOR="#228B22">virtual</FONT></B> <B><FONT COLOR="#228B22">void</FONT></B> print(std::ostream&amp; os) <B><FONT COLOR="#228B22">const</FONT></B> override;

 <B><FONT COLOR="#228B22">private</FONT></B>:
  <B><FONT COLOR="#228B22">double</FONT></B> m_ptcut;

  <B><FONT COLOR="#228B22">double</FONT></B> m_etamax;

  <B><FONT COLOR="#228B22">bool</FONT></B> m_IncreaseLargeRJetpTCutAtHighEta;

};
#<B><FONT COLOR="#5F9EA0">endif</FONT></B></pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 Then in MyAwesomeAnalysis/Root/LargeRJet.cxx, fill this boolean in the constructor depending on the value of the dynamic key, and make it do something in the passSelection function:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;MyAwesomeAnalysis/LargeRJet.h&quot;</FONT></B>

<B><FONT COLOR="#0000FF">LargeRJet::LargeRJet</FONT></B>(<B><FONT COLOR="#228B22">double</FONT></B> ptcut, <B><FONT COLOR="#228B22">double</FONT></B> etamax) :
  m_ptcut(ptcut),
  m_etamax(etamax) {
    <B><FONT COLOR="#5F9EA0">top</FONT></B>::ConfigurationSettings* configSettings = top::ConfigurationSettings::get();
    <B><FONT COLOR="#5F9EA0">std</FONT></B>::string keyvalue = configSettings-&gt;value(<B><FONT COLOR="#BC8F8F">&quot;IncreaseLargeRJetpTCutAtHighEta&quot;</FONT></B>);
    m_IncreaseLargeRJetpTCutAtHighEta = (keyvalue==<B><FONT COLOR="#BC8F8F">&quot;True&quot;</FONT></B>);
  }

<B><FONT COLOR="#0000FF">LargeRJet::~LargeRJet</FONT></B>() {}

<B><FONT COLOR="#228B22">bool</FONT></B> <B><FONT COLOR="#0000FF">LargeRJet::passSelection</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> xAOD::Jet&amp; jet) <B><FONT COLOR="#228B22">const</FONT></B> {
  <B><FONT COLOR="#228B22">double</FONT></B> pTCut=(std::fabs(jet.eta())&gt;1.0 &amp;&amp; m_IncreaseLargeRJetpTCutAtHighEta)?m_ptcut*1.5:m_ptcut;
  <B><FONT COLOR="#A020F0">if</FONT></B> (jet.pt() &lt; pTCut)
    <B><FONT COLOR="#A020F0">return</FONT></B> false;

  <B><FONT COLOR="#A020F0">if</FONT></B> (std::fabs(jet.eta()) &gt; m_etamax)
    <B><FONT COLOR="#A020F0">return</FONT></B> false;

  jet.auxdecor&lt;<B><FONT COLOR="#228B22">int</FONT></B>&gt;(<B><FONT COLOR="#BC8F8F">&quot;char&quot;</FONT></B>) = 1;

  <B><FONT COLOR="#A020F0">return</FONT></B> true;
}

<B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">LargeRJet::print</FONT></B>(std::ostream&amp; os) <B><FONT COLOR="#228B22">const</FONT></B> {
  os &lt;&lt; <B><FONT COLOR="#BC8F8F">&quot;LargeRJet \n&quot;</FONT></B>
     &lt;&lt; <B><FONT COLOR="#BC8F8F">&quot;    * pT &gt; &quot;</FONT></B> &lt;&lt; m_ptcut &lt;&lt; <B><FONT COLOR="#BC8F8F">&quot;\n&quot;</FONT></B>
     &lt;&lt; <B><FONT COLOR="#BC8F8F">&quot;    * |eta| &lt; &quot;</FONT></B> &lt;&lt; m_etamax &lt;&lt; <B><FONT COLOR="#BC8F8F">&quot;\n&quot;</FONT></B>;

}</pre>
<!-- end SyntaxHighlightingPlugin -->
<p />
Then after re-compiling, adding the following to your cut-file:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>DynamicKeys IncreaseLargeRJetpTCutAtHighEta
IncreaseLargeRJetpTCutAtHighEta True</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
would have an effect above eta=1.0.
<p />
<h1><a name="10_Normalisation_to_the_integrat"></a> 10 Normalisation to the integrated luminosity </h1>
<p />
 In most if not all physics analyses, you have to compare what you observe in a sample of real data with the prediction from one or several simulated samples. To do so, the MC simulated samples have to be normalised according to the integrated luminosity of the data sample. This is done by applying the following weight to each MC event:<br /> <div align="center"><img src="/twiki/pub/AtlasProtected/TopRun2WorkshopTutorial2017/latexec319b49ec822b89be019327b92b2ede.png" width="111" height="35" alt="\[w = \frac{{\cal L}.\sigma}{N_{MC events}}\]" /></div> This weight is so calculated that, when processing <img style="vertical-align:middle;" align="middle" width="73" height="13" src="/twiki/pub/AtlasProtected/TopRun2WorkshopTutorial2017/latex276e2b80aa9731f1eac6dd93fa2e3c29.png" alt="$N_{MC events}$" /> simulated events without applying any selection, the yield will be equal to the product of the cross-section <img style="vertical-align:middle;" align="middle" width="9" height="7" src="/twiki/pub/AtlasProtected/TopRun2WorkshopTutorial2017/latex5f0ed7e251977c98fc71a1762307fe2a.png" alt="$\sigma$" /> of the simulated physical process by the integrated luminosity <img style="vertical-align:middle;" align="middle" width="10" height="11" src="/twiki/pub/AtlasProtected/TopRun2WorkshopTutorial2017/latex00c7dc5a6b47f86bfa4f84f2053f2bd6.png" alt="${\cal L}$" />. Since you need to know how many events you have processed for both data and MC, this weight need to be computed after you have produced your Ntuples with AnalysisTop, possibly on grid.
<p />
<h2><a name="10_1_Retrieving_the_integrated_l"></a> 10.1 Retrieving the integrated luminosity </h2>
<p />
 Currently, AnalysisTop doesn't have a functionaliy to retrieve the integrated luminosity corresponding to the data samples you processed. Therefore, you retrieve this information by yourself. Once the data samples are made available, this information is made available in the usual top-reco twikis. For the 2015 dataset, this is noted in the <a class="twikiLink" href="/twiki/bin/view/AtlasProtected/TopDerivationMC15List">TopDerivationMC15List</a> twiki. The integrated luminosity for the 25ns 2015 dataset is 3209.05 pb-1.
<p />
 You can also calculate the integrated luminosity yourself for the data runs you are processing. For this you would need to use standard ATLAS tools, of which most documentation are linked to the <a class="twikiLink" href="/twiki/bin/view/AtlasProtected/DataMCForAnalysis">DataMCForAnalysis</a> twiki page.
<p />
<h2><a name="10_2_Retrieving_the_number_of_pr"></a> 10.2 Retrieving the number of processed MC events </h2>
<p />
 In the output files of AnalysisTop, the number of processed MC events is stored in a separate tree: sumWeights. Each entry of this tree corresponds to one input file. It should contain three branches:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>root -l output.root
root [] sumWeights-&gt;GetListOfLeaves()-&gt;Print()
Collection name='TObjArray', <B><FONT COLOR="#228B22">class</FONT></B>='TObjArray', size=16
 <B><FONT COLOR="#5F9EA0">OBJ</FONT></B>: TLeafI dsid dsid
 <B><FONT COLOR="#5F9EA0">OBJ</FONT></B>: TLeafF totalEventsWeighted totalEventsWeighted
 <B><FONT COLOR="#5F9EA0">OBJ</FONT></B>: TLeafL  totalEvents totalEvents</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 The dsid obviously gives you the DSID of the MC sample from which the input file is from. This will allow you to retrieve the corresponding cross-section (see below). If you live dangerously, you could have processed different MC samples at once, and hence have a different DSID for each of these entries (good luck with that).
<p />
 The totalEventsWeighted is a float which gives you, for each of the processed input file, the weighted number of events without any selection: this is what you should use to calculated <img style="vertical-align:middle;" align="middle" width="73" height="13" src="/twiki/pub/AtlasProtected/TopRun2WorkshopTutorial2017/latex276e2b80aa9731f1eac6dd93fa2e3c29.png" alt="$N_{MC events}$" />, by looping on the entries of the sumWeights tree.<br /> <br />"Weighted" means that the MC generator event weights have been applied to compute this sum. Note that these weights can be very different from 1 depending on the MC generator; for NLO generators the weight can be negative, and for Powheg-box the weights can be very small. Therefore, totalEventsWeighted may not be in the general case an integer. This is normal; as long as you have applied this MC generator weight to each event (it is stored as mc_weight in the nominal tree as in the trees corresponding to systematics), everything should be ok.
<p />
 The totalEvents contains the number of processed events, but without the mc weights appplied. You should NOT use it to normalise you MC sample to the inegrated luminosity; this information is just stored for reference, or for very special cases.
<p />
<h2><a name="10_3_Retrieving_the_cross_sectio"></a> 10.3 Retrieving the cross-section of the MC sample </h2>
<p />
 The cross-sections and K-factors for all the MC samples used in ATLAS can be retrieved in the following twiki page maintained by the ATLAS Physics Modelling Group: <a class="twikiLink" href="/twiki/bin/view/AtlasProtected/CentralMC15ProductionList">CentralMC15ProductionList</a>. However, it has be found convenient since run-I to store the cross-sections of all the MC samples commonly used in the Top working group in a package called <a href="https://svnweb.cern.ch/trac/atlasoff/browser/PhysicsAnalysis/TopPhys/TopPhysUtils/TopDataPreparation?order=name" target="_blank">TopDataPreparation<img alt="" border="0" height="12" src="/twiki/pub/TWiki/TWikiDocGraphics/external-link.gif" width="13" /></a>. The directory <a href="https://svnweb.cern.ch/trac/atlasoff/browser/PhysicsAnalysis/TopPhys/TopPhysUtils/TopDataPreparation/tags/TopDataPreparation-00-08-01" target="_blank">data<img alt="" border="0" height="12" src="/twiki/pub/TWiki/TWikiDocGraphics/external-link.gif" width="13" /></a> contains several text files containing the cross-sections of the MC samples (among other things). The file corresponding to the 13 <a class="twikiLink" href="/twiki/bin/view/AtlasProtected/TeV">TeV</a> MC15 campaign is <a href="https://svnweb.cern.ch/trac/atlasoff/browser/PhysicsAnalysis/TopPhys/TopPhysUtils/TopDataPreparation/tags/TopDataPreparation-00-08-01/data/XSection-MC15-13TeV.data" target="_blank">data/XSection-MC15-13TeV.data<img alt="" border="0" height="12" src="/twiki/pub/TWiki/TWikiDocGraphics/external-link.gif" width="13" /></a>.
<p />
 One convenient way to retrieve the cross-section of a given DSID is to use TopDataPreparation within your <a class="twikiLink" href="/twiki/bin/view/AtlasProtected/AnalysisTop">AnalysisTop</a> session. If you have the setup as described above, you just have to open a root session and load the shared librairies compiled with <a class="twikiLink" href="/twiki/bin/view/AtlasProtected/RootCore">RootCore</a>. But first you need to checkout the latest version of the package, and recompile:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>cd $TUTORIAL/source
svnco TopDataPreparation
cd $TUTORIAL/build
cmake ../source
cmake --build ./
source ${CMTCONFIG}/source.sh</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 Note that a couple of the features illustrated below don't work with older versions. Note that this makes use of the old $ROOTCOREBIN enviroment variable. In the future this variable will be removed and access to this file will be via the InstallPath on cvmfs (echo $PATH to look for it). Then you can simply do:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>root -l
root [] .x $ROOTCOREBIN/scripts/load_packages.C</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 Then, you need to create a SampleXsectionSvc, pointing it to the correct text file containing the cross-sections:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>root [] SampleXsectionSvc* s = SampleXsectionSvc::svc(<B><FONT COLOR="#BC8F8F">&quot;XSection-MC15-13TeV.data&quot;</FONT></B>)</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 If you don't give the full path of the text file, it will be searched for in the <span class="twikiNewLink"><a href="/twiki/bin/edit/AtlasProtected/TopDataPreparation?topicparent=AtlasProtected.TopRun2WorkshopTutorial2017;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">TopDataPreparation</a></span> /data directory. The SampleXsectionSvc object is a singleton (only one instance can exist) which holds a const SampleXsection object which is initialised automatically with the text file, and does the mapping of the MC samples to their cross-sections. You can retrieve the cross-section of the MC sample corresponding to DSID 410000 by doing:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>root [] s-&gt;sampleXsection()-&gt;getRawXsection(410000)
(<B><FONT COLOR="#228B22">double</FONT></B>) 3.779932e+02</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 In general, you also need a K-factor, which is a correction applied to make the cross-section match a prediction computed at higher-order in perturbative theory than the MC generator (e.g. you use a NLO generator but normalise to a NNLO+NNLL prediction). To do so, use the getKfactor function:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>root [] s-&gt;sampleXsection()-&gt;getKfactor(410000)
(<B><FONT COLOR="#228B22">double</FONT></B>) 1.194900e+00</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
 The product of the two can actually retrieved directly with the getXsection function:
<sticky>
<!-- SyntaxHighlightingPlugin -->
<pre class='syntaxHighlightingPlugin' style='border: 1px solid #ccc; padding: 0 0.6em; background-color: #f2f5f8'>root [] s-&gt;sampleXsection()-&gt;getXsection(410000)
(<B><FONT COLOR="#228B22">double</FONT></B>) 4.516641e+02
root [] (s-&gt;sampleXsection()-&gt;getRawXsection(410000))*(s-&gt;sampleXsection()-&gt;getKfactor(410000))
(<B><FONT COLOR="#228B22">double</FONT></B>) 4.516641e+02</pre>
<!-- end SyntaxHighlightingPlugin --></sticky>
<p />
<h1><a name="11_Internal_generator_reweightin"></a> 11 Internal generator reweighting </h1>
<p />
An important feature you may need to estimate some systematics is the internal generator reweighting.
In most modern samples, event weights are computed at the generation stage, which when applied instead of the nominal <code>weight_mc</code> give the same MC sample as if it was generated with a different generator settings.
These generator settings can be factorisation or renormalisation scales, different PDFs, etc.
<p />
In order to enable this feature, you need to use the <code>MCGeneratorWeights</code> option in your cut-file.
If you set this option to <code>True</code>, a new branch called <code>mc_generator_weights</code> would be added to the <code>truth</code> tree for all processed events.
If you want to get this branch only for those which pass your r(reco-level) selection cuts, you should put this option to <code>Nominal</code> instead, and the branch would be added to the <code>nominal</code> tree instead.
<p />
This <code>mc_generator_weights</code> branch is a vector of weights, with the same size for each event, corresponding to the number of weights which were added when preparing the MC sample.
The first entry in the vector should be equal to the nominal <code>weight_mc</code> which you apply to each MC event by default.
Then, if you replace this <code>weight_mc</code> by any of the other entries you would get a reweighted sample, for e.g. a different PDF set.
<p />
But to normalise your sample to the integrated luminosity - as explained in the previous section - you need to update consistently the sum of weights <img style="vertical-align:middle;" align="middle" width="73" height="13" src="/twiki/pub/AtlasProtected/TopRun2WorkshopTutorial2017/latex276e2b80aa9731f1eac6dd93fa2e3c29.png" alt="$N_{MC events}$" />. For this you should use the new branch named <code>totalEventsWeighted_mc_generator_weights</code> in the <code>sumWeights</code> tree, in place of the <code>totalEventsWeighted</code>.
The <code>totalEventsWeighted_mc_generator_weights</code> is a vector, each entry <code>i</code> of this vector contains the sum of the weights of entry <code>i</code> of the <code>mc_generator_weights</code> vector.
<br />NB: in the most recent derivations, this sum of generator weights is extracted from the meta-data, as is the <code>totalEventsWeighted</code>. In older samples where we don't have this information stored, AnalysisTop would recompute this sum on-the-fly; in such case you should be sure to run on all generated events (e.g. it wouldn't work if you are using skimmed derivations).
<p />
Then of course you need to know which new weight you need to use.
For this there is the <code>names_mc_generator_weights</code> in the <code>sumWeights</code> tree; this vector of strings will give you the names of these weights.
However, when running on older samples where this info wasn't stored in the meta-data, you would just get a <code>?</code>.
In that case you need to run an external tool, such as the <code>check_MetaSG.py</code> script (but you probably won't need it for MC16 samples).
<p />
<p />
Major updates: <br /> -- <a class="twikiLink" href="/twiki/bin/view/Main/TimotheeTheveneauxPelzer">TimotheeTheveneauxPelzer</a> - 2017-04-28
<p />
</sticky> </div><!-- /patternTopic-->
<div class="twikiContentFooter"></div></div><!-- /patternContent-->
<div class="clear"></div>
<a name="topic-actions"></a><div class="patternTopicActions"><div class="patternTopicAction"><span class="patternActionButtons"><span style=''><span><a href='https://twiki.cern.ch/twiki/bin/edit/AtlasProtected/TopRun2WorkshopTutorial2017?t=1763376495;nowysiwyg=1' rel='nofollow' title='Edit this topic text' accesskey='e'><img src='/twiki/pub/TWiki/TWikiDocGraphics/uweb-o14.gif' width='14' height='14' border='0' alt='' /> <span class='twikiAccessKey'>E</span>dit</a></span><span class='twikiSeparator'>&nbsp;|&nbsp;</span></span><span style=''><span><a href='/twiki/bin/attach/AtlasProtected/TopRun2WorkshopTutorial2017' rel='nofollow' title='Attach an image or document to this topic' accesskey='a'><span class='twikiAccessKey'>A</span>ttach</a></span><span class='twikiSeparator'>&nbsp;|&nbsp;</span></span><span><a href='/twiki/bin/view/AtlasProtected/TopRun2WorkshopTutorial2017?cover=print' rel='nofollow' title='Printable version of this topic' accesskey='p'><span class='twikiAccessKey'>P</span>rint version</a></span><span class='twikiSeparator'>&nbsp;|&nbsp;</span><span><span><a href='/twiki/bin/oops/AtlasProtected/TopRun2WorkshopTutorial2017?template=oopshistory' rel='nofollow' title='View total topic history' accesskey='h'><span class='twikiAccessKey'>H</span>istory</a></span>: r29&nbsp;<a href="/twiki/bin/rdiff/AtlasProtected/TopRun2WorkshopTutorial2017?rev1=29;rev2=28" rel="nofollow">&lt;</a>&nbsp;<a href="/twiki/bin/view/AtlasProtected/TopRun2WorkshopTutorial2017?rev=28" rel="nofollow">r28</a>&nbsp;<a href="/twiki/bin/rdiff/AtlasProtected/TopRun2WorkshopTutorial2017?rev1=28;rev2=27" rel="nofollow">&lt;</a>&nbsp;<a href="/twiki/bin/view/AtlasProtected/TopRun2WorkshopTutorial2017?rev=27" rel="nofollow">r27</a>&nbsp;<a href="/twiki/bin/rdiff/AtlasProtected/TopRun2WorkshopTutorial2017?rev1=27;rev2=26" rel="nofollow">&lt;</a>&nbsp;<a href="/twiki/bin/view/AtlasProtected/TopRun2WorkshopTutorial2017?rev=26" rel="nofollow">r26</a>&nbsp;<a href="/twiki/bin/rdiff/AtlasProtected/TopRun2WorkshopTutorial2017?rev1=26;rev2=25" rel="nofollow">&lt;</a>&nbsp;<a href="/twiki/bin/view/AtlasProtected/TopRun2WorkshopTutorial2017?rev=25" rel="nofollow">r25</a></span><span class='twikiSeparator'>&nbsp;|&nbsp;</span><span><a href='/twiki/bin/oops/AtlasProtected/TopRun2WorkshopTutorial2017?template=backlinksweb' rel='nofollow' title='Search the AtlasProtected Web for topics that link to here' accesskey='b'><span class='twikiAccessKey'>B</span>acklinks</a></span><span class='twikiSeparator'>&nbsp;|&nbsp;</span><span><a href='/twiki/bin/view/AtlasProtected/TopRun2WorkshopTutorial2017?raw=on' rel='nofollow' title='View raw text without formatting' accesskey='r'><span class='twikiAccessKey'>R</span>aw View</a></span><span class='twikiSeparator'>&nbsp;|&nbsp;</span><span style=''><span><a href='https://twiki.cern.ch/twiki/bin/edit/AtlasProtected/TopRun2WorkshopTutorial2017?t=1763376495;nowysiwyg=0' rel='nofollow' title='WYSIWYG editor' accesskey='w'>WYSIWYG</a></span><span class='twikiSeparator'>&nbsp;|&nbsp;</span></span><span><a href='/twiki/bin/oops/AtlasProtected/TopRun2WorkshopTutorial2017?template=oopsmore&amp;param1=29&amp;param2=29' rel='nofollow' title='Delete or rename this topic; set parent topic; view and compare revisions' accesskey='m'><span class='twikiAccessKey'>M</span>ore topic actions</a></span></span></div><!--/patternTopicAction--></div><!--/patternTopicActions-->
<div class="patternInfo twikiGrayText"><div class="patternRevInfo">Topic revision: r29 - 2018-05-22 <a href="https://twiki.cern.ch/twiki/bin/edit/AtlasProtected/TopRun2WorkshopTutorial2017?t=1763376495;nowysiwyg=1" target="_top">-</a> <a class="twikiLink" href="/twiki/bin/view/Main/TimotheeTheveneauxPelzer">TimotheeTheveneauxPelzer</a></div><!-- /patternRevInfo--></div><!-- /patternInfo-->
</div><!-- /patternMainContents-->
</div><!-- /patternMain--><div id="patternLeftBar"><div id="patternClearHeaderLeft"></div>
<div id="patternLeftBarContents"><div class="patternLoginActions"><span style="padding: 0 0 0 20px; word-wrap:break-word; display:block;"><img src="https://twiki.cern.ch/twiki/pub/TWiki/TWikiDocGraphics/person.gif" style="position:absolute; margin: 0 0 0 -20px;" /> <span class="twikiNewLink"><a href="/twiki/bin/edit/Main/RoySchimmelBrener?topicparent=AtlasProtected.TopRun2WorkshopTutorial2017;nowysiwyg=1"    rel="nofollow" title="this topic does not yet exist; you can create it.">RoySchimmelBrener</a></span></span>  <img src="/twiki/pub/TWiki/TWikiDocGraphics/lock.gif" width="16" height="16" alt="Lock" title="Lock" border="0" /> <a href="https://twiki.cern.ch/twiki/bin/view/AtlasProtected/TopRun2WorkshopTutorial2017?logout=1">Log Out</a></div><div class="patternWebIndicator"> <ul>
<li> <a class="twikiCurrentWebHomeLink twikiLink" href="/twiki/bin/view/AtlasProtected/WebHome"><img src="/twiki/pub/TWiki/TWikiDocGraphics/web-bg-small.gif" width="13" height="13" alt="Web background" title="Web background" border="0" /> AtlasProtected</a>
</li></ul> 
</div> <ul>
<li> <strong><a href="https://atlas-collaboration.web.cern.ch" target="_blank"><span style="color: blue">ATLAS Collaboration</span><img alt="" border="0" height="12" src="/twiki/pub/TWiki/TWikiDocGraphics/external-link.gif" width="13" /></a></strong>
</li></ul> 
<hr /> <ul>
<li> <strong><a class="twikiLink" href="/twiki/bin/view/Atlas/WebHome"><span style="color: #0000ff"> ATLAS TWiki</span></verbatim></a></strong>
</li> <li> <strong><a class="twikiCurrentWebHomeLink twikiLink" href="/twiki/bin/view/AtlasProtected/WebHome"><span style="color: #0000ff"> ATLAS Protected</span></verbatim></a></strong>
</li> <li> <strong><a class="twikiLink" href="/twiki/bin/view/AtlasComputing/WebHome"><span style="color: #0000ff"> ATLAS Computing </span></verbatim></a></strong>
</li> <li> <strong><a class="twikiLink" href="/twiki/bin/view/AtlasPublic/WebHome"><span style="color: #0000ff"> Public Results </span></verbatim></a></strong>
</li></ul> 
<hr /> <ul>
<li> <strong><a href="https://its.cern.ch/jira/secure/CreateIssueDetails!init.jspa?pid=22679&amp;issuetype=3&amp;summary=Problem+with+TopRun2WorkshopTutorial2017+TWiki+topic&amp;description=The+topic+https://twiki.cern.ch/twiki/bin/viewauth/AtlasProtected/TopRun2WorkshopTutorial2017+has+an+issue.+Describe+it+below:&amp;reporter=rbrener" target="_blank"><span style="color: #ff0000"> Report outdated page </span></verbatim><img alt="" border="0" height="12" src="/twiki/pub/TWiki/TWikiDocGraphics/external-link.gif" width="13" /></a></strong>
</li> <li> <strong><a href="mailto&#58;atlas&#45;twiki&#45;support&#64;cern&#46;ch"><span style="color: #ff0000"> Twiki-Support </span></verbatim></a></strong>
</li></ul> 
<hr />
<p /> <ul>
 <li>
 <ul>
<li> <strong><a href="https://twiki.cern.ch/twiki/bin/view/AtlasPublic" target="_top"><span style="color: navy;"> Public Results </span></a></strong>
</li> <li> <strong><a class="twikiLink" href="/twiki/bin/view/AtlasProtected/AtlasPhysics"><span style="color: navy;"> Physics </span></a></strong>
</li> <li> <strong><a class="twikiLink" href="/twiki/bin/view/Atlas/AtlasDetectors"><span style="color: navy;"> Detectors </span></a></strong>
</li> <li> <strong><a class="twikiLink" href="/twiki/bin/view/Atlas/AtlasTrigger"><span style="color: navy;"> Trigger </span></a></strong>
</li> <li> <strong><a class="twikiLink" href="/twiki/bin/view/AtlasComputing/WebHome"><span style="color: navy;"> Computing </span></a></strong>
</li> <li> <strong><a class="twikiLink" href="/twiki/bin/view/Atlas/DataPreparation"><span style="color: navy;"> Data Preparation </span></a></strong>
</li> <li> <a class="twikiLink" href="/twiki/bin/view/Atlas/DocumentationManagement">Documentation Help</a>
</li> <li> <a class="twikiLink" href="/twiki/bin/view/Atlas/AtlasGlossary">Glossary</a>
</li></ul> 
</li></ul> 
<p />
<div class="twikiLeftBarBase">
  <a href="/twiki/bin/edit/AtlasProtected/TopRun2WorkshopTutorial2017LeftBar?templatetopic=AtlasProtected.WebLeftBarTemplate">Create</a> a LeftBar for this page
</div>
<p />
<hr />
<span style="color: #008000"> <img src='https://twiki.cern.ch/twiki/pub/TWiki/TWikiDocGraphics/searchtopic.gif'> <strong><a href="https://search.cern.ch/Pages/TwikiResults.aspx?k=generic2%3AATLAS" target="_blank">TWiki Search<img alt="" border="0" height="12" src="/twiki/pub/TWiki/TWikiDocGraphics/external-link.gif" width="13" /></a></strong> </span></verbatim>
<hr />
<p />
<!-- <ul>
 <li>
 <ul>
<li> <a class="twikiCurrentWebHomeLink twikiLink" href="/twiki/bin/view/AtlasProtected/WebHome">AtlasProtected Wiki</a>
</li></ul> 
</li></ul> 
-->
</div><!-- /patternLeftBarContents--></div><!-- /patternLeftBar-->
</div><!-- /patternFloatWrap-->
<div class="clear">&nbsp;</div>
</div><!-- /patternOuter--></div><!-- /patternWrapper--><div id="patternTopBar"><div id="patternTopBarContents"><table border="0" cellpadding="0" cellspacing="0" style="width:100%; margin-top:12px;">
<tr><td valign="middle"><span id="twikiLogo" class="twikiImage"><a href="https://twiki.cern.ch/twiki/bin/view/AtlasProtected/WebHome"><img src="/twiki/pub/AtlasPublic/AtlasTWikiLogos/AtlasTwikiProtectedLogo.png" border="0" alt="CERN" style="border:none;" /></a></span></td>
<td align="right" valign="top" class="patternMetaMenu">
 <ul>
<li> <form name="jumpForm" action="/twiki/bin/view/AtlasProtected/TopRun2WorkshopTutorial2017"><input id="jumpFormField" type="text" class="twikiInputField" name="topic" value="" size="18" /><noscript>&nbsp;<input type="submit" class="twikiButton" size="5" name="submit" value="Jump" />&nbsp;</noscript>   </form>
</li> <li> <form name="quickSearchForm" action="https://search.cern.ch/Pages/TwikiResults.aspx" target="search" class="cernTWikiSearch">    <ul class="engineList" style="background-image: url('https://twiki.cern.ch/twiki/pub/TWiki/CernSearchBar/arrow.png');">        <li class="active" id="twikisearch">            <img src="https://twiki.cern.ch/twiki/pub/TWiki/CernSearchBar/twikisearchicon.gif" alt="TWiki Search Icon" />            <span class="engineDescription">TWiki Search</span>        </li>        <!-- Due to a security incident <a href="https://cern.service-now.com/service-portal?id=outage&amp;n=OTG0156848" target="_blank">OTG0156848<img alt="" border="0" height="12" src="/twiki/pub/TWiki/TWikiDocGraphics/external-link.gif" width="13" /></a>, the legacy CERN Search Service has been shut down        <li id="cernsearch">            <img src="https://twiki.cern.ch/twiki/pub/TWiki/CernSearchBar/cernsearchicon.png" alt="Cern Search Icon" />            <span class="engineDescription">Cern Search</span>        </li>         -->        <li id="googlesearch">            <img class="engine" src="https://twiki.cern.ch/twiki/pub/TWiki/CernSearchBar/googlesearchicon.png" alt="Google Search Icon" />            <span class="engineDescription">Google Search</span>        </li>    </ul>    <input type="text" class="twikiInputField" id="quickSearchBox" name="k" value="" size="18" /> <br />    <input type="radio" name="scope" value=Atlas checked />     <span class="webScopeDescription">Atlas</span>    <input type="radio" name="scope" value="AllWebs" />    <span class="allWebsScopeDescription">All webs</span>    <input type='hidden' name='autologin' value='1'/>     <noscript>        &nbsp; <input type="submit" size="5" class="twikiButton" name="submit" value="Search"/>&nbsp;    </noscript>
</li></ul> 
</form>
<p />
<p />
<!-- <pre> -->
<script language="javascript">
<!--
$(function() {
    // We use the current web name to form the redirect in the TWiki search
    var currentWeb = undefined;
    // If the web starts with alice* atlas* cms* or lhcb* (case-insensitive),
    // the "Web search" should be altered so that AtlasFoo => Atlas
    var specialWeb = undefined;
    // Remembering what the user have entered into the searchbox to after
    // he has selected a new search engine from the dropdown
    var searchPhrase = '';

    // --- BEGIN: CONFIGURABLE LIST FOR SUBWEB SEARCH ---
    // List of webs for which sub-web searching should be enabled
    var subWebSearchWebs = ['AtlasProtected', 'AtlasComputing', 'Atlas'];
    // --- END: CONFIGURABLE LIST FOR SUBWEB SEARCH ---

    // --- ORIGINAL WEB DETECTION LOGIC ---
    // We want to store the current web for later use.
    var currentWebSearch = window.location.pathname.match(/\/([A-Z][^\/]+)/);
    if (currentWebSearch != null) {
        currentWeb = currentWebSearch[1];

        // Do we have a special kind of web? If so, the web search should be altered a little to fetch more broader results.
        var specialWebSearch = currentWeb.match(/^(alice|atlas|cms|lhcb)/i);
        if (specialWebSearch != null) {
            var lowercaseToCorrect = {
                'alice' : 'Alice',
                'atlas' : 'Atlas',
                'cms'   : 'CMS',
                'lhcb'  : 'LHCb'
            };
            specialWeb = lowercaseToCorrect[specialWebSearch[1].toLowerCase()];
            $('span.webScopeDescription').text(specialWeb);
        }
    } else {
        currentWeb = 'DefaultWeb';
    }

    // --- BEGIN: SUBWEB LOGIC TO EXTRACT SUBWEB PATH (EXCLUDING TOPIC) ---
    var subWebSearchWebs = ['AtlasProtected', 'AtlasComputing', 'Atlas'];
    // Build regex to match web/subweb path and topic
    var subWebsPattern = new RegExp(
        '/((' + subWebSearchWebs.join('|') + ')(?=(?:/|$))(?:/[A-Za-z0-9_]+)*)/([A-Za-z0-9_]+)$'
    );
    var subWebMatch = window.location.pathname.match(subWebsPattern);
    if (subWebMatch) {
        // subWebMatch[1] is the full web/subweb path (e.g. "AtlasComputing/AtlasComputingArchive")
        // subWebMatch[3] is the topic (e.g. "WebHome")
        currentWeb = subWebMatch[1];
        specialWeb = currentWeb;
        $('span.webScopeDescription').text(specialWeb);
    }
    // --- END: SUBWEB LOGIC TO EXTRACT SUBWEB PATH (EXCLUDING TOPIC) ---

    // Do we have a favourite search engine in localStorage? We set Twiki search as default anyways
    if (window.localStorage) {
        // var storedEngine = localStorage.getItem('defaultSearchEngine');
        // console.log('stored engine preference: ' + storedEngine);
        var storedEngine = 'twikisearch';
        var storedEngineLi = $('.cernTWikiSearch li#' + storedEngine);
        if (!storedEngineLi.hasClass('active')) {
            changeActiveSearchEngine(storedEngineLi);
        }
        if (storedEngine == 'twikisearch') {
            $('input[name=scope][value=AllWebs]').attr('disabled','disabled');
            $('.allWebsScopeDescription').addClass('disabled');
        }
    }
    
    // Toggle the searchEngines list on and off on click
    $('.cernTWikiSearch ul.engineList').click(function(e) {
        e.stopPropagation();
        if ($(this).hasClass('open')) {
            $(this).removeClass('open');
        } else {
            $(this).addClass('open');
        }
    });

    // Stupid IE8 hack because the click handler on ul.engineList does not work properly there.
    if ($.browser.msie && document.documentMode && document.documentMode < 9) {
        $('.cernTWikiSearch #quickSearchBox').focus(function(e) {
            $('.cernTWikiSearch ul.engineList').removeClass('open');
        });
    }
    
    // Handle clicks on one of the search engines
    $('.cernTWikiSearch ul.engineList li').click(function(e) {
        // If we clicked on a <li> that does not has class 'active', it means this should become active and swap places with this.
        if (!$(this).hasClass('active')) {
            changeActiveSearchEngine($(this));
        }  
        if ($(this).parent().hasClass('open')) {
            $('.cernTWikiSearch #quickSearchBox').val(searchPhrase);
            $('.cernTWikiSearch #quickSearchBox').focus();                          
        }
        if ($(this).attr('id') == 'twikisearch') {
            var allWebsRadio = $('input[name=scope][value=AllWebs]');
            allWebsRadio.attr('disabled','disabled');
            allWebsRadio.siblings('input[type=radio]').attr('checked',true)
            $('.allWebsScopeDescription').addClass('disabled');
        } else {
            $('input[name=scope][value=AllWebs]').attr('disabled','');
            $('.allWebsScopeDescription').removeClass('disabled');
        }
    });
    
    // Show the engine description text on hover
    $('.engineList.open li').live('hover',function() {
        var displayText = $(this).find('span.engineDescription').text();
        $('.cernTWikiSearch #quickSearchBox').val(displayText);
    });


    // The form is submitted, now let's do the search.
    $('.cernTWikiSearch').submit(function(e) {
        e.preventDefault();

        var scope = $('input[name=scope]:checked', $(this)).val();
        if (scope != 'AllWebs' && specialWeb !== undefined) {
            scope = specialWeb;
        }
        var val = $('.cernTWikiSearch #quickSearchBox').val();
        var engine = $('.engineList li.active').attr('id')
        
        switch (engine) {
            case 'googlesearch':
                window.open('https://google.com/search?q=site:' + encodeURIComponent('https://twiki.cern.ch') + (scope != 'AllWebs' ? ' ' + scope : '') + ' ' + val);
                break;
            case 'cernsearch':
                window.open('https://search.cern.ch/Pages/TwikiResults.aspx?k=' + val + (scope != 'AllWebs' ? ' cernscope:' + scope : '') + '&autologin=1');
                break;
            case 'twikisearch':
                window.open(window.location.pathname.replace(/\/[A-Z].+$/,'') + '/' + currentWeb + '/WebSearch?search=' + val + '&scope=all');
                break;
        default:
            break;
        }
        
        // Save the search engine. If the user reloads the page he should get the last one used.
        if (window.localStorage) { 
            console.log('store engine preference: ' + engine);
            localStorage.setItem('defaultSearchEngine',engine);
        }
    });
    
    // Save the search phrase on every key up
    $('.cernTWikiSearch #quickSearchBox').keyup(function() {
        searchPhrase = $(this).val();
    });
    
    // If a user clicks outside the search engine list, the search engine list should be closed.
    $('html').click(function() {
        if ($('.engineList').hasClass('open')) {
            $('.engineList').removeClass('open');
            $('.cernTWikiSearch #quickSearchBox').val(searchPhrase);
        }
    });
});

// We want to change the active search engine
function changeActiveSearchEngine(engineLi) {
    var activeEngine = engineLi.siblings(':first');
    engineLi.detach().insertBefore(activeEngine);
    activeEngine.removeClass('active');
    engineLi.addClass('active');
    if (engineLi.attr('id') == 'twikiSearch') {
        deactivateAllWebsOption();
    }
}

// The user has chosen twiki search (or the preference was stored in localStorage). 
// We will then disable the 'All Webs' option since this will time out.
function deactivateAllWebsOption() {
}

// Helper method to check input attribute browser compability
function checkInputAttributeSupport(attribute) {
    var i = document.createElement("input");
    return typeof i.placeholder !== 'undefined';
}
//-->
</script>
<!-- </pre> --> <ul>
<li> 
</li></ul> 
</td></tr></table></div></div><!-- /patternTopBar--><div id="patternBottomBar"><div id="patternBottomBarContents"><div id="patternWebBottomBar"><div class="twikiCopyright"><span class="twikiRight"> <a href="http://twiki.org/"><img src="/twiki/pub/TWiki/TWikiLogos/T-badge-88x31.gif" alt="This site is powered by the TWiki collaboration platform" width="88" height="31" title="This site is powered by the TWiki collaboration platform" border="0" /></a></span><span class="twikiRight" style="padding:0 10px 0 10px"> <a href="http://www.perl.org/"><img src="/twiki/pub/TWiki/TWikiLogos/perl-logo-88x31.gif" alt="Powered by Perl" width="88" height="31" title="Powered by Perl" border="0" /></a></span>Copyright &amp; 2008-2025 by the contributing authors. All material on this collaboration platform is the property of the contributing authors. <br />  or Ideas, requests, problems regarding TWiki? use <a href="https://discourse.web.cern.ch/c/collaborative-editing/wikis/12">Discourse</a> or <a href='https://twiki.cern.ch/twiki/bin/view/Main/ServiceNow'>Send feedback</a> </div><!--/twikiCopyright--></div><!--/patternWebBottomBar--></div><!-- /patternBottomBarContents--></div><!-- /patternBottomBar-->
</div><!-- /patternPage-->
</div><!-- /patternPageShadow-->
</div><!-- /patternScreen-->
<p />
<p />
<p />
<!-- Matomo -->
<script>
  var _paq = window._paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
	 var u="https://webanalytics.web.cern.ch/";
	 _paq.push(['setTrackerUrl', u+'matomo.php']);
	 _paq.push(['setSiteId', '5']);
	 var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
	 g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Matomo Code -->
<p />
</body></html>